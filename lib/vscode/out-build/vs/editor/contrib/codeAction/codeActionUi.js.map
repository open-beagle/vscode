{"version":3,"file":"codeActionUi.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/editor/contrib/codeAction/codeActionUi.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IAnchor } from 'vs/base/browser/ui/contextview/contextview';\nimport { onUnexpectedError } from 'vs/base/common/errors';\nimport { Lazy } from 'vs/base/common/lazy';\nimport { Disposable, MutableDisposable } from 'vs/base/common/lifecycle';\nimport { ICodeEditor } from 'vs/editor/browser/editorBrowser';\nimport { IPosition } from 'vs/editor/common/core/position';\nimport { CodeActionTriggerType } from 'vs/editor/common/modes';\nimport { CodeActionItem, CodeActionSet } from 'vs/editor/contrib/codeAction/codeAction';\nimport { MessageController } from 'vs/editor/contrib/message/messageController';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { CodeActionMenu, CodeActionShowOptions } from './codeActionMenu';\nimport { CodeActionsState } from './codeActionModel';\nimport { LightBulbWidget } from './lightBulbWidget';\nimport { CodeActionAutoApply, CodeActionTrigger } from './types';\n\nexport class CodeActionUi extends Disposable {\n\n\tprivate readonly _codeActionWidget: Lazy<CodeActionMenu>;\n\tprivate readonly _lightBulbWidget: Lazy<LightBulbWidget>;\n\tprivate readonly _activeCodeActions = this._register(new MutableDisposable<CodeActionSet>());\n\n\t#disposed = false;\n\n\tconstructor(\n\t\tprivate readonly _editor: ICodeEditor,\n\t\tquickFixActionId: string,\n\t\tpreferredFixActionId: string,\n\t\tprivate readonly delegate: {\n\t\t\tapplyCodeAction: (action: CodeActionItem, regtriggerAfterApply: boolean) => Promise<void>\n\t\t},\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._codeActionWidget = new Lazy(() => {\n\t\t\treturn this._register(instantiationService.createInstance(CodeActionMenu, this._editor, {\n\t\t\t\tonSelectCodeAction: async (action) => {\n\t\t\t\t\tthis.delegate.applyCodeAction(action, /* retrigger */ true);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\n\t\tthis._lightBulbWidget = new Lazy(() => {\n\t\t\tconst widget = this._register(instantiationService.createInstance(LightBulbWidget, this._editor, quickFixActionId, preferredFixActionId));\n\t\t\tthis._register(widget.onClick(e => this.showCodeActionList(e.trigger, e.actions, e, { includeDisabledActions: false })));\n\t\t\treturn widget;\n\t\t});\n\t}\n\n\toverride dispose() {\n\t\tthis.#disposed = true;\n\t\tsuper.dispose();\n\t}\n\n\tpublic async update(newState: CodeActionsState.State): Promise<void> {\n\t\tif (newState.type !== CodeActionsState.Type.Triggered) {\n\t\t\tthis._lightBulbWidget.rawValue?.hide();\n\t\t\treturn;\n\t\t}\n\n\t\tlet actions: CodeActionSet;\n\t\ttry {\n\t\t\tactions = await newState.actions;\n\t\t} catch (e) {\n\t\t\tonUnexpectedError(e);\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#disposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._lightBulbWidget.getValue().update(actions, newState.trigger, newState.position);\n\n\t\tif (newState.trigger.type === CodeActionTriggerType.Invoke) {\n\t\t\tif (newState.trigger.filter?.include) { // Triggered for specific scope\n\t\t\t\t// Check to see if we want to auto apply.\n\n\t\t\t\tconst validActionToApply = this.tryGetValidActionToApply(newState.trigger, actions);\n\t\t\t\tif (validActionToApply) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.delegate.applyCodeAction(validActionToApply, false);\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tactions.dispose();\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Check to see if there is an action that we would have applied were it not invalid\n\t\t\t\tif (newState.trigger.context) {\n\t\t\t\t\tconst invalidAction = this.getInvalidActionThatWouldHaveBeenApplied(newState.trigger, actions);\n\t\t\t\t\tif (invalidAction && invalidAction.action.disabled) {\n\t\t\t\t\t\tMessageController.get(this._editor).showMessage(invalidAction.action.disabled, newState.trigger.context.position);\n\t\t\t\t\t\tactions.dispose();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst includeDisabledActions = !!newState.trigger.filter?.include;\n\t\t\tif (newState.trigger.context) {\n\t\t\t\tif (!actions.allActions.length || !includeDisabledActions && !actions.validActions.length) {\n\t\t\t\t\tMessageController.get(this._editor).showMessage(newState.trigger.context.notAvailableMessage, newState.trigger.context.position);\n\t\t\t\t\tthis._activeCodeActions.value = actions;\n\t\t\t\t\tactions.dispose();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._activeCodeActions.value = actions;\n\t\t\tthis._codeActionWidget.getValue().show(newState.trigger, actions, newState.position, { includeDisabledActions });\n\t\t} else {\n\t\t\t// auto magically triggered\n\t\t\tif (this._codeActionWidget.getValue().isVisible) {\n\t\t\t\t// TODO: Figure out if we should update the showing menu?\n\t\t\t\tactions.dispose();\n\t\t\t} else {\n\t\t\t\tthis._activeCodeActions.value = actions;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate getInvalidActionThatWouldHaveBeenApplied(trigger: CodeActionTrigger, actions: CodeActionSet): CodeActionItem | undefined {\n\t\tif (!actions.allActions.length) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif ((trigger.autoApply === CodeActionAutoApply.First && actions.validActions.length === 0)\n\t\t\t|| (trigger.autoApply === CodeActionAutoApply.IfSingle && actions.allActions.length === 1)\n\t\t) {\n\t\t\treturn actions.allActions.find(({ action }) => action.disabled);\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate tryGetValidActionToApply(trigger: CodeActionTrigger, actions: CodeActionSet): CodeActionItem | undefined {\n\t\tif (!actions.validActions.length) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif ((trigger.autoApply === CodeActionAutoApply.First && actions.validActions.length > 0)\n\t\t\t|| (trigger.autoApply === CodeActionAutoApply.IfSingle && actions.validActions.length === 1)\n\t\t) {\n\t\t\treturn actions.validActions[0];\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tpublic async showCodeActionList(trigger: CodeActionTrigger, actions: CodeActionSet, at: IAnchor | IPosition, options: CodeActionShowOptions): Promise<void> {\n\t\tthis._codeActionWidget.getValue().show(trigger, actions, at, options);\n\t}\n}\n"]}