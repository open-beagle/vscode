{"version":3,"file":"hoverOperation.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/editor/contrib/hover/hoverOperation.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancelablePromise, RunOnceScheduler, createCancelablePromise } from 'vs/base/common/async';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { onUnexpectedError } from 'vs/base/common/errors';\n\nexport interface IHoverComputer<Result> {\n\n\t/**\n\t * This is called after half the hover time\n\t */\n\tcomputeAsync?: (token: CancellationToken) => Promise<Result>;\n\n\t/**\n\t * This is called after all the hover time\n\t */\n\tcomputeSync?: () => Result;\n\n\t/**\n\t * This is called whenever one of the compute* methods returns a truey value\n\t */\n\tonResult: (result: Result, isFromSynchronousComputation: boolean) => void;\n\n\t/**\n\t * This is what will be sent as progress/complete to the computation promise\n\t */\n\tgetResult: () => Result;\n\n\tgetResultWithLoadingMessage: () => Result;\n\n}\n\nconst enum ComputeHoverOperationState {\n\tIDLE = 0,\n\tFIRST_WAIT = 1,\n\tSECOND_WAIT = 2,\n\tWAITING_FOR_ASYNC_COMPUTATION = 3\n}\n\nexport const enum HoverStartMode {\n\tDelayed = 0,\n\tImmediate = 1\n}\n\nexport class HoverOperation<Result> {\n\n\tprivate readonly _computer: IHoverComputer<Result>;\n\tprivate _state: ComputeHoverOperationState;\n\tprivate _hoverTime: number;\n\n\tprivate readonly _firstWaitScheduler: RunOnceScheduler;\n\tprivate readonly _secondWaitScheduler: RunOnceScheduler;\n\tprivate readonly _loadingMessageScheduler: RunOnceScheduler;\n\tprivate _asyncComputationPromise: CancelablePromise<Result> | null;\n\tprivate _asyncComputationPromiseDone: boolean;\n\n\tprivate readonly _completeCallback: (r: Result) => void;\n\tprivate readonly _errorCallback: ((err: any) => void) | null | undefined;\n\tprivate readonly _progressCallback: (progress: any) => void;\n\n\tconstructor(computer: IHoverComputer<Result>, success: (r: Result) => void, error: ((err: any) => void) | null | undefined, progress: (progress: any) => void, hoverTime: number) {\n\t\tthis._computer = computer;\n\t\tthis._state = ComputeHoverOperationState.IDLE;\n\t\tthis._hoverTime = hoverTime;\n\n\t\tthis._firstWaitScheduler = new RunOnceScheduler(() => this._triggerAsyncComputation(), 0);\n\t\tthis._secondWaitScheduler = new RunOnceScheduler(() => this._triggerSyncComputation(), 0);\n\t\tthis._loadingMessageScheduler = new RunOnceScheduler(() => this._showLoadingMessage(), 0);\n\n\t\tthis._asyncComputationPromise = null;\n\t\tthis._asyncComputationPromiseDone = false;\n\n\t\tthis._completeCallback = success;\n\t\tthis._errorCallback = error;\n\t\tthis._progressCallback = progress;\n\t}\n\n\tpublic setHoverTime(hoverTime: number): void {\n\t\tthis._hoverTime = hoverTime;\n\t}\n\n\tprivate _firstWaitTime(): number {\n\t\treturn this._hoverTime / 2;\n\t}\n\n\tprivate _secondWaitTime(): number {\n\t\treturn this._hoverTime / 2;\n\t}\n\n\tprivate _loadingMessageTime(): number {\n\t\treturn 3 * this._hoverTime;\n\t}\n\n\tprivate _triggerAsyncComputation(): void {\n\t\tthis._state = ComputeHoverOperationState.SECOND_WAIT;\n\t\tthis._secondWaitScheduler.schedule(this._secondWaitTime());\n\n\t\tif (this._computer.computeAsync) {\n\t\t\tthis._asyncComputationPromiseDone = false;\n\t\t\tthis._asyncComputationPromise = createCancelablePromise(token => this._computer.computeAsync!(token));\n\t\t\tthis._asyncComputationPromise.then((asyncResult: Result) => {\n\t\t\t\tthis._asyncComputationPromiseDone = true;\n\t\t\t\tthis._withAsyncResult(asyncResult);\n\t\t\t}, (e) => this._onError(e));\n\n\t\t} else {\n\t\t\tthis._asyncComputationPromiseDone = true;\n\t\t}\n\t}\n\n\tprivate _triggerSyncComputation(): void {\n\t\tif (this._computer.computeSync) {\n\t\t\tthis._computer.onResult(this._computer.computeSync(), true);\n\t\t}\n\n\t\tif (this._asyncComputationPromiseDone) {\n\t\t\tthis._state = ComputeHoverOperationState.IDLE;\n\t\t\tthis._onComplete(this._computer.getResult());\n\t\t} else {\n\t\t\tthis._state = ComputeHoverOperationState.WAITING_FOR_ASYNC_COMPUTATION;\n\t\t\tthis._onProgress(this._computer.getResult());\n\t\t}\n\t}\n\n\tprivate _showLoadingMessage(): void {\n\t\tif (this._state === ComputeHoverOperationState.WAITING_FOR_ASYNC_COMPUTATION) {\n\t\t\tthis._onProgress(this._computer.getResultWithLoadingMessage());\n\t\t}\n\t}\n\n\tprivate _withAsyncResult(asyncResult: Result): void {\n\t\tif (asyncResult) {\n\t\t\tthis._computer.onResult(asyncResult, false);\n\t\t}\n\n\t\tif (this._state === ComputeHoverOperationState.WAITING_FOR_ASYNC_COMPUTATION) {\n\t\t\tthis._state = ComputeHoverOperationState.IDLE;\n\t\t\tthis._onComplete(this._computer.getResult());\n\t\t}\n\t}\n\n\tprivate _onComplete(value: Result): void {\n\t\tthis._completeCallback(value);\n\t}\n\n\tprivate _onError(error: any): void {\n\t\tif (this._errorCallback) {\n\t\t\tthis._errorCallback(error);\n\t\t} else {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n\n\tprivate _onProgress(value: Result): void {\n\t\tthis._progressCallback(value);\n\t}\n\n\tpublic start(mode: HoverStartMode): void {\n\t\tif (mode === HoverStartMode.Delayed) {\n\t\t\tif (this._state === ComputeHoverOperationState.IDLE) {\n\t\t\t\tthis._state = ComputeHoverOperationState.FIRST_WAIT;\n\t\t\t\tthis._firstWaitScheduler.schedule(this._firstWaitTime());\n\t\t\t\tthis._loadingMessageScheduler.schedule(this._loadingMessageTime());\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (this._state) {\n\t\t\t\tcase ComputeHoverOperationState.IDLE:\n\t\t\t\t\tthis._triggerAsyncComputation();\n\t\t\t\t\tthis._secondWaitScheduler.cancel();\n\t\t\t\t\tthis._triggerSyncComputation();\n\t\t\t\t\tbreak;\n\t\t\t\tcase ComputeHoverOperationState.SECOND_WAIT:\n\t\t\t\t\tthis._secondWaitScheduler.cancel();\n\t\t\t\t\tthis._triggerSyncComputation();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic cancel(): void {\n\t\tthis._loadingMessageScheduler.cancel();\n\t\tif (this._state === ComputeHoverOperationState.FIRST_WAIT) {\n\t\t\tthis._firstWaitScheduler.cancel();\n\t\t}\n\t\tif (this._state === ComputeHoverOperationState.SECOND_WAIT) {\n\t\t\tthis._secondWaitScheduler.cancel();\n\t\t\tif (this._asyncComputationPromise) {\n\t\t\t\tthis._asyncComputationPromise.cancel();\n\t\t\t\tthis._asyncComputationPromise = null;\n\t\t\t}\n\t\t}\n\t\tif (this._state === ComputeHoverOperationState.WAITING_FOR_ASYNC_COMPUTATION) {\n\t\t\tif (this._asyncComputationPromise) {\n\t\t\t\tthis._asyncComputationPromise.cancel();\n\t\t\t\tthis._asyncComputationPromise = null;\n\t\t\t}\n\t\t}\n\t\tthis._state = ComputeHoverOperationState.IDLE;\n\t}\n\n}\n"]}