{"version":3,"file":"modelServiceImpl.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/editor/common/services/modelServiceImpl.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;;;;;IAkChG,SAAS,QAAQ,CAAC,QAAa;QAC9B,OAAO,QAAQ,CAAC,QAAQ,EAAE,CAAC;IAC5B,CAAC;IAED,SAAS,gBAAgB,CAAC,KAAiB;QAC1C,mBAAmB;QACnB,MAAM,WAAW,GAAG,IAAI,iBAAU,EAAE,CAAC;QACrC,MAAM,QAAQ,GAAG,KAAK,CAAC,cAAc,EAAE,CAAC;QACxC,IAAI,IAAmB,CAAC;QACxB,OAAO,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,EAAE,CAAC,EAAE;YAChC,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;SACzB;QACD,OAAO,WAAW,CAAC,MAAM,EAAE,CAAC;IAC7B,CAAC;IAGD,MAAM,SAAS;QAQd,YACC,KAAgB,EAChB,aAA0C,EAC1C,mBAA+E;YAL/D,yBAAoB,GAAG,IAAI,2BAAe,EAAE,CAAC;YAO7D,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;YAEnB,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;YAC/B,IAAI,CAAC,0BAA0B,GAAG,IAAI,CAAC;YAEvC,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,KAAK,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YAC/E,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,KAAK,CAAC,mBAAmB,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,mBAAmB,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;QAChG,CAAC;QAEO,yBAAyB;YAChC,IAAI,IAAI,CAAC,0BAA0B,EAAE;gBACpC,IAAI,CAAC,0BAA0B,CAAC,OAAO,EAAE,CAAC;gBAC1C,IAAI,CAAC,0BAA0B,GAAG,IAAI,CAAC;aACvC;QACF,CAAC;QAEM,OAAO;YACb,IAAI,CAAC,oBAAoB,CAAC,OAAO,EAAE,CAAC;YACpC,IAAI,CAAC,yBAAyB,EAAE,CAAC;QAClC,CAAC;QAEM,WAAW,CAAC,iBAAqC;YACvD,IAAI,CAAC,yBAAyB,EAAE,CAAC;YACjC,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;YAC5C,IAAI,CAAC,0BAA0B,GAAG,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC,CAAC;YACtI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC;QAC1D,CAAC;KACD;IAiBD,MAAM,WAAW,GAAG,CAAC,QAAQ,CAAC,OAAO,IAAI,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,YAAqB,CAAC,aAAsB,CAAC;IAO7G,MAAM,iBAAiB;QACtB,YACiB,GAAQ,EACR,uBAAyD,EACzD,IAAY,EACZ,mBAA4B,EAC5B,QAAgB,EAChB,IAAY,EACZ,SAAiB,EACjB,oBAA4B;YAP5B,QAAG,GAAH,GAAG,CAAK;YACR,4BAAuB,GAAvB,uBAAuB,CAAkC;YACzD,SAAI,GAAJ,IAAI,CAAQ;YACZ,wBAAmB,GAAnB,mBAAmB,CAAS;YAC5B,aAAQ,GAAR,QAAQ,CAAQ;YAChB,SAAI,GAAJ,IAAI,CAAQ;YACZ,cAAS,GAAT,SAAS,CAAQ;YACjB,yBAAoB,GAApB,oBAAoB,CAAQ;QACzC,CAAC;KACL;IAED,SAAS,oCAAoC,CAAC,QAAa;QAC1D,OAAO,CACN,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,IAAI;eAC7B,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,YAAY;eACxC,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,QAAQ;eACpC,QAAQ,CAAC,MAAM,KAAK,SAAS,CAAC,YAAY;SAC7C,CAAC;IACH,CAAC;IAED,IAAa,gBAAgB,GAA7B,MAAa,gBAAiB,SAAQ,sBAAU;QAyB/C,YACyC,qBAA4C,EACnC,0BAA0D,EAC3E,aAA4B,EAC9B,WAAwB,EACnB,gBAAkC;YAErE,KAAK,EAAE,CAAC;YANgC,0BAAqB,GAArB,qBAAqB,CAAuB;YACnC,+BAA0B,GAA1B,0BAA0B,CAAgC;YAC3E,kBAAa,GAAb,aAAa,CAAe;YAC9B,gBAAW,GAAX,WAAW,CAAa;YACnB,qBAAgB,GAAhB,gBAAgB,CAAkB;YAxBrD,kBAAa,GAAwB,IAAI,CAAC,SAAS,CAAC,IAAI,eAAO,EAAc,CAAC,CAAC;YAChF,iBAAY,GAAsB,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC;YAE1D,oBAAe,GAAwB,IAAI,CAAC,SAAS,CAAC,IAAI,eAAO,EAAc,CAAC,CAAC;YAClF,mBAAc,GAAsB,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC;YAE9D,wBAAmB,GAAuD,IAAI,CAAC,SAAS,CAAC,IAAI,eAAO,EAA6C,CAAC,CAAC;YACpJ,uBAAkB,GAAqD,IAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC;YAoBrH,IAAI,CAAC,0CAA0C,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACtE,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC;YAClB,IAAI,CAAC,eAAe,GAAG,IAAI,GAAG,EAA6B,CAAC;YAC5D,IAAI,CAAC,uBAAuB,GAAG,CAAC,CAAC;YACjC,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,eAAe,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;YAElG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,qBAAqB,CAAC,wBAAwB,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,mBAAmB,EAAE,CAAC,CAAC,CAAC;YACtG,IAAI,CAAC,mBAAmB,EAAE,CAAC;YAE3B,IAAI,CAAC,SAAS,CAAC,IAAI,uBAAuB,CAAC,IAAI,EAAE,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC,qBAAqB,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC;QAC1H,CAAC;QAEO,MAAM,CAAC,iBAAiB,CAAC,MAAkB,EAAE,iBAA0B;YAC9E,IAAI,OAAO,GAAG,qCAAqB,CAAC,OAAO,CAAC;YAC5C,IAAI,MAAM,CAAC,MAAM,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,OAAO,KAAK,WAAW,EAAE;gBAClE,MAAM,aAAa,GAAG,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;gBAC1D,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,EAAE;oBAC1B,OAAO,GAAG,aAAa,CAAC;iBACxB;gBACD,IAAI,OAAO,GAAG,CAAC,EAAE;oBAChB,OAAO,GAAG,CAAC,CAAC;iBACZ;aACD;YAED,IAAI,UAAU,GAAG,OAAO,CAAC;YACzB,IAAI,MAAM,CAAC,MAAM,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,UAAU,KAAK,WAAW,IAAI,MAAM,CAAC,MAAM,CAAC,UAAU,KAAK,SAAS,EAAE;gBAC/G,MAAM,gBAAgB,GAAG,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;gBAChE,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAAE;oBAC7B,UAAU,GAAG,gBAAgB,CAAC;iBAC9B;gBACD,IAAI,UAAU,GAAG,CAAC,EAAE;oBACnB,UAAU,GAAG,CAAC,CAAC;iBACf;aACD;YAED,IAAI,YAAY,GAAG,qCAAqB,CAAC,YAAY,CAAC;YACtD,IAAI,MAAM,CAAC,MAAM,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,YAAY,KAAK,WAAW,EAAE;gBACvE,YAAY,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,YAAY,KAAK,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC;aACtG;YAED,IAAI,aAAa,GAAG,WAAW,CAAC;YAChC,MAAM,GAAG,GAAG,MAAM,CAAC,GAAG,CAAC;YACvB,IAAI,GAAG,KAAK,MAAM,EAAE;gBACnB,aAAa,eAAwB,CAAC;aACtC;iBAAM,IAAI,GAAG,KAAK,IAAI,EAAE;gBACxB,aAAa,aAAsB,CAAC;aACpC;YAED,IAAI,kBAAkB,GAAG,qCAAqB,CAAC,kBAAkB,CAAC;YAClE,IAAI,MAAM,CAAC,MAAM,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,kBAAkB,KAAK,WAAW,EAAE;gBAC7E,kBAAkB,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,kBAAkB,KAAK,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC,CAAC;aACxH;YAED,IAAI,iBAAiB,GAAG,qCAAqB,CAAC,iBAAiB,CAAC;YAChE,IAAI,MAAM,CAAC,MAAM,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,iBAAiB,KAAK,WAAW,EAAE;gBAC5E,iBAAiB,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,iBAAiB,KAAK,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC,CAAC;aACrH;YAED,IAAI,sBAAsB,GAAG,qCAAqB,CAAC,sBAAsB,CAAC;YAC1E,IAAI,MAAM,CAAC,MAAM,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,sBAAsB,KAAK,WAAW,EAAE;gBACjF,sBAAsB,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,sBAAsB,KAAK,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,sBAAsB,CAAC,CAAC,CAAC;aACpI;YAED,OAAO;gBACN,iBAAiB,EAAE,iBAAiB;gBACpC,OAAO,EAAE,OAAO;gBAChB,UAAU,EAAE,UAAU;gBACtB,YAAY,EAAE,YAAY;gBAC1B,iBAAiB,EAAE,iBAAiB;gBACpC,UAAU,EAAE,aAAa;gBACzB,kBAAkB,EAAE,kBAAkB;gBACtC,sBAAsB,EAAE,sBAAsB;aAC9C,CAAC;QACH,CAAC;QAEO,OAAO,CAAC,QAAyB,EAAE,QAAgB;YAC1D,IAAI,QAAQ,EAAE;gBACb,OAAO,IAAI,CAAC,0BAA0B,CAAC,MAAM,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;aAClE;YACD,MAAM,GAAG,GAAG,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAS,WAAW,EAAE,EAAE,kBAAkB,EAAE,QAAQ,EAAE,CAAC,CAAC;YACvG,IAAI,GAAG,IAAI,GAAG,KAAK,MAAM,EAAE;gBAC1B,OAAO,GAAG,CAAC;aACX;YACD,OAAO,QAAQ,CAAC,EAAE,kBAAmC,IAAI,QAAQ,CAAC,EAAE,sBAAuC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC;QAC7H,CAAC;QAEO,uBAAuB;YAC9B,MAAM,MAAM,GAAG,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAU,wBAAwB,CAAC,CAAC;YACtF,IAAI,OAAO,MAAM,KAAK,SAAS,EAAE;gBAChC,OAAO,MAAM,CAAC;aACd;YACD,OAAO,IAAI,CAAC;QACb,CAAC;QAEM,kBAAkB,CAAC,QAAgB,EAAE,QAAyB,EAAE,iBAA0B;YAChG,IAAI,eAAe,GAAG,IAAI,CAAC,0CAA0C,CAAC,QAAQ,GAAG,QAAQ,CAAC,CAAC;YAC3F,IAAI,CAAC,eAAe,EAAE;gBACrB,MAAM,MAAM,GAAG,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAmB,QAAQ,EAAE,EAAE,kBAAkB,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAC3H,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;gBAC7C,eAAe,GAAG,gBAAgB,CAAC,iBAAiB,CAAC,EAAE,MAAM,EAAE,GAAG,EAAE,EAAE,iBAAiB,CAAC,CAAC;gBACzF,IAAI,CAAC,0CAA0C,CAAC,QAAQ,GAAG,QAAQ,CAAC,GAAG,eAAe,CAAC;aACvF;YACD,OAAO,eAAe,CAAC;QACxB,CAAC;QAEO,mBAAmB;YAC1B,MAAM,+BAA+B,GAAG,IAAI,CAAC,0CAA0C,CAAC;YACxF,IAAI,CAAC,0CAA0C,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YAEtE,+BAA+B;YAC/B,MAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,EAAE;gBAChD,MAAM,OAAO,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;gBACxB,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;gBACxC,MAAM,QAAQ,GAAG,SAAS,CAAC,KAAK,CAAC,qBAAqB,EAAE,CAAC,QAAQ,CAAC;gBAClE,MAAM,GAAG,GAAG,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC;gBAChC,MAAM,UAAU,GAAG,+BAA+B,CAAC,QAAQ,GAAG,GAAG,CAAC,CAAC;gBACnE,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,QAAQ,EAAE,GAAG,EAAE,SAAS,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;gBAC7F,gBAAgB,CAAC,wBAAwB,CAAC,SAAS,CAAC,KAAK,EAAE,UAAU,EAAE,UAAU,CAAC,CAAC;aACnF;QACF,CAAC;QAEO,MAAM,CAAC,wBAAwB,CAAC,KAAiB,EAAE,UAAqC,EAAE,cAAyC;YAC1I,IAAI,cAAc,IAAI,cAAc,CAAC,UAAU,KAAK,UAAU,CAAC,UAAU,IAAI,KAAK,CAAC,YAAY,EAAE,KAAK,CAAC,EAAE;gBACxG,KAAK,CAAC,MAAM,CAAC,UAAU,CAAC,UAAU,eAAwB,CAAC,CAAC,YAAsB,CAAC,aAAuB,CAAC,CAAC;aAC5G;YAED,IAAI,cAAc;mBACd,CAAC,cAAc,CAAC,iBAAiB,KAAK,UAAU,CAAC,iBAAiB,CAAC;mBACnE,CAAC,cAAc,CAAC,YAAY,KAAK,UAAU,CAAC,YAAY,CAAC;mBACzD,CAAC,cAAc,CAAC,OAAO,KAAK,UAAU,CAAC,OAAO,CAAC;mBAC/C,CAAC,cAAc,CAAC,UAAU,KAAK,UAAU,CAAC,UAAU,CAAC;mBACrD,CAAC,cAAc,CAAC,kBAAkB,KAAK,UAAU,CAAC,kBAAkB,CAAC,EACvE;gBACD,+CAA+C;gBAC/C,OAAO;aACP;YAED,IAAI,UAAU,CAAC,iBAAiB,EAAE;gBACjC,KAAK,CAAC,iBAAiB,CAAC,UAAU,CAAC,YAAY,EAAE,UAAU,CAAC,OAAO,CAAC,CAAC;gBACrE,KAAK,CAAC,aAAa,CAAC;oBACnB,kBAAkB,EAAE,UAAU,CAAC,kBAAkB;iBACjD,CAAC,CAAC;aACH;iBAAM;gBACN,KAAK,CAAC,aAAa,CAAC;oBACnB,YAAY,EAAE,UAAU,CAAC,YAAY;oBACrC,OAAO,EAAE,UAAU,CAAC,OAAO;oBAC3B,UAAU,EAAE,UAAU,CAAC,UAAU;oBACjC,kBAAkB,EAAE,UAAU,CAAC,kBAAkB;iBACjD,CAAC,CAAC;aACH;QACF,CAAC;QAED,0BAA0B;QAElB,oBAAoB,CAAC,iBAAoC;YAChE,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,QAAQ,CAAC,iBAAiB,CAAC,GAAG,CAAC,EAAE,iBAAiB,CAAC,CAAC;YAC7E,IAAI,CAAC,uBAAuB,IAAI,iBAAiB,CAAC,QAAQ,CAAC;QAC5D,CAAC;QAEO,oBAAoB,CAAC,QAAa;YACzC,MAAM,iBAAiB,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;YACvE,IAAI,iBAAiB,EAAE;gBACtB,IAAI,CAAC,uBAAuB,IAAI,iBAAiB,CAAC,QAAQ,CAAC;aAC3D;YACD,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;YAChD,OAAO,iBAAiB,CAAC;QAC1B,CAAC;QAEO,6BAA6B,CAAC,iBAAyB;YAC9D,IAAI,IAAI,CAAC,uBAAuB,GAAG,iBAAiB,EAAE;gBACrD,qEAAqE;gBACrE,MAAM,cAAc,GAAwB,EAAE,CAAC;gBAC/C,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;oBACpC,IAAI,CAAC,KAAK,CAAC,mBAAmB,EAAE;wBAC/B,cAAc,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;qBAC3B;gBACF,CAAC,CAAC,CAAC;gBACH,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC;gBAC/C,OAAO,cAAc,CAAC,MAAM,GAAG,CAAC,IAAI,IAAI,CAAC,uBAAuB,GAAG,iBAAiB,EAAE;oBACrF,MAAM,aAAa,GAAG,cAAc,CAAC,KAAK,EAAG,CAAC;oBAC9C,IAAI,CAAC,oBAAoB,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC;oBAC7C,IAAI,aAAa,CAAC,uBAAuB,KAAK,IAAI,EAAE;wBACnD,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAAC;qBAC7E;iBACD;aACD;QACF,CAAC;QAEO,gBAAgB,CAAC,KAAkC,EAAE,kBAAsC,EAAE,QAAyB,EAAE,iBAA0B;YACzJ,0BAA0B;YAC1B,MAAM,OAAO,GAAG,IAAI,CAAC,kBAAkB,CAAC,kBAAkB,CAAC,QAAQ,EAAE,QAAQ,EAAE,iBAAiB,CAAC,CAAC;YAClG,MAAM,KAAK,GAAc,IAAI,qBAAS,CAAC,KAAK,EAAE,OAAO,EAAE,kBAAkB,EAAE,QAAQ,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC5G,IAAI,QAAQ,IAAI,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE;gBAC7D,MAAM,iBAAiB,GAAG,IAAI,CAAC,oBAAoB,CAAC,QAAQ,CAAE,CAAC;gBAC/D,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;gBAC7D,MAAM,WAAW,GAAG,CAAC,gBAAgB,CAAC,KAAK,CAAC,KAAK,iBAAiB,CAAC,IAAI,CAAC,CAAC;gBACzE,IAAI,WAAW,IAAI,iBAAiB,CAAC,mBAAmB,EAAE;oBACzD,KAAK,MAAM,OAAO,IAAI,QAAQ,CAAC,IAAI,EAAE;wBACpC,IAAI,CAAA,GAAA,8BAAkB,CAAA,CAAC,OAAO,CAAC,IAAI,OAAO,CAAC,eAAe,CAAC,QAAQ,CAAC,EAAE;4BACrE,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;yBACxB;qBACD;oBACD,KAAK,MAAM,OAAO,IAAI,QAAQ,CAAC,MAAM,EAAE;wBACtC,IAAI,CAAA,GAAA,8BAAkB,CAAA,CAAC,OAAO,CAAC,IAAI,OAAO,CAAC,eAAe,CAAC,QAAQ,CAAC,EAAE;4BACrE,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;yBACxB;qBACD;oBACD,IAAI,CAAC,gBAAgB,CAAC,oBAAoB,CAAC,QAAQ,EAAE,IAAI,EAAE,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,CAAA,GAAA,8BAAkB,CAAA,CAAC,OAAO,CAAC,IAAI,OAAO,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;oBAC5I,IAAI,WAAW,EAAE;wBAChB,KAAK,CAAC,mBAAmB,CAAC,iBAAiB,CAAC,SAAS,CAAC,CAAC;wBACvD,KAAK,CAAC,8BAA8B,CAAC,iBAAiB,CAAC,oBAAoB,CAAC,CAAC;wBAC7E,KAAK,CAAC,iCAAiC,CAAC,iBAAiB,CAAC,uBAAuB,CAAC,CAAC;qBACnF;iBACD;qBAAM;oBACN,IAAI,iBAAiB,CAAC,uBAAuB,KAAK,IAAI,EAAE;wBACvD,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,iBAAiB,CAAC,uBAAuB,CAAC,CAAC;qBACjF;iBACD;aACD;YACD,MAAM,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAEpC,IAAI,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE;gBAC1B,0EAA0E;gBAC1E,MAAM,IAAI,KAAK,CAAC,2DAA2D,CAAC,CAAC;aAC7E;YAED,MAAM,SAAS,GAAG,IAAI,SAAS,CAC9B,KAAK,EACL,CAAC,KAAK,EAAE,EAAE,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,EACrC,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,oBAAoB,CAAC,KAAK,EAAE,CAAC,CAAC,CACjD,CAAC;YACF,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,SAAS,CAAC;YAElC,OAAO,SAAS,CAAC;QAClB,CAAC;QAEM,WAAW,CAAC,KAAiB,EAAE,KAAkC;YACvE,MAAM,OAAO,GAAG,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,qBAAqB,EAAE,CAAC,QAAQ,EAAE,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,iBAAiB,CAAC,CAAC;YACpH,MAAM,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,CAAA,GAAA,4BAAgB,CAAA,CAAC,KAAK,EAAE,OAAO,CAAC,UAAU,CAAC,CAAC;YAE/E,uDAAuD;YACvD,IAAI,KAAK,CAAC,gBAAgB,CAAC,UAAU,CAAC,EAAE;gBACvC,UAAU,CAAC,OAAO,EAAE,CAAC;gBACrB,OAAO;aACP;YAED,4DAA4D;YAC5D,KAAK,CAAC,gBAAgB,EAAE,CAAC;YACzB,KAAK,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,EAAE,KAAK,MAAM,CAAC,CAAC,cAAwB,CAAC,WAAqB,CAAC,CAAC;YAC9F,KAAK,CAAC,kBAAkB,CACvB,EAAE,EACF,gBAAgB,CAAC,aAAa,CAAC,KAAK,EAAE,UAAU,CAAC,EACjD,GAAG,EAAE,CAAC,EAAE,CACR,CAAC;YACF,KAAK,CAAC,gBAAgB,EAAE,CAAC;YACzB,UAAU,CAAC,OAAO,EAAE,CAAC;QACtB,CAAC;QAEO,MAAM,CAAC,aAAa,CAAC,CAAgB,EAAE,IAAY,EAAE,MAAc,EAAE,CAAgB,EAAE,IAAY,EAAE,MAAc;YAC1H,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;YAEvC,IAAI,MAAM,GAAG,CAAC,CAAC;YACf,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,IAAI,CAAC,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE;gBACpG,MAAM,EAAE,CAAC;aACT;YACD,OAAO,MAAM,CAAC;QACf,CAAC;QAEO,MAAM,CAAC,aAAa,CAAC,CAAgB,EAAE,IAAY,EAAE,MAAc,EAAE,CAAgB,EAAE,IAAY,EAAE,MAAc;YAC1H,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;YAEvC,IAAI,MAAM,GAAG,CAAC,CAAC;YACf,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,IAAI,CAAC,CAAC,cAAc,CAAC,MAAM,GAAG,IAAI,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,cAAc,CAAC,MAAM,GAAG,IAAI,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE;gBAClH,MAAM,EAAE,CAAC;aACT;YACD,OAAO,MAAM,CAAC;QACf,CAAC;QAED;;WAEG;QACI,MAAM,CAAC,aAAa,CAAC,KAAiB,EAAE,UAAuB;YACrE,MAAM,cAAc,GAAG,KAAK,CAAC,YAAY,EAAE,CAAC;YAC5C,MAAM,mBAAmB,GAAG,UAAU,CAAC,YAAY,EAAE,CAAC;YACtD,MAAM,YAAY,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,cAAc,EAAE,CAAC,EAAE,UAAU,EAAE,mBAAmB,EAAE,CAAC,CAAC,CAAC;YAEtG,IAAI,cAAc,KAAK,mBAAmB,IAAI,YAAY,KAAK,cAAc,EAAE;gBAC9E,gBAAgB;gBAChB,OAAO,EAAE,CAAC;aACV;YAED,MAAM,YAAY,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,cAAc,GAAG,YAAY,EAAE,YAAY,EAAE,UAAU,EAAE,mBAAmB,GAAG,YAAY,EAAE,YAAY,CAAC,CAAC;YAE1J,IAAI,QAAe,CAAC;YACpB,IAAI,QAAe,CAAC;YACpB,IAAI,YAAY,GAAG,CAAC,EAAE;gBACrB,QAAQ,GAAG,IAAI,aAAK,CAAC,YAAY,GAAG,CAAC,EAAE,CAAC,EAAE,cAAc,GAAG,YAAY,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;gBAChF,QAAQ,GAAG,IAAI,aAAK,CAAC,YAAY,GAAG,CAAC,EAAE,CAAC,EAAE,mBAAmB,GAAG,YAAY,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;aACrF;iBAAM,IAAI,YAAY,GAAG,CAAC,EAAE;gBAC5B,QAAQ,GAAG,IAAI,aAAK,CAAC,YAAY,EAAE,KAAK,CAAC,gBAAgB,CAAC,YAAY,CAAC,EAAE,cAAc,EAAE,KAAK,CAAC,gBAAgB,CAAC,cAAc,CAAC,CAAC,CAAC;gBACjI,QAAQ,GAAG,IAAI,aAAK,CAAC,YAAY,EAAE,CAAC,GAAG,UAAU,CAAC,aAAa,CAAC,YAAY,CAAC,EAAE,mBAAmB,EAAE,CAAC,GAAG,UAAU,CAAC,aAAa,CAAC,mBAAmB,CAAC,CAAC,CAAC;aACvJ;iBAAM;gBACN,QAAQ,GAAG,IAAI,aAAK,CAAC,CAAC,EAAE,CAAC,EAAE,cAAc,EAAE,KAAK,CAAC,gBAAgB,CAAC,cAAc,CAAC,CAAC,CAAC;gBACnF,QAAQ,GAAG,IAAI,aAAK,CAAC,CAAC,EAAE,CAAC,EAAE,mBAAmB,EAAE,CAAC,GAAG,UAAU,CAAC,aAAa,CAAC,mBAAmB,CAAC,CAAC,CAAC;aACnG;YAED,OAAO,CAAC,6BAAa,CAAC,WAAW,CAAC,QAAQ,EAAE,UAAU,CAAC,eAAe,CAAC,QAAQ,sBAAkC,CAAC,CAAC,CAAC;QACrH,CAAC;QAEM,WAAW,CAAC,KAAkC,EAAE,iBAA4C,EAAE,QAAc,EAAE,oBAA6B,KAAK;YACtJ,IAAI,SAAoB,CAAC;YAEzB,IAAI,iBAAiB,EAAE;gBACtB,SAAS,GAAG,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,iBAAiB,CAAC,kBAAkB,EAAE,QAAQ,EAAE,iBAAiB,CAAC,CAAC;gBAC5G,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,KAAK,EAAE,iBAAiB,CAAC,CAAC;aACjD;iBAAM;gBACN,SAAS,GAAG,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,6CAA6B,EAAE,QAAQ,EAAE,iBAAiB,CAAC,CAAC;aACrG;YAED,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YAEzC,OAAO,SAAS,CAAC,KAAK,CAAC;QACxB,CAAC;QAEM,OAAO,CAAC,KAAiB,EAAE,iBAAqC;YACtE,IAAI,CAAC,iBAAiB,EAAE;gBACvB,OAAO;aACP;YACD,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;YACpD,IAAI,CAAC,SAAS,EAAE;gBACf,OAAO;aACP;YACD,SAAS,CAAC,WAAW,CAAC,iBAAiB,CAAC,CAAC;QAC1C,CAAC;QAEM,YAAY,CAAC,QAAa;YAChC,+GAA+G;YAC/G,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC;YACnD,IAAI,CAAC,SAAS,EAAE;gBACf,OAAO;aACP;YACD,SAAS,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;QAC3B,CAAC;QAEM,SAAS;YACf,MAAM,GAAG,GAAiB,EAAE,CAAC;YAE7B,MAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE,EAAE;gBAChD,MAAM,OAAO,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;gBACxB,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,KAAK,CAAC,CAAC;aACtC;YAED,OAAO,GAAG,CAAC;QACZ,CAAC;QAEM,QAAQ,CAAC,QAAa;YAC5B,MAAM,OAAO,GAAG,QAAQ,CAAC,QAAQ,CAAC,CAAC;YACnC,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YACxC,IAAI,CAAC,SAAS,EAAE;gBACf,OAAO,IAAI,CAAC;aACZ;YACD,OAAO,SAAS,CAAC,KAAK,CAAC;QACxB,CAAC;QAEM,gCAAgC,CAAC,QAAgC;YACvE,OAAO,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAC5C,CAAC;QAED,wBAAwB;QAEhB,cAAc,CAAC,KAAiB;YACvC,MAAM,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YACpC,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YAExC,MAAM,mBAAmB,GAAG,CAAC,IAAI,CAAC,gBAAgB,CAAC,mBAAmB,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;YAC5G,IAAI,qBAAqB,GAAG,KAAK,CAAC;YAClC,IAAI,QAAQ,GAAG,CAAC,CAAC;YACjB,IAAI,mBAAmB,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,IAAI,oCAAoC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,EAAE;gBAC/G,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAC9D,IAAI,QAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,IAAI,QAAQ,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;oBAC3D,KAAK,MAAM,OAAO,IAAI,QAAQ,CAAC,IAAI,EAAE;wBACpC,IAAI,CAAA,GAAA,8BAAkB,CAAA,CAAC,OAAO,CAAC,IAAI,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE;4BACtE,qBAAqB,GAAG,IAAI,CAAC;4BAC7B,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;4BACxC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,6CAA6C;yBAC1E;qBACD;oBACD,KAAK,MAAM,OAAO,IAAI,QAAQ,CAAC,MAAM,EAAE;wBACtC,IAAI,CAAA,GAAA,8BAAkB,CAAA,CAAC,OAAO,CAAC,IAAI,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE;4BACtE,qBAAqB,GAAG,IAAI,CAAC;4BAC7B,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;4BACxC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,6CAA6C;yBAC1E;qBACD;iBACD;aACD;YAED,MAAM,SAAS,GAAG,gBAAgB,CAAC,sCAAsC,CAAC;YAC1E,IAAI,CAAC,qBAAqB,EAAE;gBAC3B,IAAI,CAAC,mBAAmB,EAAE;oBACzB,MAAM,uBAAuB,GAAG,SAAS,CAAC,KAAK,CAAC,0BAA0B,EAAE,CAAC;oBAC7E,IAAI,uBAAuB,KAAK,IAAI,EAAE;wBACrC,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,uBAAuB,CAAC,CAAC;qBAC/D;iBACD;aACD;iBAAM,IAAI,CAAC,mBAAmB,IAAI,QAAQ,GAAG,SAAS,EAAE;gBACxD,kGAAkG;gBAClG,MAAM,uBAAuB,GAAG,SAAS,CAAC,KAAK,CAAC,0BAA0B,EAAE,CAAC;gBAC7E,IAAI,uBAAuB,KAAK,IAAI,EAAE;oBACrC,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,uBAAuB,CAAC,CAAC;iBAC/D;aACD;iBAAM;gBACN,IAAI,CAAC,6BAA6B,CAAC,SAAS,GAAG,QAAQ,CAAC,CAAC;gBACzD,6EAA6E;gBAC7E,IAAI,CAAC,gBAAgB,CAAC,oBAAoB,CAAC,KAAK,CAAC,GAAG,EAAE,KAAK,EAAE,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,CAAA,GAAA,8BAAkB,CAAA,CAAC,OAAO,CAAC,IAAI,OAAO,CAAC,eAAe,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;gBAC/I,IAAI,CAAC,oBAAoB,CAAC,IAAI,iBAAiB,CAAC,KAAK,CAAC,GAAG,EAAE,SAAS,CAAC,KAAK,CAAC,0BAA0B,EAAE,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,mBAAmB,EAAE,QAAQ,EAAE,gBAAgB,CAAC,KAAK,CAAC,EAAE,KAAK,CAAC,YAAY,EAAE,EAAE,KAAK,CAAC,uBAAuB,EAAE,CAAC,CAAC,CAAC;aACrO;YAED,OAAO,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YAC7B,SAAS,CAAC,OAAO,EAAE,CAAC;YAEpB,iBAAiB;YACjB,OAAO,IAAI,CAAC,0CAA0C,CAAC,KAAK,CAAC,qBAAqB,EAAE,CAAC,QAAQ,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC;YAE3G,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAClC,CAAC;QAEO,oBAAoB,CAAC,KAAiB,EAAE,CAA6B;YAC5E,MAAM,SAAS,GAAG,CAAC,CAAC,WAAW,CAAC;YAChC,MAAM,SAAS,GAAG,KAAK,CAAC,qBAAqB,EAAE,CAAC,QAAQ,CAAC;YACzD,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,iBAAiB,CAAC,CAAC;YAC1F,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,iBAAiB,CAAC,CAAC;YAC1F,gBAAgB,CAAC,wBAAwB,CAAC,KAAK,EAAE,UAAU,EAAE,UAAU,CAAC,CAAC;YACzE,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,CAAC;QACrD,CAAC;KACD,CAAA;IApdc,uDAAsC,GAAG,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC;IAF5D,gBAAgB;QA0B1B,WAAA,qCAAqB,CAAA;QACrB,WAAA,iEAA8B,CAAA;QAC9B,WAAA,4BAAa,CAAA;QACb,WAAA,iBAAW,CAAA;QACX,WAAA,2BAAgB,CAAA;OA9BN,gBAAgB,CAsd5B;IAtdY,4CAAgB;IA4dhB,QAAA,gCAAgC,GAAG,6BAA6B,CAAC;IAE9E,SAAgB,yBAAyB,CAAC,KAAiB,EAAE,YAA2B,EAAE,oBAA2C;;QACpI,MAAM,OAAO,GAAG,MAAA,oBAAoB,CAAC,QAAQ,CAAqC,wCAAgC,EAAE,EAAE,kBAAkB,EAAE,KAAK,CAAC,qBAAqB,EAAE,CAAC,QAAQ,EAAE,QAAQ,EAAE,KAAK,CAAC,GAAG,EAAE,CAAC,0CAAE,OAAO,CAAC;QAClN,IAAI,OAAO,OAAO,KAAK,SAAS,EAAE;YACjC,OAAO,OAAO,CAAC;SACf;QACD,OAAO,YAAY,CAAC,aAAa,EAAE,CAAC,oBAAoB,CAAC;IAC1D,CAAC;IAND,8DAMC;IAED,MAAM,uBAAwB,SAAQ,sBAAU;QAK/C,YAAY,YAA2B,EAAE,YAA2B,EAAE,oBAA2C,EAAE,eAAgC;YAClJ,KAAK,EAAE,CAAC;YACR,IAAI,CAAC,SAAS,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACrC,IAAI,CAAC,gBAAgB,GAAG,eAAe,CAAC;YAExC,MAAM,QAAQ,GAAG,CAAC,KAAiB,EAAE,EAAE;gBACtC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,GAAG,IAAI,qBAAqB,CAAC,KAAK,EAAE,YAAY,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC9G,CAAC,CAAC;YACF,MAAM,UAAU,GAAG,CAAC,KAAiB,EAAE,qBAA4C,EAAE,EAAE;gBACtF,qBAAqB,CAAC,OAAO,EAAE,CAAC;gBAChC,OAAO,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;YAC7C,CAAC,CAAC;YACF,MAAM,0BAA0B,GAAG,GAAG,EAAE;gBACvC,KAAK,IAAI,KAAK,IAAI,YAAY,CAAC,SAAS,EAAE,EAAE;oBAC3C,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;oBAClD,IAAI,yBAAyB,CAAC,KAAK,EAAE,YAAY,EAAE,oBAAoB,CAAC,EAAE;wBACzE,IAAI,CAAC,IAAI,EAAE;4BACV,QAAQ,CAAC,KAAK,CAAC,CAAC;yBAChB;qBACD;yBAAM;wBACN,IAAI,IAAI,EAAE;4BACT,UAAU,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;yBACxB;qBACD;iBACD;YACF,CAAC,CAAC;YACF,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC,KAAK,EAAE,EAAE;gBAClD,IAAI,yBAAyB,CAAC,KAAK,EAAE,YAAY,EAAE,oBAAoB,CAAC,EAAE;oBACzE,QAAQ,CAAC,KAAK,CAAC,CAAC;iBAChB;YACF,CAAC,CAAC,CAAC,CAAC;YACJ,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,cAAc,CAAC,CAAC,KAAK,EAAE,EAAE;gBACpD,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;gBAClD,IAAI,IAAI,EAAE;oBACT,UAAU,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;iBACxB;YACF,CAAC,CAAC,CAAC,CAAC;YACJ,IAAI,CAAC,SAAS,CAAC,oBAAoB,CAAC,wBAAwB,CAAC,CAAC,CAAC,EAAE;gBAChE,IAAI,CAAC,CAAC,oBAAoB,CAAC,wCAAgC,CAAC,EAAE;oBAC7D,0BAA0B,EAAE,CAAC;iBAC7B;YACF,CAAC,CAAC,CAAC,CAAC;YACJ,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,qBAAqB,CAAC,0BAA0B,CAAC,CAAC,CAAC;QAChF,CAAC;KACD;IAED,MAAM,eAAgB,SAAQ,sBAAU;QAIvC,YACkB,aAA4B,EAC5B,WAAwB;YAEzC,KAAK,EAAE,CAAC;YAHS,kBAAa,GAAb,aAAa,CAAe;YAC5B,gBAAW,GAAX,WAAW,CAAa;YAGzC,IAAI,CAAC,OAAO,GAAG,IAAI,OAAO,EAAyD,CAAC;YACpF,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,aAAa,CAAC,qBAAqB,CAAC,GAAG,EAAE;gBAC5D,IAAI,CAAC,OAAO,GAAG,IAAI,OAAO,EAAyD,CAAC;YACrF,CAAC,CAAC,CAAC,CAAC;QACL,CAAC;QAEM,GAAG,CAAC,QAAgC;YAC1C,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;gBAChC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,6DAA6B,CAAC,QAAQ,CAAC,SAAS,EAAE,EAAE,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;aAC1H;YACD,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAE,CAAC;QACpC,CAAC;KACD;IAED,MAAM,sBAAsB;QAC3B,YACkB,SAAyC,EAC1C,QAA4B,EAC5B,IAAiB;YAFhB,cAAS,GAAT,SAAS,CAAgC;YAC1C,aAAQ,GAAR,QAAQ,CAAoB;YAC5B,SAAI,GAAJ,IAAI,CAAa;QAC9B,CAAC;QAEE,OAAO;YACb,IAAI,CAAC,SAAS,CAAC,6BAA6B,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC7D,CAAC;KACD;IAED,MAAa,qBAAsB,SAAQ,sBAAU;QAYpD,YAAY,KAAiB,EAAE,YAA2B,EAAE,eAAgC;YAC3F,KAAK,EAAE,CAAC;YAER,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;YACzB,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;YACpB,IAAI,CAAC,gBAAgB,GAAG,eAAe,CAAC;YACxC,IAAI,CAAC,4BAA4B,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,wBAAgB,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,+BAA+B,EAAE,EAAE,qBAAqB,CAAC,oCAAoC,CAAC,CAAC,CAAC;YACnL,IAAI,CAAC,wBAAwB,GAAG,IAAI,CAAC;YACrC,IAAI,CAAC,8CAA8C,GAAG,IAAI,CAAC;YAC3D,IAAI,CAAC,iCAAiC,GAAG,EAAE,CAAC;YAE5C,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,GAAG,EAAE;gBAClD,IAAI,CAAC,IAAI,CAAC,4BAA4B,CAAC,WAAW,EAAE,EAAE;oBACrD,IAAI,CAAC,4BAA4B,CAAC,QAAQ,EAAE,CAAC;iBAC7C;YACF,CAAC,CAAC,CAAC,CAAC;YACJ,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,mBAAmB,CAAC,GAAG,EAAE;gBACnD,8BAA8B;gBAC9B,IAAI,IAAI,CAAC,wBAAwB,EAAE;oBAClC,IAAI,CAAC,wBAAwB,CAAC,OAAO,EAAE,CAAC;oBACxC,IAAI,CAAC,wBAAwB,GAAG,IAAI,CAAC;iBACrC;gBACD,IAAI,IAAI,CAAC,8CAA8C,EAAE;oBACxD,IAAI,CAAC,8CAA8C,CAAC,MAAM,EAAE,CAAC;oBAC7D,IAAI,CAAC,8CAA8C,GAAG,IAAI,CAAC;iBAC3D;gBACD,IAAI,CAAC,0BAA0B,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;gBACtD,IAAI,CAAC,4BAA4B,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;YAC/C,CAAC,CAAC,CAAC,CAAC;YACJ,MAAM,2BAA2B,GAAG,GAAG,EAAE;gBACxC,CAAA,GAAA,mBAAO,CAAA,CAAC,IAAI,CAAC,iCAAiC,CAAC,CAAC;gBAChD,IAAI,CAAC,iCAAiC,GAAG,EAAE,CAAC;gBAC5C,KAAK,MAAM,QAAQ,IAAI,8CAAsC,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;oBACzE,IAAI,OAAO,QAAQ,CAAC,WAAW,KAAK,UAAU,EAAE;wBAC/C,IAAI,CAAC,iCAAiC,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,4BAA4B,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;qBACvH;iBACD;YACF,CAAC,CAAC;YACF,2BAA2B,EAAE,CAAC;YAC9B,IAAI,CAAC,SAAS,CAAC,8CAAsC,CAAC,WAAW,CAAC,GAAG,EAAE;gBACtE,2BAA2B,EAAE,CAAC;gBAC9B,IAAI,CAAC,4BAA4B,CAAC,QAAQ,EAAE,CAAC;YAC9C,CAAC,CAAC,CAAC,CAAC;YAEJ,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,qBAAqB,CAAC,CAAC,CAAC,EAAE;gBACrD,4BAA4B;gBAC5B,IAAI,CAAC,0BAA0B,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;gBACtD,IAAI,CAAC,4BAA4B,CAAC,QAAQ,EAAE,CAAC;YAC9C,CAAC,CAAC,CAAC,CAAC;YAEJ,IAAI,CAAC,4BAA4B,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;QAC/C,CAAC;QAEe,OAAO;YACtB,IAAI,IAAI,CAAC,wBAAwB,EAAE;gBAClC,IAAI,CAAC,wBAAwB,CAAC,OAAO,EAAE,CAAC;gBACxC,IAAI,CAAC,wBAAwB,GAAG,IAAI,CAAC;aACrC;YACD,IAAI,IAAI,CAAC,8CAA8C,EAAE;gBACxD,IAAI,CAAC,8CAA8C,CAAC,MAAM,EAAE,CAAC;gBAC7D,IAAI,CAAC,8CAA8C,GAAG,IAAI,CAAC;aAC3D;YACD,IAAI,CAAC,0BAA0B,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;YACtD,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;YAExB,KAAK,CAAC,OAAO,EAAE,CAAC;QACjB,CAAC;QAEO,+BAA+B;YACtC,IAAI,IAAI,CAAC,8CAA8C,EAAE;gBACxD,uDAAuD;gBACvD,OAAO;aACP;YAED,MAAM,uBAAuB,GAAG,IAAI,sCAAuB,EAAE,CAAC;YAC9D,MAAM,YAAY,GAAG,IAAI,CAAC,wBAAwB,CAAC,CAAC,CAAC,IAAI,CAAC,wBAAwB,CAAC,QAAQ,IAAI,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC;YAC3G,MAAM,CAAC,GAAG,CAAA,GAAA,6CAAyB,CAAA,CAAC,IAAI,CAAC,MAAM,EAAE,YAAY,EAAE,uBAAuB,CAAC,KAAK,CAAC,CAAC;YAC9F,IAAI,CAAC,CAAC,EAAE;gBACP,uBAAuB;gBACvB,IAAI,IAAI,CAAC,wBAAwB,EAAE;oBAClC,gCAAgC;oBAChC,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;iBAC3C;gBACD,OAAO;aACP;YAED,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,GAAG,CAAC,CAAC;YAChC,IAAI,CAAC,8CAA8C,GAAG,uBAAuB,CAAC;YAE9E,MAAM,cAAc,GAAgC,EAAE,CAAC;YACvD,MAAM,qBAAqB,GAAG,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,EAAE;gBAClE,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YACxB,CAAC,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAEpD,OAAO,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE;gBACpB,IAAI,CAAC,8CAA8C,GAAG,IAAI,CAAC;gBAC3D,qBAAqB,CAAC,OAAO,EAAE,CAAC;gBAChC,IAAI,CAAC,0BAA0B,CAAC,QAAQ,EAAE,GAAG,IAAI,IAAI,EAAE,OAAO,EAAE,cAAc,CAAC,CAAC;YACjF,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE;gBACV,MAAM,eAAe,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,sBAAsB,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,GAAG,CAAC,OAAO,KAAK,QAAQ,IAAI,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC/I,IAAI,CAAC,eAAe,EAAE;oBACrB,MAAM,CAAC,iBAAiB,CAAC,GAAG,CAAC,CAAC;iBAC9B;gBAED,+GAA+G;gBAC/G,gEAAgE;gBAChE,IAAI,CAAC,8CAA8C,GAAG,IAAI,CAAC;gBAC3D,qBAAqB,CAAC,OAAO,EAAE,CAAC;gBAEhC,IAAI,cAAc,CAAC,MAAM,GAAG,CAAC,EAAE;oBAC9B,sDAAsD;oBACtD,IAAI,CAAC,IAAI,CAAC,4BAA4B,CAAC,WAAW,EAAE,EAAE;wBACrD,IAAI,CAAC,4BAA4B,CAAC,QAAQ,EAAE,CAAC;qBAC7C;iBACD;YACF,CAAC,CAAC,CAAC;QACJ,CAAC;QAEO,MAAM,CAAC,KAAK,CAAC,GAAgB,EAAE,SAAiB,EAAE,IAAiB,EAAE,UAAkB,EAAE,MAAc;YAC9G,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,EAAE;gBAChC,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC,SAAS,GAAG,CAAC,CAAC,CAAC;aAC1C;QACF,CAAC;QAEO,0BAA0B,CAAC,QAA+C,EAAE,MAAmD,EAAE,OAA6C,EAAE,cAA2C;YAClO,MAAM,eAAe,GAAG,IAAI,CAAC,wBAAwB,CAAC;YACtD,MAAM,kBAAkB,GAAG,GAAG,EAAE;gBAC/B,IAAI,cAAc,CAAC,MAAM,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,4BAA4B,CAAC,WAAW,EAAE,EAAE;oBAClF,IAAI,CAAC,4BAA4B,CAAC,QAAQ,EAAE,CAAC;iBAC7C;YACF,CAAC,CAAC;YAEF,IAAI,IAAI,CAAC,wBAAwB,EAAE;gBAClC,IAAI,CAAC,wBAAwB,CAAC,OAAO,EAAE,CAAC;gBACxC,IAAI,CAAC,wBAAwB,GAAG,IAAI,CAAC;aACrC;YACD,IAAI,IAAI,CAAC,WAAW,EAAE;gBACrB,YAAY;gBACZ,IAAI,QAAQ,IAAI,MAAM,EAAE;oBACvB,QAAQ,CAAC,6BAA6B,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;iBACxD;gBACD,OAAO;aACP;YACD,IAAI,CAAC,QAAQ,IAAI,CAAC,OAAO,EAAE;gBAC1B,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;gBAC3C,OAAO;aACP;YACD,IAAI,CAAC,MAAM,EAAE;gBACZ,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;gBAC1C,kBAAkB,EAAE,CAAC;gBACrB,OAAO;aACP;YAED,IAAI,CAAA,GAAA,yCAAqB,CAAA,CAAC,MAAM,CAAC,EAAE;gBAClC,IAAI,CAAC,eAAe,EAAE;oBACrB,gBAAgB;oBAChB,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;oBAC1C,OAAO;iBACP;gBACD,IAAI,MAAM,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;oBAC9B,iBAAiB;oBACjB,MAAM,GAAG;wBACR,QAAQ,EAAE,MAAM,CAAC,QAAQ;wBACzB,IAAI,EAAE,eAAe,CAAC,IAAI;qBAC1B,CAAC;iBACF;qBAAM;oBACN,IAAI,WAAW,GAAG,CAAC,CAAC;oBACpB,KAAK,MAAM,IAAI,IAAI,MAAM,CAAC,KAAK,EAAE;wBAChC,WAAW,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,WAAW,CAAC;qBACrE;oBAED,MAAM,OAAO,GAAG,eAAe,CAAC,IAAI,CAAC;oBACrC,MAAM,QAAQ,GAAG,IAAI,WAAW,CAAC,OAAO,CAAC,MAAM,GAAG,WAAW,CAAC,CAAC;oBAE/D,IAAI,YAAY,GAAG,OAAO,CAAC,MAAM,CAAC;oBAClC,IAAI,aAAa,GAAG,QAAQ,CAAC,MAAM,CAAC;oBACpC,KAAK,IAAI,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;wBAClD,MAAM,IAAI,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;wBAE7B,MAAM,SAAS,GAAG,YAAY,GAAG,CAAC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC;wBACjE,IAAI,SAAS,GAAG,CAAC,EAAE;4BAClB,qBAAqB,CAAC,KAAK,CAAC,OAAO,EAAE,YAAY,GAAG,SAAS,EAAE,QAAQ,EAAE,aAAa,GAAG,SAAS,EAAE,SAAS,CAAC,CAAC;4BAC/G,aAAa,IAAI,SAAS,CAAC;yBAC3B;wBAED,IAAI,IAAI,CAAC,IAAI,EAAE;4BACd,qBAAqB,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,EAAE,QAAQ,EAAE,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;4BACxG,aAAa,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC;yBAClC;wBAED,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC;qBAC1B;oBAED,IAAI,YAAY,GAAG,CAAC,EAAE;wBACrB,qBAAqB,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,YAAY,CAAC,CAAC;qBACnE;oBAED,MAAM,GAAG;wBACR,QAAQ,EAAE,MAAM,CAAC,QAAQ;wBACzB,IAAI,EAAE,QAAQ;qBACd,CAAC;iBACF;aACD;YAED,IAAI,CAAA,GAAA,oCAAgB,CAAA,CAAC,MAAM,CAAC,EAAE;gBAE7B,IAAI,CAAC,wBAAwB,GAAG,IAAI,sBAAsB,CAAC,QAAQ,EAAE,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;gBAEnG,MAAM,MAAM,GAAG,CAAA,GAAA,kDAAkB,CAAA,CAAC,MAAM,EAAE,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,qBAAqB,EAAE,CAAC,CAAC;gBAExF,kCAAkC;gBAClC,IAAI,cAAc,CAAC,MAAM,GAAG,CAAC,EAAE;oBAC9B,sDAAsD;oBACtD,cAAc;oBACd,qCAAqC;oBACrC,wBAAwB;oBACxB,KAAK,MAAM,MAAM,IAAI,cAAc,EAAE;wBACpC,KAAK,MAAM,IAAI,IAAI,MAAM,EAAE;4BAC1B,KAAK,MAAM,YAAY,IAAI,MAAM,CAAC,OAAO,EAAE;gCAC1C,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,KAAK,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC;6BACtD;yBACD;qBACD;iBACD;gBAED,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;aAC5C;iBAAM;gBACN,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;aAC1C;YAED,kBAAkB,EAAE,CAAC;QACtB,CAAC;;IArPF,sDAsPC;IApPc,0DAAoC,GAAG,GAAG,CAAC","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { Disposable, IDisposable, DisposableStore, dispose } from 'vs/base/common/lifecycle';\nimport * as platform from 'vs/base/common/platform';\nimport * as errors from 'vs/base/common/errors';\nimport { URI } from 'vs/base/common/uri';\nimport { EDITOR_MODEL_DEFAULTS } from 'vs/editor/common/config/editorOptions';\nimport { EditOperation } from 'vs/editor/common/core/editOperation';\nimport { Range } from 'vs/editor/common/core/range';\nimport { DefaultEndOfLine, EndOfLinePreference, EndOfLineSequence, IIdentifiedSingleEditOperation, ITextBuffer, ITextBufferFactory, ITextModel, ITextModelCreationOptions } from 'vs/editor/common/model';\nimport { TextModel, createTextBuffer } from 'vs/editor/common/model/textModel';\nimport { IModelLanguageChangedEvent, IModelContentChangedEvent } from 'vs/editor/common/model/textModelEvents';\nimport { LanguageIdentifier, DocumentSemanticTokensProviderRegistry, DocumentSemanticTokensProvider, SemanticTokens, SemanticTokensEdits } from 'vs/editor/common/modes';\nimport { PLAINTEXT_LANGUAGE_IDENTIFIER } from 'vs/editor/common/modes/modesRegistry';\nimport { ILanguageSelection } from 'vs/editor/common/services/modeService';\nimport { IModelService, DocumentTokensProvider } from 'vs/editor/common/services/modelService';\nimport { ITextResourcePropertiesService } from 'vs/editor/common/services/textResourceConfigurationService';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\nimport { RunOnceScheduler } from 'vs/base/common/async';\nimport { CancellationTokenSource } from 'vs/base/common/cancellation';\nimport { IThemeService } from 'vs/platform/theme/common/themeService';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { IUndoRedoService, ResourceEditStackSnapshot } from 'vs/platform/undoRedo/common/undoRedo';\nimport { StringSHA1 } from 'vs/base/common/hash';\nimport { EditStackElement, isEditStackElement } from 'vs/editor/common/model/editStack';\nimport { Schemas } from 'vs/base/common/network';\nimport { SemanticTokensProviderStyling, toMultilineTokens2 } from 'vs/editor/common/services/semanticTokensProviderStyling';\nimport { getDocumentSemanticTokens, isSemanticTokens, isSemanticTokensEdits } from 'vs/editor/common/services/getSemanticTokens';\n\nexport interface IEditorSemanticHighlightingOptions {\n\tenabled: true | false | 'configuredByTheme';\n}\n\nfunction MODEL_ID(resource: URI): string {\n\treturn resource.toString();\n}\n\nfunction computeModelSha1(model: ITextModel): string {\n\t// compute the sha1\n\tconst shaComputer = new StringSHA1();\n\tconst snapshot = model.createSnapshot();\n\tlet text: string | null;\n\twhile ((text = snapshot.read())) {\n\t\tshaComputer.update(text);\n\t}\n\treturn shaComputer.digest();\n}\n\n\nclass ModelData implements IDisposable {\n\tpublic readonly model: TextModel;\n\n\tprivate _languageSelection: ILanguageSelection | null;\n\tprivate _languageSelectionListener: IDisposable | null;\n\n\tprivate readonly _modelEventListeners = new DisposableStore();\n\n\tconstructor(\n\t\tmodel: TextModel,\n\t\tonWillDispose: (model: ITextModel) => void,\n\t\tonDidChangeLanguage: (model: ITextModel, e: IModelLanguageChangedEvent) => void\n\t) {\n\t\tthis.model = model;\n\n\t\tthis._languageSelection = null;\n\t\tthis._languageSelectionListener = null;\n\n\t\tthis._modelEventListeners.add(model.onWillDispose(() => onWillDispose(model)));\n\t\tthis._modelEventListeners.add(model.onDidChangeLanguage((e) => onDidChangeLanguage(model, e)));\n\t}\n\n\tprivate _disposeLanguageSelection(): void {\n\t\tif (this._languageSelectionListener) {\n\t\t\tthis._languageSelectionListener.dispose();\n\t\t\tthis._languageSelectionListener = null;\n\t\t}\n\t}\n\n\tpublic dispose(): void {\n\t\tthis._modelEventListeners.dispose();\n\t\tthis._disposeLanguageSelection();\n\t}\n\n\tpublic setLanguage(languageSelection: ILanguageSelection): void {\n\t\tthis._disposeLanguageSelection();\n\t\tthis._languageSelection = languageSelection;\n\t\tthis._languageSelectionListener = this._languageSelection.onDidChange(() => this.model.setMode(languageSelection.languageIdentifier));\n\t\tthis.model.setMode(languageSelection.languageIdentifier);\n\t}\n}\n\ninterface IRawEditorConfig {\n\ttabSize?: any;\n\tindentSize?: any;\n\tinsertSpaces?: any;\n\tdetectIndentation?: any;\n\ttrimAutoWhitespace?: any;\n\tcreationOptions?: any;\n\tlargeFileOptimizations?: any;\n}\n\ninterface IRawConfig {\n\teol?: any;\n\teditor?: IRawEditorConfig;\n}\n\nconst DEFAULT_EOL = (platform.isLinux || platform.isMacintosh) ? DefaultEndOfLine.LF : DefaultEndOfLine.CRLF;\n\nexport interface EditStackPastFutureElements {\n\tpast: EditStackElement[];\n\tfuture: EditStackElement[];\n}\n\nclass DisposedModelInfo {\n\tconstructor(\n\t\tpublic readonly uri: URI,\n\t\tpublic readonly initialUndoRedoSnapshot: ResourceEditStackSnapshot | null,\n\t\tpublic readonly time: number,\n\t\tpublic readonly sharesUndoRedoStack: boolean,\n\t\tpublic readonly heapSize: number,\n\t\tpublic readonly sha1: string,\n\t\tpublic readonly versionId: number,\n\t\tpublic readonly alternativeVersionId: number,\n\t) { }\n}\n\nfunction schemaShouldMaintainUndoRedoElements(resource: URI) {\n\treturn (\n\t\tresource.scheme === Schemas.file\n\t\t|| resource.scheme === Schemas.vscodeRemote\n\t\t|| resource.scheme === Schemas.userData\n\t\t|| resource.scheme === 'fake-fs' // for tests\n\t);\n}\n\nexport class ModelServiceImpl extends Disposable implements IModelService {\n\n\tpublic static MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK = 20 * 1024 * 1024;\n\n\tpublic _serviceBrand: undefined;\n\n\tprivate readonly _onModelAdded: Emitter<ITextModel> = this._register(new Emitter<ITextModel>());\n\tpublic readonly onModelAdded: Event<ITextModel> = this._onModelAdded.event;\n\n\tprivate readonly _onModelRemoved: Emitter<ITextModel> = this._register(new Emitter<ITextModel>());\n\tpublic readonly onModelRemoved: Event<ITextModel> = this._onModelRemoved.event;\n\n\tprivate readonly _onModelModeChanged: Emitter<{ model: ITextModel; oldModeId: string; }> = this._register(new Emitter<{ model: ITextModel; oldModeId: string; }>());\n\tpublic readonly onModelModeChanged: Event<{ model: ITextModel; oldModeId: string; }> = this._onModelModeChanged.event;\n\n\tprivate _modelCreationOptionsByLanguageAndResource: { [languageAndResource: string]: ITextModelCreationOptions; };\n\n\t/**\n\t * All the models known in the system.\n\t */\n\tprivate readonly _models: { [modelId: string]: ModelData; };\n\tprivate readonly _disposedModels: Map<string, DisposedModelInfo>;\n\tprivate _disposedModelsHeapSize: number;\n\tprivate readonly _semanticStyling: SemanticStyling;\n\n\tconstructor(\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ITextResourcePropertiesService private readonly _resourcePropertiesService: ITextResourcePropertiesService,\n\t\t@IThemeService private readonly _themeService: IThemeService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IUndoRedoService private readonly _undoRedoService: IUndoRedoService,\n\t) {\n\t\tsuper();\n\t\tthis._modelCreationOptionsByLanguageAndResource = Object.create(null);\n\t\tthis._models = {};\n\t\tthis._disposedModels = new Map<string, DisposedModelInfo>();\n\t\tthis._disposedModelsHeapSize = 0;\n\t\tthis._semanticStyling = this._register(new SemanticStyling(this._themeService, this._logService));\n\n\t\tthis._register(this._configurationService.onDidChangeConfiguration(() => this._updateModelOptions()));\n\t\tthis._updateModelOptions();\n\n\t\tthis._register(new SemanticColoringFeature(this, this._themeService, this._configurationService, this._semanticStyling));\n\t}\n\n\tprivate static _readModelOptions(config: IRawConfig, isForSimpleWidget: boolean): ITextModelCreationOptions {\n\t\tlet tabSize = EDITOR_MODEL_DEFAULTS.tabSize;\n\t\tif (config.editor && typeof config.editor.tabSize !== 'undefined') {\n\t\t\tconst parsedTabSize = parseInt(config.editor.tabSize, 10);\n\t\t\tif (!isNaN(parsedTabSize)) {\n\t\t\t\ttabSize = parsedTabSize;\n\t\t\t}\n\t\t\tif (tabSize < 1) {\n\t\t\t\ttabSize = 1;\n\t\t\t}\n\t\t}\n\n\t\tlet indentSize = tabSize;\n\t\tif (config.editor && typeof config.editor.indentSize !== 'undefined' && config.editor.indentSize !== 'tabSize') {\n\t\t\tconst parsedIndentSize = parseInt(config.editor.indentSize, 10);\n\t\t\tif (!isNaN(parsedIndentSize)) {\n\t\t\t\tindentSize = parsedIndentSize;\n\t\t\t}\n\t\t\tif (indentSize < 1) {\n\t\t\t\tindentSize = 1;\n\t\t\t}\n\t\t}\n\n\t\tlet insertSpaces = EDITOR_MODEL_DEFAULTS.insertSpaces;\n\t\tif (config.editor && typeof config.editor.insertSpaces !== 'undefined') {\n\t\t\tinsertSpaces = (config.editor.insertSpaces === 'false' ? false : Boolean(config.editor.insertSpaces));\n\t\t}\n\n\t\tlet newDefaultEOL = DEFAULT_EOL;\n\t\tconst eol = config.eol;\n\t\tif (eol === '\\r\\n') {\n\t\t\tnewDefaultEOL = DefaultEndOfLine.CRLF;\n\t\t} else if (eol === '\\n') {\n\t\t\tnewDefaultEOL = DefaultEndOfLine.LF;\n\t\t}\n\n\t\tlet trimAutoWhitespace = EDITOR_MODEL_DEFAULTS.trimAutoWhitespace;\n\t\tif (config.editor && typeof config.editor.trimAutoWhitespace !== 'undefined') {\n\t\t\ttrimAutoWhitespace = (config.editor.trimAutoWhitespace === 'false' ? false : Boolean(config.editor.trimAutoWhitespace));\n\t\t}\n\n\t\tlet detectIndentation = EDITOR_MODEL_DEFAULTS.detectIndentation;\n\t\tif (config.editor && typeof config.editor.detectIndentation !== 'undefined') {\n\t\t\tdetectIndentation = (config.editor.detectIndentation === 'false' ? false : Boolean(config.editor.detectIndentation));\n\t\t}\n\n\t\tlet largeFileOptimizations = EDITOR_MODEL_DEFAULTS.largeFileOptimizations;\n\t\tif (config.editor && typeof config.editor.largeFileOptimizations !== 'undefined') {\n\t\t\tlargeFileOptimizations = (config.editor.largeFileOptimizations === 'false' ? false : Boolean(config.editor.largeFileOptimizations));\n\t\t}\n\n\t\treturn {\n\t\t\tisForSimpleWidget: isForSimpleWidget,\n\t\t\ttabSize: tabSize,\n\t\t\tindentSize: indentSize,\n\t\t\tinsertSpaces: insertSpaces,\n\t\t\tdetectIndentation: detectIndentation,\n\t\t\tdefaultEOL: newDefaultEOL,\n\t\t\ttrimAutoWhitespace: trimAutoWhitespace,\n\t\t\tlargeFileOptimizations: largeFileOptimizations\n\t\t};\n\t}\n\n\tprivate _getEOL(resource: URI | undefined, language: string): string {\n\t\tif (resource) {\n\t\t\treturn this._resourcePropertiesService.getEOL(resource, language);\n\t\t}\n\t\tconst eol = this._configurationService.getValue<string>('files.eol', { overrideIdentifier: language });\n\t\tif (eol && eol !== 'auto') {\n\t\t\treturn eol;\n\t\t}\n\t\treturn platform.OS === platform.OperatingSystem.Linux || platform.OS === platform.OperatingSystem.Macintosh ? '\\n' : '\\r\\n';\n\t}\n\n\tprivate _shouldRestoreUndoStack(): boolean {\n\t\tconst result = this._configurationService.getValue<boolean>('files.restoreUndoStack');\n\t\tif (typeof result === 'boolean') {\n\t\t\treturn result;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic getCreationOptions(language: string, resource: URI | undefined, isForSimpleWidget: boolean): ITextModelCreationOptions {\n\t\tlet creationOptions = this._modelCreationOptionsByLanguageAndResource[language + resource];\n\t\tif (!creationOptions) {\n\t\t\tconst editor = this._configurationService.getValue<IRawEditorConfig>('editor', { overrideIdentifier: language, resource });\n\t\t\tconst eol = this._getEOL(resource, language);\n\t\t\tcreationOptions = ModelServiceImpl._readModelOptions({ editor, eol }, isForSimpleWidget);\n\t\t\tthis._modelCreationOptionsByLanguageAndResource[language + resource] = creationOptions;\n\t\t}\n\t\treturn creationOptions;\n\t}\n\n\tprivate _updateModelOptions(): void {\n\t\tconst oldOptionsByLanguageAndResource = this._modelCreationOptionsByLanguageAndResource;\n\t\tthis._modelCreationOptionsByLanguageAndResource = Object.create(null);\n\n\t\t// Update options on all models\n\t\tconst keys = Object.keys(this._models);\n\t\tfor (let i = 0, len = keys.length; i < len; i++) {\n\t\t\tconst modelId = keys[i];\n\t\t\tconst modelData = this._models[modelId];\n\t\t\tconst language = modelData.model.getLanguageIdentifier().language;\n\t\t\tconst uri = modelData.model.uri;\n\t\t\tconst oldOptions = oldOptionsByLanguageAndResource[language + uri];\n\t\t\tconst newOptions = this.getCreationOptions(language, uri, modelData.model.isForSimpleWidget);\n\t\t\tModelServiceImpl._setModelOptionsForModel(modelData.model, newOptions, oldOptions);\n\t\t}\n\t}\n\n\tprivate static _setModelOptionsForModel(model: ITextModel, newOptions: ITextModelCreationOptions, currentOptions: ITextModelCreationOptions): void {\n\t\tif (currentOptions && currentOptions.defaultEOL !== newOptions.defaultEOL && model.getLineCount() === 1) {\n\t\t\tmodel.setEOL(newOptions.defaultEOL === DefaultEndOfLine.LF ? EndOfLineSequence.LF : EndOfLineSequence.CRLF);\n\t\t}\n\n\t\tif (currentOptions\n\t\t\t&& (currentOptions.detectIndentation === newOptions.detectIndentation)\n\t\t\t&& (currentOptions.insertSpaces === newOptions.insertSpaces)\n\t\t\t&& (currentOptions.tabSize === newOptions.tabSize)\n\t\t\t&& (currentOptions.indentSize === newOptions.indentSize)\n\t\t\t&& (currentOptions.trimAutoWhitespace === newOptions.trimAutoWhitespace)\n\t\t) {\n\t\t\t// Same indent opts, no need to touch the model\n\t\t\treturn;\n\t\t}\n\n\t\tif (newOptions.detectIndentation) {\n\t\t\tmodel.detectIndentation(newOptions.insertSpaces, newOptions.tabSize);\n\t\t\tmodel.updateOptions({\n\t\t\t\ttrimAutoWhitespace: newOptions.trimAutoWhitespace\n\t\t\t});\n\t\t} else {\n\t\t\tmodel.updateOptions({\n\t\t\t\tinsertSpaces: newOptions.insertSpaces,\n\t\t\t\ttabSize: newOptions.tabSize,\n\t\t\t\tindentSize: newOptions.indentSize,\n\t\t\t\ttrimAutoWhitespace: newOptions.trimAutoWhitespace\n\t\t\t});\n\t\t}\n\t}\n\n\t// --- begin IModelService\n\n\tprivate _insertDisposedModel(disposedModelData: DisposedModelInfo): void {\n\t\tthis._disposedModels.set(MODEL_ID(disposedModelData.uri), disposedModelData);\n\t\tthis._disposedModelsHeapSize += disposedModelData.heapSize;\n\t}\n\n\tprivate _removeDisposedModel(resource: URI): DisposedModelInfo | undefined {\n\t\tconst disposedModelData = this._disposedModels.get(MODEL_ID(resource));\n\t\tif (disposedModelData) {\n\t\t\tthis._disposedModelsHeapSize -= disposedModelData.heapSize;\n\t\t}\n\t\tthis._disposedModels.delete(MODEL_ID(resource));\n\t\treturn disposedModelData;\n\t}\n\n\tprivate _ensureDisposedModelsHeapSize(maxModelsHeapSize: number): void {\n\t\tif (this._disposedModelsHeapSize > maxModelsHeapSize) {\n\t\t\t// we must remove some old undo stack elements to free up some memory\n\t\t\tconst disposedModels: DisposedModelInfo[] = [];\n\t\t\tthis._disposedModels.forEach(entry => {\n\t\t\t\tif (!entry.sharesUndoRedoStack) {\n\t\t\t\t\tdisposedModels.push(entry);\n\t\t\t\t}\n\t\t\t});\n\t\t\tdisposedModels.sort((a, b) => a.time - b.time);\n\t\t\twhile (disposedModels.length > 0 && this._disposedModelsHeapSize > maxModelsHeapSize) {\n\t\t\t\tconst disposedModel = disposedModels.shift()!;\n\t\t\t\tthis._removeDisposedModel(disposedModel.uri);\n\t\t\t\tif (disposedModel.initialUndoRedoSnapshot !== null) {\n\t\t\t\t\tthis._undoRedoService.restoreSnapshot(disposedModel.initialUndoRedoSnapshot);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _createModelData(value: string | ITextBufferFactory, languageIdentifier: LanguageIdentifier, resource: URI | undefined, isForSimpleWidget: boolean): ModelData {\n\t\t// create & save the model\n\t\tconst options = this.getCreationOptions(languageIdentifier.language, resource, isForSimpleWidget);\n\t\tconst model: TextModel = new TextModel(value, options, languageIdentifier, resource, this._undoRedoService);\n\t\tif (resource && this._disposedModels.has(MODEL_ID(resource))) {\n\t\t\tconst disposedModelData = this._removeDisposedModel(resource)!;\n\t\t\tconst elements = this._undoRedoService.getElements(resource);\n\t\t\tconst sha1IsEqual = (computeModelSha1(model) === disposedModelData.sha1);\n\t\t\tif (sha1IsEqual || disposedModelData.sharesUndoRedoStack) {\n\t\t\t\tfor (const element of elements.past) {\n\t\t\t\t\tif (isEditStackElement(element) && element.matchesResource(resource)) {\n\t\t\t\t\t\telement.setModel(model);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (const element of elements.future) {\n\t\t\t\t\tif (isEditStackElement(element) && element.matchesResource(resource)) {\n\t\t\t\t\t\telement.setModel(model);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis._undoRedoService.setElementsValidFlag(resource, true, (element) => (isEditStackElement(element) && element.matchesResource(resource)));\n\t\t\t\tif (sha1IsEqual) {\n\t\t\t\t\tmodel._overwriteVersionId(disposedModelData.versionId);\n\t\t\t\t\tmodel._overwriteAlternativeVersionId(disposedModelData.alternativeVersionId);\n\t\t\t\t\tmodel._overwriteInitialUndoRedoSnapshot(disposedModelData.initialUndoRedoSnapshot);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (disposedModelData.initialUndoRedoSnapshot !== null) {\n\t\t\t\t\tthis._undoRedoService.restoreSnapshot(disposedModelData.initialUndoRedoSnapshot);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tconst modelId = MODEL_ID(model.uri);\n\n\t\tif (this._models[modelId]) {\n\t\t\t// There already exists a model with this id => this is a programmer error\n\t\t\tthrow new Error('ModelService: Cannot add model because it already exists!');\n\t\t}\n\n\t\tconst modelData = new ModelData(\n\t\t\tmodel,\n\t\t\t(model) => this._onWillDispose(model),\n\t\t\t(model, e) => this._onDidChangeLanguage(model, e)\n\t\t);\n\t\tthis._models[modelId] = modelData;\n\n\t\treturn modelData;\n\t}\n\n\tpublic updateModel(model: ITextModel, value: string | ITextBufferFactory): void {\n\t\tconst options = this.getCreationOptions(model.getLanguageIdentifier().language, model.uri, model.isForSimpleWidget);\n\t\tconst { textBuffer, disposable } = createTextBuffer(value, options.defaultEOL);\n\n\t\t// Return early if the text is already set in that form\n\t\tif (model.equalsTextBuffer(textBuffer)) {\n\t\t\tdisposable.dispose();\n\t\t\treturn;\n\t\t}\n\n\t\t// Otherwise find a diff between the values and update model\n\t\tmodel.pushStackElement();\n\t\tmodel.pushEOL(textBuffer.getEOL() === '\\r\\n' ? EndOfLineSequence.CRLF : EndOfLineSequence.LF);\n\t\tmodel.pushEditOperations(\n\t\t\t[],\n\t\t\tModelServiceImpl._computeEdits(model, textBuffer),\n\t\t\t() => []\n\t\t);\n\t\tmodel.pushStackElement();\n\t\tdisposable.dispose();\n\t}\n\n\tprivate static _commonPrefix(a: ILineSequence, aLen: number, aDelta: number, b: ILineSequence, bLen: number, bDelta: number): number {\n\t\tconst maxResult = Math.min(aLen, bLen);\n\n\t\tlet result = 0;\n\t\tfor (let i = 0; i < maxResult && a.getLineContent(aDelta + i) === b.getLineContent(bDelta + i); i++) {\n\t\t\tresult++;\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate static _commonSuffix(a: ILineSequence, aLen: number, aDelta: number, b: ILineSequence, bLen: number, bDelta: number): number {\n\t\tconst maxResult = Math.min(aLen, bLen);\n\n\t\tlet result = 0;\n\t\tfor (let i = 0; i < maxResult && a.getLineContent(aDelta + aLen - i) === b.getLineContent(bDelta + bLen - i); i++) {\n\t\t\tresult++;\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * Compute edits to bring `model` to the state of `textSource`.\n\t */\n\tpublic static _computeEdits(model: ITextModel, textBuffer: ITextBuffer): IIdentifiedSingleEditOperation[] {\n\t\tconst modelLineCount = model.getLineCount();\n\t\tconst textBufferLineCount = textBuffer.getLineCount();\n\t\tconst commonPrefix = this._commonPrefix(model, modelLineCount, 1, textBuffer, textBufferLineCount, 1);\n\n\t\tif (modelLineCount === textBufferLineCount && commonPrefix === modelLineCount) {\n\t\t\t// equality case\n\t\t\treturn [];\n\t\t}\n\n\t\tconst commonSuffix = this._commonSuffix(model, modelLineCount - commonPrefix, commonPrefix, textBuffer, textBufferLineCount - commonPrefix, commonPrefix);\n\n\t\tlet oldRange: Range;\n\t\tlet newRange: Range;\n\t\tif (commonSuffix > 0) {\n\t\t\toldRange = new Range(commonPrefix + 1, 1, modelLineCount - commonSuffix + 1, 1);\n\t\t\tnewRange = new Range(commonPrefix + 1, 1, textBufferLineCount - commonSuffix + 1, 1);\n\t\t} else if (commonPrefix > 0) {\n\t\t\toldRange = new Range(commonPrefix, model.getLineMaxColumn(commonPrefix), modelLineCount, model.getLineMaxColumn(modelLineCount));\n\t\t\tnewRange = new Range(commonPrefix, 1 + textBuffer.getLineLength(commonPrefix), textBufferLineCount, 1 + textBuffer.getLineLength(textBufferLineCount));\n\t\t} else {\n\t\t\toldRange = new Range(1, 1, modelLineCount, model.getLineMaxColumn(modelLineCount));\n\t\t\tnewRange = new Range(1, 1, textBufferLineCount, 1 + textBuffer.getLineLength(textBufferLineCount));\n\t\t}\n\n\t\treturn [EditOperation.replaceMove(oldRange, textBuffer.getValueInRange(newRange, EndOfLinePreference.TextDefined))];\n\t}\n\n\tpublic createModel(value: string | ITextBufferFactory, languageSelection: ILanguageSelection | null, resource?: URI, isForSimpleWidget: boolean = false): ITextModel {\n\t\tlet modelData: ModelData;\n\n\t\tif (languageSelection) {\n\t\t\tmodelData = this._createModelData(value, languageSelection.languageIdentifier, resource, isForSimpleWidget);\n\t\t\tthis.setMode(modelData.model, languageSelection);\n\t\t} else {\n\t\t\tmodelData = this._createModelData(value, PLAINTEXT_LANGUAGE_IDENTIFIER, resource, isForSimpleWidget);\n\t\t}\n\n\t\tthis._onModelAdded.fire(modelData.model);\n\n\t\treturn modelData.model;\n\t}\n\n\tpublic setMode(model: ITextModel, languageSelection: ILanguageSelection): void {\n\t\tif (!languageSelection) {\n\t\t\treturn;\n\t\t}\n\t\tconst modelData = this._models[MODEL_ID(model.uri)];\n\t\tif (!modelData) {\n\t\t\treturn;\n\t\t}\n\t\tmodelData.setLanguage(languageSelection);\n\t}\n\n\tpublic destroyModel(resource: URI): void {\n\t\t// We need to support that not all models get disposed through this service (i.e. model.dispose() should work!)\n\t\tconst modelData = this._models[MODEL_ID(resource)];\n\t\tif (!modelData) {\n\t\t\treturn;\n\t\t}\n\t\tmodelData.model.dispose();\n\t}\n\n\tpublic getModels(): ITextModel[] {\n\t\tconst ret: ITextModel[] = [];\n\n\t\tconst keys = Object.keys(this._models);\n\t\tfor (let i = 0, len = keys.length; i < len; i++) {\n\t\t\tconst modelId = keys[i];\n\t\t\tret.push(this._models[modelId].model);\n\t\t}\n\n\t\treturn ret;\n\t}\n\n\tpublic getModel(resource: URI): ITextModel | null {\n\t\tconst modelId = MODEL_ID(resource);\n\t\tconst modelData = this._models[modelId];\n\t\tif (!modelData) {\n\t\t\treturn null;\n\t\t}\n\t\treturn modelData.model;\n\t}\n\n\tpublic getSemanticTokensProviderStyling(provider: DocumentTokensProvider): SemanticTokensProviderStyling {\n\t\treturn this._semanticStyling.get(provider);\n\t}\n\n\t// --- end IModelService\n\n\tprivate _onWillDispose(model: ITextModel): void {\n\t\tconst modelId = MODEL_ID(model.uri);\n\t\tconst modelData = this._models[modelId];\n\n\t\tconst sharesUndoRedoStack = (this._undoRedoService.getUriComparisonKey(model.uri) !== model.uri.toString());\n\t\tlet maintainUndoRedoStack = false;\n\t\tlet heapSize = 0;\n\t\tif (sharesUndoRedoStack || (this._shouldRestoreUndoStack() && schemaShouldMaintainUndoRedoElements(model.uri))) {\n\t\t\tconst elements = this._undoRedoService.getElements(model.uri);\n\t\t\tif (elements.past.length > 0 || elements.future.length > 0) {\n\t\t\t\tfor (const element of elements.past) {\n\t\t\t\t\tif (isEditStackElement(element) && element.matchesResource(model.uri)) {\n\t\t\t\t\t\tmaintainUndoRedoStack = true;\n\t\t\t\t\t\theapSize += element.heapSize(model.uri);\n\t\t\t\t\t\telement.setModel(model.uri); // remove reference from text buffer instance\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (const element of elements.future) {\n\t\t\t\t\tif (isEditStackElement(element) && element.matchesResource(model.uri)) {\n\t\t\t\t\t\tmaintainUndoRedoStack = true;\n\t\t\t\t\t\theapSize += element.heapSize(model.uri);\n\t\t\t\t\t\telement.setModel(model.uri); // remove reference from text buffer instance\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst maxMemory = ModelServiceImpl.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK;\n\t\tif (!maintainUndoRedoStack) {\n\t\t\tif (!sharesUndoRedoStack) {\n\t\t\t\tconst initialUndoRedoSnapshot = modelData.model.getInitialUndoRedoSnapshot();\n\t\t\t\tif (initialUndoRedoSnapshot !== null) {\n\t\t\t\t\tthis._undoRedoService.restoreSnapshot(initialUndoRedoSnapshot);\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (!sharesUndoRedoStack && heapSize > maxMemory) {\n\t\t\t// the undo stack for this file would never fit in the configured memory, so don't bother with it.\n\t\t\tconst initialUndoRedoSnapshot = modelData.model.getInitialUndoRedoSnapshot();\n\t\t\tif (initialUndoRedoSnapshot !== null) {\n\t\t\t\tthis._undoRedoService.restoreSnapshot(initialUndoRedoSnapshot);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._ensureDisposedModelsHeapSize(maxMemory - heapSize);\n\t\t\t// We only invalidate the elements, but they remain in the undo-redo service.\n\t\t\tthis._undoRedoService.setElementsValidFlag(model.uri, false, (element) => (isEditStackElement(element) && element.matchesResource(model.uri)));\n\t\t\tthis._insertDisposedModel(new DisposedModelInfo(model.uri, modelData.model.getInitialUndoRedoSnapshot(), Date.now(), sharesUndoRedoStack, heapSize, computeModelSha1(model), model.getVersionId(), model.getAlternativeVersionId()));\n\t\t}\n\n\t\tdelete this._models[modelId];\n\t\tmodelData.dispose();\n\n\t\t// clean up cache\n\t\tdelete this._modelCreationOptionsByLanguageAndResource[model.getLanguageIdentifier().language + model.uri];\n\n\t\tthis._onModelRemoved.fire(model);\n\t}\n\n\tprivate _onDidChangeLanguage(model: ITextModel, e: IModelLanguageChangedEvent): void {\n\t\tconst oldModeId = e.oldLanguage;\n\t\tconst newModeId = model.getLanguageIdentifier().language;\n\t\tconst oldOptions = this.getCreationOptions(oldModeId, model.uri, model.isForSimpleWidget);\n\t\tconst newOptions = this.getCreationOptions(newModeId, model.uri, model.isForSimpleWidget);\n\t\tModelServiceImpl._setModelOptionsForModel(model, newOptions, oldOptions);\n\t\tthis._onModelModeChanged.fire({ model, oldModeId });\n\t}\n}\n\nexport interface ILineSequence {\n\tgetLineContent(lineNumber: number): string;\n}\n\nexport const SEMANTIC_HIGHLIGHTING_SETTING_ID = 'editor.semanticHighlighting';\n\nexport function isSemanticColoringEnabled(model: ITextModel, themeService: IThemeService, configurationService: IConfigurationService): boolean {\n\tconst setting = configurationService.getValue<IEditorSemanticHighlightingOptions>(SEMANTIC_HIGHLIGHTING_SETTING_ID, { overrideIdentifier: model.getLanguageIdentifier().language, resource: model.uri })?.enabled;\n\tif (typeof setting === 'boolean') {\n\t\treturn setting;\n\t}\n\treturn themeService.getColorTheme().semanticHighlighting;\n}\n\nclass SemanticColoringFeature extends Disposable {\n\n\tprivate readonly _watchers: Record<string, ModelSemanticColoring>;\n\tprivate readonly _semanticStyling: SemanticStyling;\n\n\tconstructor(modelService: IModelService, themeService: IThemeService, configurationService: IConfigurationService, semanticStyling: SemanticStyling) {\n\t\tsuper();\n\t\tthis._watchers = Object.create(null);\n\t\tthis._semanticStyling = semanticStyling;\n\n\t\tconst register = (model: ITextModel) => {\n\t\t\tthis._watchers[model.uri.toString()] = new ModelSemanticColoring(model, themeService, this._semanticStyling);\n\t\t};\n\t\tconst deregister = (model: ITextModel, modelSemanticColoring: ModelSemanticColoring) => {\n\t\t\tmodelSemanticColoring.dispose();\n\t\t\tdelete this._watchers[model.uri.toString()];\n\t\t};\n\t\tconst handleSettingOrThemeChange = () => {\n\t\t\tfor (let model of modelService.getModels()) {\n\t\t\t\tconst curr = this._watchers[model.uri.toString()];\n\t\t\t\tif (isSemanticColoringEnabled(model, themeService, configurationService)) {\n\t\t\t\t\tif (!curr) {\n\t\t\t\t\t\tregister(model);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (curr) {\n\t\t\t\t\t\tderegister(model, curr);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tthis._register(modelService.onModelAdded((model) => {\n\t\t\tif (isSemanticColoringEnabled(model, themeService, configurationService)) {\n\t\t\t\tregister(model);\n\t\t\t}\n\t\t}));\n\t\tthis._register(modelService.onModelRemoved((model) => {\n\t\t\tconst curr = this._watchers[model.uri.toString()];\n\t\t\tif (curr) {\n\t\t\t\tderegister(model, curr);\n\t\t\t}\n\t\t}));\n\t\tthis._register(configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(SEMANTIC_HIGHLIGHTING_SETTING_ID)) {\n\t\t\t\thandleSettingOrThemeChange();\n\t\t\t}\n\t\t}));\n\t\tthis._register(themeService.onDidColorThemeChange(handleSettingOrThemeChange));\n\t}\n}\n\nclass SemanticStyling extends Disposable {\n\n\tprivate _caches: WeakMap<DocumentTokensProvider, SemanticTokensProviderStyling>;\n\n\tconstructor(\n\t\tprivate readonly _themeService: IThemeService,\n\t\tprivate readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\t\tthis._caches = new WeakMap<DocumentTokensProvider, SemanticTokensProviderStyling>();\n\t\tthis._register(this._themeService.onDidColorThemeChange(() => {\n\t\t\tthis._caches = new WeakMap<DocumentTokensProvider, SemanticTokensProviderStyling>();\n\t\t}));\n\t}\n\n\tpublic get(provider: DocumentTokensProvider): SemanticTokensProviderStyling {\n\t\tif (!this._caches.has(provider)) {\n\t\t\tthis._caches.set(provider, new SemanticTokensProviderStyling(provider.getLegend(), this._themeService, this._logService));\n\t\t}\n\t\treturn this._caches.get(provider)!;\n\t}\n}\n\nclass SemanticTokensResponse {\n\tconstructor(\n\t\tprivate readonly _provider: DocumentSemanticTokensProvider,\n\t\tpublic readonly resultId: string | undefined,\n\t\tpublic readonly data: Uint32Array\n\t) { }\n\n\tpublic dispose(): void {\n\t\tthis._provider.releaseDocumentSemanticTokens(this.resultId);\n\t}\n}\n\nexport class ModelSemanticColoring extends Disposable {\n\n\tpublic static FETCH_DOCUMENT_SEMANTIC_TOKENS_DELAY = 300;\n\n\tprivate _isDisposed: boolean;\n\tprivate readonly _model: ITextModel;\n\tprivate readonly _semanticStyling: SemanticStyling;\n\tprivate readonly _fetchDocumentSemanticTokens: RunOnceScheduler;\n\tprivate _currentDocumentResponse: SemanticTokensResponse | null;\n\tprivate _currentDocumentRequestCancellationTokenSource: CancellationTokenSource | null;\n\tprivate _documentProvidersChangeListeners: IDisposable[];\n\n\tconstructor(model: ITextModel, themeService: IThemeService, stylingProvider: SemanticStyling) {\n\t\tsuper();\n\n\t\tthis._isDisposed = false;\n\t\tthis._model = model;\n\t\tthis._semanticStyling = stylingProvider;\n\t\tthis._fetchDocumentSemanticTokens = this._register(new RunOnceScheduler(() => this._fetchDocumentSemanticTokensNow(), ModelSemanticColoring.FETCH_DOCUMENT_SEMANTIC_TOKENS_DELAY));\n\t\tthis._currentDocumentResponse = null;\n\t\tthis._currentDocumentRequestCancellationTokenSource = null;\n\t\tthis._documentProvidersChangeListeners = [];\n\n\t\tthis._register(this._model.onDidChangeContent(() => {\n\t\t\tif (!this._fetchDocumentSemanticTokens.isScheduled()) {\n\t\t\t\tthis._fetchDocumentSemanticTokens.schedule();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._model.onDidChangeLanguage(() => {\n\t\t\t// clear any outstanding state\n\t\t\tif (this._currentDocumentResponse) {\n\t\t\t\tthis._currentDocumentResponse.dispose();\n\t\t\t\tthis._currentDocumentResponse = null;\n\t\t\t}\n\t\t\tif (this._currentDocumentRequestCancellationTokenSource) {\n\t\t\t\tthis._currentDocumentRequestCancellationTokenSource.cancel();\n\t\t\t\tthis._currentDocumentRequestCancellationTokenSource = null;\n\t\t\t}\n\t\t\tthis._setDocumentSemanticTokens(null, null, null, []);\n\t\t\tthis._fetchDocumentSemanticTokens.schedule(0);\n\t\t}));\n\t\tconst bindDocumentChangeListeners = () => {\n\t\t\tdispose(this._documentProvidersChangeListeners);\n\t\t\tthis._documentProvidersChangeListeners = [];\n\t\t\tfor (const provider of DocumentSemanticTokensProviderRegistry.all(model)) {\n\t\t\t\tif (typeof provider.onDidChange === 'function') {\n\t\t\t\t\tthis._documentProvidersChangeListeners.push(provider.onDidChange(() => this._fetchDocumentSemanticTokens.schedule(0)));\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tbindDocumentChangeListeners();\n\t\tthis._register(DocumentSemanticTokensProviderRegistry.onDidChange(() => {\n\t\t\tbindDocumentChangeListeners();\n\t\t\tthis._fetchDocumentSemanticTokens.schedule();\n\t\t}));\n\n\t\tthis._register(themeService.onDidColorThemeChange(_ => {\n\t\t\t// clear out existing tokens\n\t\t\tthis._setDocumentSemanticTokens(null, null, null, []);\n\t\t\tthis._fetchDocumentSemanticTokens.schedule();\n\t\t}));\n\n\t\tthis._fetchDocumentSemanticTokens.schedule(0);\n\t}\n\n\tpublic override dispose(): void {\n\t\tif (this._currentDocumentResponse) {\n\t\t\tthis._currentDocumentResponse.dispose();\n\t\t\tthis._currentDocumentResponse = null;\n\t\t}\n\t\tif (this._currentDocumentRequestCancellationTokenSource) {\n\t\t\tthis._currentDocumentRequestCancellationTokenSource.cancel();\n\t\t\tthis._currentDocumentRequestCancellationTokenSource = null;\n\t\t}\n\t\tthis._setDocumentSemanticTokens(null, null, null, []);\n\t\tthis._isDisposed = true;\n\n\t\tsuper.dispose();\n\t}\n\n\tprivate _fetchDocumentSemanticTokensNow(): void {\n\t\tif (this._currentDocumentRequestCancellationTokenSource) {\n\t\t\t// there is already a request running, let it finish...\n\t\t\treturn;\n\t\t}\n\n\t\tconst cancellationTokenSource = new CancellationTokenSource();\n\t\tconst lastResultId = this._currentDocumentResponse ? this._currentDocumentResponse.resultId || null : null;\n\t\tconst r = getDocumentSemanticTokens(this._model, lastResultId, cancellationTokenSource.token);\n\t\tif (!r) {\n\t\t\t// there is no provider\n\t\t\tif (this._currentDocumentResponse) {\n\t\t\t\t// there are semantic tokens set\n\t\t\t\tthis._model.setSemanticTokens(null, false);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst { provider, request } = r;\n\t\tthis._currentDocumentRequestCancellationTokenSource = cancellationTokenSource;\n\n\t\tconst pendingChanges: IModelContentChangedEvent[] = [];\n\t\tconst contentChangeListener = this._model.onDidChangeContent((e) => {\n\t\t\tpendingChanges.push(e);\n\t\t});\n\n\t\tconst styling = this._semanticStyling.get(provider);\n\n\t\trequest.then((res) => {\n\t\t\tthis._currentDocumentRequestCancellationTokenSource = null;\n\t\t\tcontentChangeListener.dispose();\n\t\t\tthis._setDocumentSemanticTokens(provider, res || null, styling, pendingChanges);\n\t\t}, (err) => {\n\t\t\tconst isExpectedError = err && (errors.isPromiseCanceledError(err) || (typeof err.message === 'string' && err.message.indexOf('busy') !== -1));\n\t\t\tif (!isExpectedError) {\n\t\t\t\terrors.onUnexpectedError(err);\n\t\t\t}\n\n\t\t\t// Semantic tokens eats up all errors and considers errors to mean that the result is temporarily not available\n\t\t\t// The API does not have a special error kind to express this...\n\t\t\tthis._currentDocumentRequestCancellationTokenSource = null;\n\t\t\tcontentChangeListener.dispose();\n\n\t\t\tif (pendingChanges.length > 0) {\n\t\t\t\t// More changes occurred while the request was running\n\t\t\t\tif (!this._fetchDocumentSemanticTokens.isScheduled()) {\n\t\t\t\t\tthis._fetchDocumentSemanticTokens.schedule();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate static _copy(src: Uint32Array, srcOffset: number, dest: Uint32Array, destOffset: number, length: number): void {\n\t\tfor (let i = 0; i < length; i++) {\n\t\t\tdest[destOffset + i] = src[srcOffset + i];\n\t\t}\n\t}\n\n\tprivate _setDocumentSemanticTokens(provider: DocumentSemanticTokensProvider | null, tokens: SemanticTokens | SemanticTokensEdits | null, styling: SemanticTokensProviderStyling | null, pendingChanges: IModelContentChangedEvent[]): void {\n\t\tconst currentResponse = this._currentDocumentResponse;\n\t\tconst rescheduleIfNeeded = () => {\n\t\t\tif (pendingChanges.length > 0 && !this._fetchDocumentSemanticTokens.isScheduled()) {\n\t\t\t\tthis._fetchDocumentSemanticTokens.schedule();\n\t\t\t}\n\t\t};\n\n\t\tif (this._currentDocumentResponse) {\n\t\t\tthis._currentDocumentResponse.dispose();\n\t\t\tthis._currentDocumentResponse = null;\n\t\t}\n\t\tif (this._isDisposed) {\n\t\t\t// disposed!\n\t\t\tif (provider && tokens) {\n\t\t\t\tprovider.releaseDocumentSemanticTokens(tokens.resultId);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tif (!provider || !styling) {\n\t\t\tthis._model.setSemanticTokens(null, false);\n\t\t\treturn;\n\t\t}\n\t\tif (!tokens) {\n\t\t\tthis._model.setSemanticTokens(null, true);\n\t\t\trescheduleIfNeeded();\n\t\t\treturn;\n\t\t}\n\n\t\tif (isSemanticTokensEdits(tokens)) {\n\t\t\tif (!currentResponse) {\n\t\t\t\t// not possible!\n\t\t\t\tthis._model.setSemanticTokens(null, true);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (tokens.edits.length === 0) {\n\t\t\t\t// nothing to do!\n\t\t\t\ttokens = {\n\t\t\t\t\tresultId: tokens.resultId,\n\t\t\t\t\tdata: currentResponse.data\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tlet deltaLength = 0;\n\t\t\t\tfor (const edit of tokens.edits) {\n\t\t\t\t\tdeltaLength += (edit.data ? edit.data.length : 0) - edit.deleteCount;\n\t\t\t\t}\n\n\t\t\t\tconst srcData = currentResponse.data;\n\t\t\t\tconst destData = new Uint32Array(srcData.length + deltaLength);\n\n\t\t\t\tlet srcLastStart = srcData.length;\n\t\t\t\tlet destLastStart = destData.length;\n\t\t\t\tfor (let i = tokens.edits.length - 1; i >= 0; i--) {\n\t\t\t\t\tconst edit = tokens.edits[i];\n\n\t\t\t\t\tconst copyCount = srcLastStart - (edit.start + edit.deleteCount);\n\t\t\t\t\tif (copyCount > 0) {\n\t\t\t\t\t\tModelSemanticColoring._copy(srcData, srcLastStart - copyCount, destData, destLastStart - copyCount, copyCount);\n\t\t\t\t\t\tdestLastStart -= copyCount;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (edit.data) {\n\t\t\t\t\t\tModelSemanticColoring._copy(edit.data, 0, destData, destLastStart - edit.data.length, edit.data.length);\n\t\t\t\t\t\tdestLastStart -= edit.data.length;\n\t\t\t\t\t}\n\n\t\t\t\t\tsrcLastStart = edit.start;\n\t\t\t\t}\n\n\t\t\t\tif (srcLastStart > 0) {\n\t\t\t\t\tModelSemanticColoring._copy(srcData, 0, destData, 0, srcLastStart);\n\t\t\t\t}\n\n\t\t\t\ttokens = {\n\t\t\t\t\tresultId: tokens.resultId,\n\t\t\t\t\tdata: destData\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tif (isSemanticTokens(tokens)) {\n\n\t\t\tthis._currentDocumentResponse = new SemanticTokensResponse(provider, tokens.resultId, tokens.data);\n\n\t\t\tconst result = toMultilineTokens2(tokens, styling, this._model.getLanguageIdentifier());\n\n\t\t\t// Adjust incoming semantic tokens\n\t\t\tif (pendingChanges.length > 0) {\n\t\t\t\t// More changes occurred while the request was running\n\t\t\t\t// We need to:\n\t\t\t\t// 1. Adjust incoming semantic tokens\n\t\t\t\t// 2. Request them again\n\t\t\t\tfor (const change of pendingChanges) {\n\t\t\t\t\tfor (const area of result) {\n\t\t\t\t\t\tfor (const singleChange of change.changes) {\n\t\t\t\t\t\t\tarea.applyEdit(singleChange.range, singleChange.text);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._model.setSemanticTokens(result, true);\n\t\t} else {\n\t\t\tthis._model.setSemanticTokens(null, true);\n\t\t}\n\n\t\trescheduleIfNeeded();\n\t}\n}\n"]}