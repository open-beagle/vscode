{"version":3,"sources":["vs/workbench/contrib/surveys/browser/ces.contribution.ts"],"names":[],"mappings":"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","file":"ces.contribution.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from 'vs/nls';\nimport { optional } from 'vs/platform/instantiation/common/instantiation';\nimport { language } from 'vs/base/common/platform';\nimport { IWorkbenchContributionsRegistry, IWorkbenchContribution, Extensions as WorkbenchExtensions } from 'vs/workbench/common/contributions';\nimport { Registry } from 'vs/platform/registry/common/platform';\nimport { ITelemetryService } from 'vs/platform/telemetry/common/telemetry';\nimport { IStorageService, StorageScope, StorageTarget } from 'vs/platform/storage/common/storage';\nimport { IProductService } from 'vs/platform/product/common/productService';\nimport { LifecyclePhase } from 'vs/workbench/services/lifecycle/common/lifecycle';\nimport { Severity, INotificationService } from 'vs/platform/notification/common/notification';\nimport { IOpenerService } from 'vs/platform/opener/common/opener';\nimport { ITASExperimentService } from 'vs/workbench/services/experiment/common/experimentService';\nimport { URI } from 'vs/base/common/uri';\nimport { platform } from 'vs/base/common/process';\nimport { ThrottledDelayer } from 'vs/base/common/async';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { Event } from 'vs/base/common/event';\n\nconst WAIT_TIME_TO_SHOW_SURVEY = 1000 * 60 * 60; // 1 hour\nconst MIN_WAIT_TIME_TO_SHOW_SURVEY = 1000 * 60 * 5; // 5 minutes\nconst MAX_INSTALL_AGE = 1000 * 60 * 60 * 24; // 24 hours\nconst REMIND_LATER_DELAY = 1000 * 60 * 60 * 4; // 4 hours\nconst SKIP_SURVEY_KEY = 'ces/skipSurvey';\nconst REMIND_LATER_DATE_KEY = 'ces/remindLaterDate';\n\nclass CESContribution extends Disposable implements IWorkbenchContribution {\n\n\tprivate promptDelayer = this._register(new ThrottledDelayer<void>(0));\n\tprivate readonly tasExperimentService: ITASExperimentService | undefined;\n\n\tconstructor(\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@INotificationService private readonly notificationService: INotificationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t\t@IProductService private readonly productService: IProductService,\n\t\t@optional(ITASExperimentService) tasExperimentService: ITASExperimentService,\n\t) {\n\t\tsuper();\n\n\t\tthis.tasExperimentService = tasExperimentService;\n\n\t\tif (!productService.cesSurveyUrl) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst skipSurvey = storageService.get(SKIP_SURVEY_KEY, StorageScope.GLOBAL, '');\n\t\tif (skipSurvey) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.schedulePrompt();\n\t}\n\n\tprivate async promptUser() {\n\t\tconst sendTelemetry = (userReaction: 'accept' | 'remindLater' | 'neverShowAgain' | 'cancelled') => {\n\t\t\t/* __GDPR__\n\t\t\t\"cesSurvey:popup\" : {\n\t\t\t\t\"userReaction\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" }\n\t\t\t}\n\t\t\t*/\n\t\t\tthis.telemetryService.publicLog('cesSurvey:popup', { userReaction });\n\t\t};\n\n\t\tconst message = await this.tasExperimentService?.getTreatment<string>('CESSurveyMessage') ?? nls.localize('cesSurveyQuestion', 'Got a moment to help the VS Code team? Please tell us about your experience with VS Code so far.');\n\t\tconst button = await this.tasExperimentService?.getTreatment<string>('CESSurveyButton') ?? nls.localize('giveFeedback', \"Give Feedback\");\n\n\t\tconst notification = this.notificationService.prompt(\n\t\t\tSeverity.Info,\n\t\t\tmessage,\n\t\t\t[{\n\t\t\t\tlabel: button,\n\t\t\t\trun: () => {\n\t\t\t\t\tsendTelemetry('accept');\n\t\t\t\t\tthis.telemetryService.getTelemetryInfo().then(info => {\n\t\t\t\t\t\tthis.openerService.open(URI.parse(`${this.productService.cesSurveyUrl}?o=${encodeURIComponent(platform)}&v=${encodeURIComponent(this.productService.version)}&m=${encodeURIComponent(info.machineId)}}`));\n\t\t\t\t\t\tthis.skipSurvey();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tlabel: nls.localize('remindLater', \"Remind Me later\"),\n\t\t\t\trun: () => {\n\t\t\t\t\tsendTelemetry('remindLater');\n\t\t\t\t\tthis.storageService.store(REMIND_LATER_DATE_KEY, new Date().toUTCString(), StorageScope.GLOBAL, StorageTarget.USER);\n\t\t\t\t\tthis.schedulePrompt();\n\t\t\t\t}\n\t\t\t}],\n\t\t\t{\n\t\t\t\tsticky: true,\n\t\t\t\tonCancel: () => {\n\t\t\t\t\tsendTelemetry('cancelled');\n\t\t\t\t\tthis.skipSurvey();\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\tawait Event.toPromise(notification.onDidClose);\n\t}\n\n\tprivate async schedulePrompt(): Promise<void> {\n\t\tconst isCandidate = await this.tasExperimentService?.getTreatment<boolean>('CESSurvey');\n\t\tif (!isCandidate) {\n\t\t\tthis.skipSurvey();\n\t\t\treturn;\n\t\t}\n\n\t\tlet waitTimeToShowSurvey = 0;\n\t\tconst remindLaterDate = this.storageService.get(REMIND_LATER_DATE_KEY, StorageScope.GLOBAL, '');\n\t\tif (remindLaterDate) {\n\t\t\tconst timeToRemind = new Date(remindLaterDate).getTime() + REMIND_LATER_DELAY - Date.now();\n\t\t\tif (timeToRemind > 0) {\n\t\t\t\twaitTimeToShowSurvey = timeToRemind;\n\t\t\t}\n\t\t} else {\n\t\t\tconst info = await this.telemetryService.getTelemetryInfo();\n\t\t\tconst timeFromInstall = Date.now() - new Date(info.firstSessionDate).getTime();\n\t\t\tconst isNewInstall = !isNaN(timeFromInstall) && timeFromInstall < MAX_INSTALL_AGE;\n\n\t\t\t// Installation is older than MAX_INSTALL_AGE\n\t\t\tif (!isNewInstall) {\n\t\t\t\tthis.skipSurvey();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (timeFromInstall < WAIT_TIME_TO_SHOW_SURVEY) {\n\t\t\t\twaitTimeToShowSurvey = WAIT_TIME_TO_SHOW_SURVEY - timeFromInstall;\n\t\t\t}\n\t\t}\n\t\t/* __GDPR__\n\t\t\"cesSurvey:schedule\" : { }\n\t\t*/\n\t\tthis.telemetryService.publicLog('cesSurvey:schedule');\n\n\t\tthis.promptDelayer.trigger(async () => {\n\t\t\tawait this.promptUser();\n\t\t}, Math.max(waitTimeToShowSurvey, MIN_WAIT_TIME_TO_SHOW_SURVEY));\n\t}\n\n\tprivate skipSurvey(): void {\n\t\tthis.storageService.store(SKIP_SURVEY_KEY, this.productService.version, StorageScope.GLOBAL, StorageTarget.USER);\n\t}\n}\n\nif (language === 'en') {\n\tconst workbenchRegistry = Registry.as<IWorkbenchContributionsRegistry>(WorkbenchExtensions.Workbench);\n\tworkbenchRegistry.registerWorkbenchContribution(CESContribution, LifecyclePhase.Restored);\n}\n"]}