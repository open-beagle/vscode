{"version":3,"file":"telemetry.contribution.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/workbench/contrib/telemetry/browser/telemetry.contribution.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;;;;;IAyChG,IAAa,qBAAqB,GAAlC,MAAa,qBAAsB,SAAQ,sBAAU;QAKpD,YACqC,gBAAmC,EAC5B,cAAwC,EAC9D,kBAAuC,EACzC,gBAAmC,EACtC,aAA6B,EACzB,kBAAsC,EAClC,YAAoC,EACb,kBAAgD,EACxE,oBAA2C,EACjD,cAA+B,EAC9B,eAAiC;YAEnD,KAAK,EAAE,CAAC;YAZ4B,qBAAgB,GAAhB,gBAAgB,CAAmB;YAC5B,mBAAc,GAAd,cAAc,CAA0B;YAMpC,uBAAkB,GAAlB,kBAAkB,CAA8B;YAO/F,MAAM,EAAE,mBAAmB,EAAE,WAAW,EAAE,GAAG,kBAAkB,CAAC,aAAa,CAAC;YAC9E,MAAM,aAAa,GAAG,cAAc,CAAC,gBAAgB,EAAE,CAAC;YAuCxD,gBAAgB,CAAC,UAAU,CAAkD,eAAe,EAAE;gBAC7F,SAAS,EAAE,SAAS,CAAC,SAAS;gBAC9B,UAAU,EAAE,EAAE,WAAW,EAAE,MAAM,CAAC,WAAW,EAAE,UAAU,EAAE,MAAM,CAAC,UAAU,EAAE,WAAW,EAAE,MAAM,CAAC,WAAW,EAAE,UAAU,EAAE,MAAM,CAAC,UAAU,EAAE;gBAC9I,cAAc,EAAE,cAAc,CAAC,iBAAiB,EAAE,kBAAyB;gBAC3E,+BAA+B,EAAE,mBAAmB,IAAI,mBAAmB,CAAC,MAAM,IAAI,CAAC;gBACvF,uBAAuB,EAAE,WAAW,IAAI,WAAW,CAAC,MAAM,IAAI,CAAC;gBAC/D,sBAAsB,EAAE,kBAAkB,CAAC,sBAAsB,EAAE;gBACnE,KAAK,EAAE,YAAY,CAAC,aAAa,EAAE,CAAC,EAAE;gBACtC,QAAQ,EAAR,mBAAQ;gBACR,cAAc,EAAE,kBAAkB,CAAC,yBAAyB,EAAE;gBAC9D,eAAe,EAAE,aAAa,CAAC,CAAC,CAAC,aAAa,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,SAAS;gBAClE,eAAe,EAAE,aAAa,CAAC,cAAc,CAAC,MAAM;gBACpD,WAAW,EAAE,gBAAgB,CAAC,WAAW;aACzC,CAAC,CAAC;YAEH,kBAAkB;YAClB,IAAI,CAAC,SAAS,CAAC,IAAI,wBAAc,CAAC,gBAAgB,CAAC,CAAC,CAAC;YAErD,0BAA0B;YAC1B,IAAI,CAAC,SAAS,CAAC,CAAA,GAAA,uCAAsB,CAAA,CAAC,gBAAgB,EAAE,oBAAoB,CAAC,CAAC,CAAC;YAE/E,mBAAmB;YACnB,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YACzF,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAEnF,YAAY;YACZ,IAAI,CAAC,SAAS,CAAC,gBAAgB,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;QACtE,CAAC;QAEO,uBAAuB,CAAC,CAAwB;YACvD,MAAM,YAAY,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;YAC9D,IAAI,YAAY,EAAE;gBAKjB,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAuD,cAAc,EAAE,EAAE,YAAY,EAAE,CAAC,CAAC,CAAC,8GAA8G;aACxO;iBAAM;gBAGN,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAuC,SAAS,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;aACrI;QACF,CAAC;QAEO,oBAAoB,CAAC,CAAqB;YACjD,MAAM,YAAY,GAAG,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;YAC9D,IAAI,YAAY,EAAE;gBAIjB,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAA0D,iBAAiB,EAAE,EAAE,YAAY,EAAE,CAAC,CAAC,CAAC,+GAA+G;aAC/O;iBAAM;gBAEN,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAsC,SAAS,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;aACpI;QACF,CAAC;QAEO,iBAAiB,CAAC,QAAa;YACtC,IAAI,CAAA,GAAA,mBAAO,CAAA,CAAC,QAAQ,CAAC,KAAK,OAAO,EAAE;gBAClC,OAAO,EAAE,CAAC;aACV;YAED,iCAAiC;YACjC,IAAI,CAAA,GAAA,mBAAO,CAAA,CAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,CAAC,EAAE;gBAChE,OAAO,iBAAiB,CAAC;aACzB;YAED,6BAA6B;YAC7B,IAAI,CAAA,GAAA,mBAAO,CAAA,CAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,CAAC,mBAAmB,CAAC,EAAE;gBACnE,OAAO,aAAa,CAAC;aACrB;YAED,qBAAqB;YACrB,IAAI,CAAA,GAAA,2BAAe,CAAA,CAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,CAAC,YAAY,CAAC,EAAE;gBACpE,OAAO,UAAU,CAAC;aAClB;YAED,oCAAoC;YACpC,MAAM,OAAO,GAAG,IAAI,CAAC,cAAc,CAAC,YAAY,EAAE,CAAC,OAAO,CAAC;YAC3D,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE;gBAC7B,IAAI,CAAA,GAAA,2BAAe,CAAA,CAAC,QAAQ,EAAE,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,EAAE;oBAC5D,MAAM,QAAQ,GAAG,CAAA,GAAA,oBAAQ,CAAA,CAAC,QAAQ,CAAC,CAAC;oBACpC,IAAI,qBAAqB,CAAC,wBAAwB,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,EAAE;wBAC1E,OAAO,WAAW,QAAQ,EAAE,CAAC;qBAC7B;iBACD;aACD;YAED,OAAO,EAAE,CAAC;QACX,CAAC;QAEO,gBAAgB,CAAC,QAAa,EAAE,MAAe;YACtD,MAAM,GAAG,GAAG,CAAA,GAAA,mBAAO,CAAA,CAAC,QAAQ,CAAC,CAAC;YAC9B,MAAM,QAAQ,GAAG,CAAA,GAAA,oBAAQ,CAAA,CAAC,QAAQ,CAAC,CAAC;YACpC,MAAM,IAAI,GAAG,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC;YAChF,MAAM,aAAa,GAAG;gBACrB,QAAQ,EAAE,CAAA,GAAA,qBAAc,CAAA,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC;gBAC7C,GAAG;gBACH,IAAI,EAAE,CAAA,GAAA,WAAI,CAAA,CAAC,IAAI,CAAC;gBAChB,MAAM;gBACN,eAAe,EAAE,SAA+B;aAChD,CAAC;YAEF,IAAI,GAAG,KAAK,OAAO,IAAI,qBAAqB,CAAC,cAAc,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,EAAE;gBACnF,aAAa,CAAC,iBAAiB,CAAC,GAAG,QAAQ,CAAC;aAC5C;YAED,OAAO,aAAa,CAAC;QACtB,CAAC;KACD,CAAA;IAvKe,oCAAc,GAAG,CAAC,cAAc,EAAE,mBAAmB,EAAE,eAAe,EAAE,eAAe,EAAE,YAAY,EAAE,gBAAgB,EAAE,aAAa,EAAE,eAAe,CAAC,CAAC;IACzJ,8CAAwB,GAAG,CAAC,eAAe,EAAE,iBAAiB,EAAE,YAAY,EAAE,aAAa,CAAC,CAAC;IAHhG,qBAAqB;QAM/B,WAAA,6BAAiB,CAAA;QACjB,WAAA,oCAAwB,CAAA;QACxB,WAAA,wCAAmB,CAAA;QACnB,WAAA,6BAAiB,CAAA;QACjB,WAAA,8BAAc,CAAA;QACd,WAAA,+BAAkB,CAAA;QAClB,WAAA,8CAAsB,CAAA;QACtB,WAAA,iDAA4B,CAAA;QAC5B,WAAA,qCAAqB,CAAA;QACrB,WAAA,yBAAe,CAAA;QACf,YAAA,4BAAgB,CAAA;OAhBN,qBAAqB,CAyKjC;IAzKY,sDAAqB;IA2KlC,mBAAQ,CAAC,EAAE,CAAkC,0BAAmB,CAAC,SAAS,CAAC,CAAC,6BAA6B,CAAC,qBAAqB,mBAA0B,CAAC","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Registry } from 'vs/platform/registry/common/platform';\nimport { Extensions as WorkbenchExtensions, IWorkbenchContributionsRegistry, IWorkbenchContribution } from 'vs/workbench/common/contributions';\nimport { LifecyclePhase, ILifecycleService, StartupKind } from 'vs/workbench/services/lifecycle/common/lifecycle';\nimport { ITelemetryService } from 'vs/platform/telemetry/common/telemetry';\nimport { IWorkspaceContextService, WorkbenchState } from 'vs/platform/workspace/common/workspace';\nimport { IActivityBarService } from 'vs/workbench/services/activityBar/browser/activityBarService';\nimport { IEditorService } from 'vs/workbench/services/editor/common/editorService';\nimport { IKeybindingService } from 'vs/platform/keybinding/common/keybinding';\nimport { IWorkbenchThemeService } from 'vs/workbench/services/themes/common/workbenchThemeService';\nimport { IWorkbenchEnvironmentService } from 'vs/workbench/services/environment/common/environmentService';\nimport { language } from 'vs/base/common/platform';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport ErrorTelemetry from 'vs/platform/telemetry/browser/errorTelemetry';\nimport { configurationTelemetry } from 'vs/platform/telemetry/common/telemetryUtils';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\nimport { IViewletService } from 'vs/workbench/services/viewlet/browser/viewlet';\nimport { ITextFileService, ITextFileSaveEvent, ITextFileResolveEvent } from 'vs/workbench/services/textfile/common/textfiles';\nimport { extname, basename, isEqual, isEqualOrParent } from 'vs/base/common/resources';\nimport { URI } from 'vs/base/common/uri';\nimport { Schemas } from 'vs/base/common/network';\nimport { guessMimeTypes } from 'vs/base/common/mime';\nimport { hash } from 'vs/base/common/hash';\n\ntype TelemetryData = {\n\tmimeType: string;\n\text: string;\n\tpath: number;\n\treason?: number;\n\tallowlistedjson?: string;\n};\n\ntype FileTelemetryDataFragment = {\n\tmimeType: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\text: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\tpath: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\treason?: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\tallowlistedjson?: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n};\n\nexport class TelemetryContribution extends Disposable implements IWorkbenchContribution {\n\n\tprivate static ALLOWLIST_JSON = ['package.json', 'package-lock.json', 'tsconfig.json', 'jsconfig.json', 'bower.json', '.eslintrc.json', 'tslint.json', 'composer.json'];\n\tprivate static ALLOWLIST_WORKSPACE_JSON = ['settings.json', 'extensions.json', 'tasks.json', 'launch.json'];\n\n\tconstructor(\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IWorkspaceContextService private readonly contextService: IWorkspaceContextService,\n\t\t@IActivityBarService activityBarService: IActivityBarService,\n\t\t@ILifecycleService lifecycleService: ILifecycleService,\n\t\t@IEditorService editorService: IEditorService,\n\t\t@IKeybindingService keybindingsService: IKeybindingService,\n\t\t@IWorkbenchThemeService themeService: IWorkbenchThemeService,\n\t\t@IWorkbenchEnvironmentService private readonly environmentService: IWorkbenchEnvironmentService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IViewletService viewletService: IViewletService,\n\t\t@ITextFileService textFileService: ITextFileService\n\t) {\n\t\tsuper();\n\n\t\tconst { filesToOpenOrCreate, filesToDiff } = environmentService.configuration;\n\t\tconst activeViewlet = viewletService.getActiveViewlet();\n\n\t\ttype WindowSizeFragment = {\n\t\t\tinnerHeight: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\tinnerWidth: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\touterHeight: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\touterWidth: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t};\n\n\t\ttype WorkspaceLoadClassification = {\n\t\t\tuserAgent: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\t\t\temptyWorkbench: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\twindowSize: WindowSizeFragment;\n\t\t\t'workbench.filesToOpenOrCreate': { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\t'workbench.filesToDiff': { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\tcustomKeybindingsCount: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\ttheme: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\t\t\tlanguage: { classification: 'SystemMetaData', purpose: 'BusinessInsight' };\n\t\t\tpinnedViewlets: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\t\t\trestoredViewlet?: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\t\t\trestoredEditors: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t\tstartupKind: { classification: 'SystemMetaData', purpose: 'FeatureInsight', isMeasurement: true };\n\t\t};\n\n\t\ttype WorkspaceLoadEvent = {\n\t\t\tuserAgent: string;\n\t\t\twindowSize: { innerHeight: number, innerWidth: number, outerHeight: number, outerWidth: number };\n\t\t\temptyWorkbench: boolean;\n\t\t\t'workbench.filesToOpenOrCreate': number;\n\t\t\t'workbench.filesToDiff': number;\n\t\t\tcustomKeybindingsCount: number;\n\t\t\ttheme: string;\n\t\t\tlanguage: string;\n\t\t\tpinnedViewlets: string[];\n\t\t\trestoredViewlet?: string;\n\t\t\trestoredEditors: number;\n\t\t\tstartupKind: StartupKind;\n\t\t};\n\n\t\ttelemetryService.publicLog2<WorkspaceLoadEvent, WorkspaceLoadClassification>('workspaceLoad', {\n\t\t\tuserAgent: navigator.userAgent,\n\t\t\twindowSize: { innerHeight: window.innerHeight, innerWidth: window.innerWidth, outerHeight: window.outerHeight, outerWidth: window.outerWidth },\n\t\t\temptyWorkbench: contextService.getWorkbenchState() === WorkbenchState.EMPTY,\n\t\t\t'workbench.filesToOpenOrCreate': filesToOpenOrCreate && filesToOpenOrCreate.length || 0,\n\t\t\t'workbench.filesToDiff': filesToDiff && filesToDiff.length || 0,\n\t\t\tcustomKeybindingsCount: keybindingsService.customKeybindingsCount(),\n\t\t\ttheme: themeService.getColorTheme().id,\n\t\t\tlanguage,\n\t\t\tpinnedViewlets: activityBarService.getPinnedViewContainerIds(),\n\t\t\trestoredViewlet: activeViewlet ? activeViewlet.getId() : undefined,\n\t\t\trestoredEditors: editorService.visibleEditors.length,\n\t\t\tstartupKind: lifecycleService.startupKind\n\t\t});\n\n\t\t// Error Telemetry\n\t\tthis._register(new ErrorTelemetry(telemetryService));\n\n\t\t// Configuration Telemetry\n\t\tthis._register(configurationTelemetry(telemetryService, configurationService));\n\n\t\t//  Files Telemetry\n\t\tthis._register(textFileService.files.onDidResolve(e => this.onTextFileModelResolved(e)));\n\t\tthis._register(textFileService.files.onDidSave(e => this.onTextFileModelSaved(e)));\n\n\t\t// Lifecycle\n\t\tthis._register(lifecycleService.onDidShutdown(() => this.dispose()));\n\t}\n\n\tprivate onTextFileModelResolved(e: ITextFileResolveEvent): void {\n\t\tconst settingsType = this.getTypeIfSettings(e.model.resource);\n\t\tif (settingsType) {\n\t\t\ttype SettingsReadClassification = {\n\t\t\t\tsettingsType: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\t\t\t};\n\n\t\t\tthis.telemetryService.publicLog2<{ settingsType: string }, SettingsReadClassification>('settingsRead', { settingsType }); // Do not log read to user settings.json and .vscode folder as a fileGet event as it ruins our JSON usage data\n\t\t} else {\n\t\t\ttype FileGetClassification = {} & FileTelemetryDataFragment;\n\n\t\t\tthis.telemetryService.publicLog2<TelemetryData, FileGetClassification>('fileGet', this.getTelemetryData(e.model.resource, e.reason));\n\t\t}\n\t}\n\n\tprivate onTextFileModelSaved(e: ITextFileSaveEvent): void {\n\t\tconst settingsType = this.getTypeIfSettings(e.model.resource);\n\t\tif (settingsType) {\n\t\t\ttype SettingsWrittenClassification = {\n\t\t\t\tsettingsType: { classification: 'SystemMetaData', purpose: 'FeatureInsight' };\n\t\t\t};\n\t\t\tthis.telemetryService.publicLog2<{ settingsType: string }, SettingsWrittenClassification>('settingsWritten', { settingsType }); // Do not log write to user settings.json and .vscode folder as a filePUT event as it ruins our JSON usage data\n\t\t} else {\n\t\t\ttype FilePutClassfication = {} & FileTelemetryDataFragment;\n\t\t\tthis.telemetryService.publicLog2<TelemetryData, FilePutClassfication>('filePUT', this.getTelemetryData(e.model.resource, e.reason));\n\t\t}\n\t}\n\n\tprivate getTypeIfSettings(resource: URI): string {\n\t\tif (extname(resource) !== '.json') {\n\t\t\treturn '';\n\t\t}\n\n\t\t// Check for global settings file\n\t\tif (isEqual(resource, this.environmentService.settingsResource)) {\n\t\t\treturn 'global-settings';\n\t\t}\n\n\t\t// Check for keybindings file\n\t\tif (isEqual(resource, this.environmentService.keybindingsResource)) {\n\t\t\treturn 'keybindings';\n\t\t}\n\n\t\t// Check for snippets\n\t\tif (isEqualOrParent(resource, this.environmentService.snippetsHome)) {\n\t\t\treturn 'snippets';\n\t\t}\n\n\t\t// Check for workspace settings file\n\t\tconst folders = this.contextService.getWorkspace().folders;\n\t\tfor (const folder of folders) {\n\t\t\tif (isEqualOrParent(resource, folder.toResource('.vscode'))) {\n\t\t\t\tconst filename = basename(resource);\n\t\t\t\tif (TelemetryContribution.ALLOWLIST_WORKSPACE_JSON.indexOf(filename) > -1) {\n\t\t\t\t\treturn `.vscode/${filename}`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn '';\n\t}\n\n\tprivate getTelemetryData(resource: URI, reason?: number): TelemetryData {\n\t\tconst ext = extname(resource);\n\t\tconst fileName = basename(resource);\n\t\tconst path = resource.scheme === Schemas.file ? resource.fsPath : resource.path;\n\t\tconst telemetryData = {\n\t\t\tmimeType: guessMimeTypes(resource).join(', '),\n\t\t\text,\n\t\t\tpath: hash(path),\n\t\t\treason,\n\t\t\tallowlistedjson: undefined as string | undefined\n\t\t};\n\n\t\tif (ext === '.json' && TelemetryContribution.ALLOWLIST_JSON.indexOf(fileName) > -1) {\n\t\t\ttelemetryData['allowlistedjson'] = fileName;\n\t\t}\n\n\t\treturn telemetryData;\n\t}\n}\n\nRegistry.as<IWorkbenchContributionsRegistry>(WorkbenchExtensions.Workbench).registerWorkbenchContribution(TelemetryContribution, LifecyclePhase.Restored);\n"]}