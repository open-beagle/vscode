{"version":3,"file":"notebookEditorServiceImpl.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/workbench/contrib/notebook/browser/notebookEditorServiceImpl.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ResourceMap } from 'vs/base/common/map';\nimport { NotebookEditorWidget } from 'vs/workbench/contrib/notebook/browser/notebookEditorWidget';\nimport { DisposableStore, IDisposable } from 'vs/base/common/lifecycle';\nimport { IEditorGroupsService, IEditorGroup, GroupChangeKind } from 'vs/workbench/services/editor/common/editorGroupsService';\nimport { IInstantiationService, ServicesAccessor } from 'vs/platform/instantiation/common/instantiation';\nimport { NotebookEditorInput } from 'vs/workbench/contrib/notebook/common/notebookEditorInput';\nimport { IBorrowValue, INotebookEditorService } from 'vs/workbench/contrib/notebook/browser/notebookEditorService';\nimport { INotebookEditor } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\nimport { Emitter } from 'vs/base/common/event';\nimport { INotebookDecorationRenderOptions } from 'vs/workbench/contrib/notebook/common/notebookCommon';\nimport { GroupIdentifier } from 'vs/workbench/common/editor';\n\nexport class NotebookEditorWidgetService implements INotebookEditorService {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate _tokenPool = 1;\n\n\tprivate readonly _disposables = new DisposableStore();\n\tprivate readonly _notebookEditors = new Map<string, INotebookEditor>();\n\tprivate readonly _decorationOptionProviders = new Map<string, INotebookDecorationRenderOptions>();\n\n\tprivate readonly _onNotebookEditorAdd = new Emitter<INotebookEditor>();\n\tprivate readonly _onNotebookEditorsRemove = new Emitter<INotebookEditor>();\n\treadonly onDidAddNotebookEditor = this._onNotebookEditorAdd.event;\n\treadonly onDidRemoveNotebookEditor = this._onNotebookEditorsRemove.event;\n\n\tprivate readonly _borrowableEditors = new Map<number, ResourceMap<{ widget: NotebookEditorWidget, token: number | undefined }>>();\n\n\tconstructor(\n\t\t@IEditorGroupsService editorGroupService: IEditorGroupsService,\n\t) {\n\n\t\tconst groupListener = new Map<number, IDisposable[]>();\n\t\tconst onNewGroup = (group: IEditorGroup) => {\n\t\t\tconst { id } = group;\n\t\t\tconst listeners: IDisposable[] = [];\n\t\t\tlisteners.push(group.onDidGroupChange(e => {\n\t\t\t\tconst widgets = this._borrowableEditors.get(group.id);\n\t\t\t\tif (!widgets || e.kind !== GroupChangeKind.EDITOR_CLOSE || !(e.editor instanceof NotebookEditorInput)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst value = widgets.get(e.editor.resource);\n\t\t\t\tif (!value) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvalue.token = undefined;\n\t\t\t\tthis._disposeWidget(value.widget);\n\t\t\t\twidgets.delete(e.editor.resource);\n\t\t\t}));\n\t\t\tlisteners.push(group.onWillMoveEditor(e => {\n\t\t\t\tif (e.editor instanceof NotebookEditorInput) {\n\t\t\t\t\tthis._freeWidget(e.editor, e.groupId, e.target);\n\t\t\t\t}\n\t\t\t}));\n\t\t\tgroupListener.set(id, listeners);\n\t\t};\n\t\tthis._disposables.add(editorGroupService.onDidAddGroup(onNewGroup));\n\t\teditorGroupService.whenReady.then(() => editorGroupService.groups.forEach(onNewGroup));\n\n\t\t// group removed -> clean up listeners, clean up widgets\n\t\tthis._disposables.add(editorGroupService.onDidRemoveGroup(group => {\n\t\t\tconst listeners = groupListener.get(group.id);\n\t\t\tif (listeners) {\n\t\t\t\tlisteners.forEach(listener => listener.dispose());\n\t\t\t\tgroupListener.delete(group.id);\n\t\t\t}\n\t\t\tconst widgets = this._borrowableEditors.get(group.id);\n\t\t\tthis._borrowableEditors.delete(group.id);\n\t\t\tif (widgets) {\n\t\t\t\tfor (const value of widgets.values()) {\n\t\t\t\t\tvalue.token = undefined;\n\t\t\t\t\tthis._disposeWidget(value.widget);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tdispose() {\n\t\tthis._disposables.dispose();\n\t\tthis._onNotebookEditorAdd.dispose();\n\t\tthis._onNotebookEditorsRemove.dispose();\n\t}\n\n\t// --- group-based editor borrowing...\n\n\tprivate _disposeWidget(widget: NotebookEditorWidget): void {\n\t\twidget.onWillHide();\n\t\tconst domNode = widget.getDomNode();\n\t\twidget.dispose();\n\t\tdomNode.remove();\n\t}\n\n\tprivate _freeWidget(input: NotebookEditorInput, sourceID: GroupIdentifier, targetID: GroupIdentifier): void {\n\t\tconst targetWidget = this._borrowableEditors.get(targetID)?.get(input.resource);\n\t\tif (targetWidget) {\n\t\t\t// not needed\n\t\t\treturn;\n\t\t}\n\n\t\tconst widget = this._borrowableEditors.get(sourceID)?.get(input.resource);\n\t\tif (!widget) {\n\t\t\tthrow new Error('no widget at source group');\n\t\t}\n\t\tthis._borrowableEditors.get(sourceID)?.delete(input.resource);\n\t\twidget.token = undefined;\n\n\t\tlet targetMap = this._borrowableEditors.get(targetID);\n\t\tif (!targetMap) {\n\t\t\ttargetMap = new ResourceMap();\n\t\t\tthis._borrowableEditors.set(targetID, targetMap);\n\t\t}\n\t\ttargetMap.set(input.resource, widget);\n\t}\n\n\tretrieveWidget(accessor: ServicesAccessor, group: IEditorGroup, input: NotebookEditorInput): IBorrowValue<NotebookEditorWidget> {\n\n\t\tlet value = this._borrowableEditors.get(group.id)?.get(input.resource);\n\n\t\tif (!value) {\n\t\t\t// NEW widget\n\t\t\tconst instantiationService = accessor.get(IInstantiationService);\n\t\t\tconst widget = instantiationService.createInstance(NotebookEditorWidget, { isEmbedded: false });\n\t\t\tconst token = this._tokenPool++;\n\t\t\tvalue = { widget, token };\n\n\t\t\tlet map = this._borrowableEditors.get(group.id);\n\t\t\tif (!map) {\n\t\t\t\tmap = new ResourceMap();\n\t\t\t\tthis._borrowableEditors.set(group.id, map);\n\t\t\t}\n\t\t\tmap.set(input.resource, value);\n\n\t\t} else {\n\t\t\t// reuse a widget which was either free'ed before or which\n\t\t\t// is simply being reused...\n\t\t\tvalue.token = this._tokenPool++;\n\t\t}\n\n\t\treturn this._createBorrowValue(value.token!, value);\n\t}\n\n\tprivate _createBorrowValue(myToken: number, widget: { widget: NotebookEditorWidget, token: number | undefined }): IBorrowValue<NotebookEditorWidget> {\n\t\treturn {\n\t\t\tget value() {\n\t\t\t\treturn widget.token === myToken ? widget.widget : undefined;\n\t\t\t}\n\t\t};\n\t}\n\n\t// --- editor management\n\n\taddNotebookEditor(editor: INotebookEditor): void {\n\t\tthis._notebookEditors.set(editor.getId(), editor);\n\t\tthis._onNotebookEditorAdd.fire(editor);\n\t}\n\n\tremoveNotebookEditor(editor: INotebookEditor): void {\n\t\tif (this._notebookEditors.has(editor.getId())) {\n\t\t\tthis._notebookEditors.delete(editor.getId());\n\t\t\tthis._onNotebookEditorsRemove.fire(editor);\n\t\t}\n\t}\n\n\tgetNotebookEditor(editorId: string): INotebookEditor | undefined {\n\t\treturn this._notebookEditors.get(editorId);\n\t}\n\n\tlistNotebookEditors(): readonly INotebookEditor[] {\n\t\treturn [...this._notebookEditors].map(e => e[1]);\n\t}\n\n\t// --- editor decorations\n\n\tregisterEditorDecorationType(key: string, options: INotebookDecorationRenderOptions): void {\n\t\tif (!this._decorationOptionProviders.has(key)) {\n\t\t\tthis._decorationOptionProviders.set(key, options);\n\t\t}\n\t}\n\n\tremoveEditorDecorationType(key: string): void {\n\t\tthis._decorationOptionProviders.delete(key);\n\t\tthis.listNotebookEditors().forEach(editor => editor.removeEditorDecorations(key));\n\t}\n\n\tresolveEditorDecorationOptions(key: string): INotebookDecorationRenderOptions | undefined {\n\t\treturn this._decorationOptionProviders.get(key);\n\t}\n}\n"]}