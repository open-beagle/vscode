{"version":3,"file":"textFileEditorTracker.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/workbench/contrib/files/browser/editors/textFileEditorTracker.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IWorkbenchContribution } from 'vs/workbench/common/contributions';\nimport { URI } from 'vs/base/common/uri';\nimport { ITextFileService, TextFileEditorModelState } from 'vs/workbench/services/textfile/common/textfiles';\nimport { ILifecycleService } from 'vs/workbench/services/lifecycle/common/lifecycle';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { distinct, coalesce } from 'vs/base/common/arrays';\nimport { IHostService } from 'vs/workbench/services/host/browser/host';\nimport { IEditorService } from 'vs/workbench/services/editor/common/editorService';\nimport { RunOnceWorker } from 'vs/base/common/async';\nimport { ICodeEditorService } from 'vs/editor/browser/services/codeEditorService';\nimport { IFilesConfigurationService, AutoSaveMode } from 'vs/workbench/services/filesConfiguration/common/filesConfigurationService';\nimport { FILE_EDITOR_INPUT_ID } from 'vs/workbench/contrib/files/common/files';\nimport { Schemas } from 'vs/base/common/network';\nimport { UntitledTextEditorInput } from 'vs/workbench/services/untitled/common/untitledTextEditorInput';\n\nexport class TextFileEditorTracker extends Disposable implements IWorkbenchContribution {\n\n\tconstructor(\n\t\t@IEditorService private readonly editorService: IEditorService,\n\t\t@ITextFileService private readonly textFileService: ITextFileService,\n\t\t@ILifecycleService private readonly lifecycleService: ILifecycleService,\n\t\t@IHostService private readonly hostService: IHostService,\n\t\t@ICodeEditorService private readonly codeEditorService: ICodeEditorService,\n\t\t@IFilesConfigurationService private readonly filesConfigurationService: IFilesConfigurationService\n\t) {\n\t\tsuper();\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\n\t\t// Ensure dirty text file and untitled models are always opened as editors\n\t\tthis._register(this.textFileService.files.onDidChangeDirty(model => this.ensureDirtyFilesAreOpenedWorker.work(model.resource)));\n\t\tthis._register(this.textFileService.files.onDidSaveError(model => this.ensureDirtyFilesAreOpenedWorker.work(model.resource)));\n\t\tthis._register(this.textFileService.untitled.onDidChangeDirty(model => this.ensureDirtyFilesAreOpenedWorker.work(model.resource)));\n\n\t\t// Update visible text file editors when focus is gained\n\t\tthis._register(this.hostService.onDidChangeFocus(hasFocus => hasFocus ? this.reloadVisibleTextFileEditors() : undefined));\n\n\t\t// Lifecycle\n\t\tthis.lifecycleService.onDidShutdown(() => this.dispose());\n\t}\n\n\t//#region Text File: Ensure every dirty text and untitled file is opened in an editor\n\n\tprivate readonly ensureDirtyFilesAreOpenedWorker = this._register(new RunOnceWorker<URI>(units => this.ensureDirtyTextFilesAreOpened(units), 50));\n\n\tprivate ensureDirtyTextFilesAreOpened(resources: URI[]): void {\n\t\tthis.doEnsureDirtyTextFilesAreOpened(distinct(resources.filter(resource => {\n\t\t\tif (!this.textFileService.isDirty(resource)) {\n\t\t\t\treturn false; // resource must be dirty\n\t\t\t}\n\n\t\t\tconst model = this.textFileService.files.get(resource);\n\t\t\tif (model?.hasState(TextFileEditorModelState.PENDING_SAVE)) {\n\t\t\t\treturn false; // resource must not be pending to save\n\t\t\t}\n\n\t\t\tif (this.filesConfigurationService.getAutoSaveMode() === AutoSaveMode.AFTER_SHORT_DELAY && !model?.hasState(TextFileEditorModelState.ERROR)) {\n\t\t\t\t// leave models auto saved after short delay unless\n\t\t\t\t// the save resulted in an error\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (this.editorService.isOpened({ resource, typeId: resource.scheme === Schemas.untitled ? UntitledTextEditorInput.ID : FILE_EDITOR_INPUT_ID })) {\n\t\t\t\treturn false; // model must not be opened already as file\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}), resource => resource.toString()));\n\t}\n\n\tprivate doEnsureDirtyTextFilesAreOpened(resources: URI[]): void {\n\t\tif (!resources.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.editorService.openEditors(resources.map(resource => ({\n\t\t\tresource,\n\t\t\toptions: { inactive: true, pinned: true, preserveFocus: true }\n\t\t})));\n\t}\n\n\t//#endregion\n\n\t//#region Window Focus Change: Update visible code editors when focus is gained that have a known text file model\n\n\tprivate reloadVisibleTextFileEditors(): void {\n\t\t// the window got focus and we use this as a hint that files might have been changed outside\n\t\t// of this window. since file events can be unreliable, we queue a load for models that\n\t\t// are visible in any editor. since this is a fast operation in the case nothing has changed,\n\t\t// we tolerate the additional work.\n\t\tdistinct(\n\t\t\tcoalesce(this.codeEditorService.listCodeEditors()\n\t\t\t\t.map(codeEditor => {\n\t\t\t\t\tconst resource = codeEditor.getModel()?.uri;\n\t\t\t\t\tif (!resource) {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst model = this.textFileService.files.get(resource);\n\t\t\t\t\tif (!model || model.isDirty() || !model.isResolved()) {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn model;\n\t\t\t\t})),\n\t\t\tmodel => model.resource.toString()\n\t\t).forEach(model => this.textFileService.files.resolve(model.resource, { reload: { async: true } }));\n\t}\n\n\t//#endregion\n}\n"]}