{"version":3,"file":"contributedOpeners.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/workbench/contrib/externalUriOpener/common/contributedOpeners.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { IStorageService, StorageScope, StorageTarget } from 'vs/platform/storage/common/storage';\nimport { Memento } from 'vs/workbench/common/memento';\nimport { updateContributedOpeners } from 'vs/workbench/contrib/externalUriOpener/common/configuration';\nimport { IExtensionService } from 'vs/workbench/services/extensions/common/extensions';\n\ninterface RegisteredExternalOpener {\n\treadonly extensionId: string;\n\n\tisCurrentlyRegistered: boolean\n}\n\ninterface OpenersMemento {\n\t[id: string]: RegisteredExternalOpener;\n}\n\n/**\n */\nexport class ContributedExternalUriOpenersStore extends Disposable {\n\n\tprivate static readonly STORAGE_ID = 'externalUriOpeners';\n\n\tprivate readonly _openers = new Map<string, RegisteredExternalOpener>();\n\tprivate readonly _memento: Memento;\n\tprivate _mementoObject: OpenersMemento;\n\n\tconstructor(\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService\n\t) {\n\t\tsuper();\n\n\t\tthis._memento = new Memento(ContributedExternalUriOpenersStore.STORAGE_ID, storageService);\n\t\tthis._mementoObject = this._memento.getMemento(StorageScope.GLOBAL, StorageTarget.MACHINE);\n\t\tfor (const id of Object.keys(this._mementoObject || {})) {\n\t\t\tthis.add(id, this._mementoObject[id].extensionId, { isCurrentlyRegistered: false });\n\t\t}\n\n\t\tthis.invalidateOpenersOnExtensionsChanged();\n\n\t\tthis._register(this._extensionService.onDidChangeExtensions(() => this.invalidateOpenersOnExtensionsChanged()));\n\t\tthis._register(this._extensionService.onDidChangeExtensionsStatus(() => this.invalidateOpenersOnExtensionsChanged()));\n\t}\n\n\tpublic didRegisterOpener(id: string, extensionId: string): void {\n\t\tthis.add(id, extensionId, {\n\t\t\tisCurrentlyRegistered: true\n\t\t});\n\t}\n\n\tprivate add(id: string, extensionId: string, options: { isCurrentlyRegistered: boolean }): void {\n\t\tconst existing = this._openers.get(id);\n\t\tif (existing) {\n\t\t\texisting.isCurrentlyRegistered = existing.isCurrentlyRegistered || options.isCurrentlyRegistered;\n\t\t\treturn;\n\t\t}\n\n\t\tconst entry = {\n\t\t\textensionId,\n\t\t\tisCurrentlyRegistered: options.isCurrentlyRegistered\n\t\t};\n\t\tthis._openers.set(id, entry);\n\n\t\tthis._mementoObject[id] = entry;\n\t\tthis._memento.saveMemento();\n\n\t\tthis.updateSchema();\n\t}\n\n\tpublic delete(id: string): void {\n\t\tthis._openers.delete(id);\n\n\t\tdelete this._mementoObject[id];\n\t\tthis._memento.saveMemento();\n\n\t\tthis.updateSchema();\n\t}\n\n\tprivate async invalidateOpenersOnExtensionsChanged() {\n\t\tconst registeredExtensions = await this._extensionService.getExtensions();\n\n\t\tfor (const [id, entry] of this._openers) {\n\t\t\tconst extension = registeredExtensions.find(r => r.identifier.value === entry.extensionId);\n\t\t\tif (extension) {\n\t\t\t\tif (!this._extensionService.canRemoveExtension(extension)) {\n\t\t\t\t\t// The extension is running. We should have registered openers at this point\n\t\t\t\t\tif (!entry.isCurrentlyRegistered) {\n\t\t\t\t\t\tthis.delete(id);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// The opener came from an extension that is no longer enabled/installed\n\t\t\t\tthis.delete(id);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateSchema() {\n\t\tconst ids: string[] = [];\n\t\tconst descriptions: string[] = [];\n\n\t\tfor (const [id, entry] of this._openers) {\n\t\t\tids.push(id);\n\t\t\tdescriptions.push(entry.extensionId);\n\t\t}\n\n\t\tupdateContributedOpeners(ids, descriptions);\n\t}\n}\n"]}