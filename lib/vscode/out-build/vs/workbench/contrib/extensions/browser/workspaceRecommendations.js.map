{"version":3,"sources":["vs/workbench/contrib/extensions/browser/workspaceRecommendations.ts"],"names":[],"mappings":"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","file":"workspaceRecommendations.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { EXTENSION_IDENTIFIER_PATTERN, IExtensionGalleryService } from 'vs/platform/extensionManagement/common/extensionManagement';\nimport { distinct, flatten } from 'vs/base/common/arrays';\nimport { ExtensionRecommendations, ExtensionRecommendation } from 'vs/workbench/contrib/extensions/browser/extensionRecommendations';\nimport { INotificationService } from 'vs/platform/notification/common/notification';\nimport { ExtensionRecommendationReason } from 'vs/workbench/services/extensionRecommendations/common/extensionRecommendations';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { localize } from 'vs/nls';\nimport { Emitter } from 'vs/base/common/event';\nimport { IExtensionsConfigContent, IWorkpsaceExtensionsConfigService } from 'vs/workbench/services/extensionRecommendations/common/workspaceExtensionsConfig';\n\nexport class WorkspaceRecommendations extends ExtensionRecommendations {\n\n\tprivate _recommendations: ExtensionRecommendation[] = [];\n\tget recommendations(): ReadonlyArray<ExtensionRecommendation> { return this._recommendations; }\n\n\tprivate _onDidChangeRecommendations = this._register(new Emitter<void>());\n\treadonly onDidChangeRecommendations = this._onDidChangeRecommendations.event;\n\n\tprivate _ignoredRecommendations: string[] = [];\n\tget ignoredRecommendations(): ReadonlyArray<string> { return this._ignoredRecommendations; }\n\n\tconstructor(\n\t\t@IWorkpsaceExtensionsConfigService private readonly workpsaceExtensionsConfigService: IWorkpsaceExtensionsConfigService,\n\t\t@IExtensionGalleryService private readonly galleryService: IExtensionGalleryService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@INotificationService private readonly notificationService: INotificationService,\n\t) {\n\t\tsuper();\n\t}\n\n\tprotected async doActivate(): Promise<void> {\n\t\tawait this.fetch();\n\t\tthis._register(this.workpsaceExtensionsConfigService.onDidChangeExtensionsConfigs(() => this.onDidChangeExtensionsConfigs()));\n\t}\n\n\t/**\n\t * Parse all extensions.json files, fetch workspace recommendations, filter out invalid and unwanted ones\n\t */\n\tprivate async fetch(): Promise<void> {\n\n\t\tconst extensionsConfigs = await this.workpsaceExtensionsConfigService.getExtensionsConfigs();\n\n\t\tconst { invalidRecommendations, message } = await this.validateExtensions(extensionsConfigs);\n\t\tif (invalidRecommendations.length) {\n\t\t\tthis.notificationService.warn(`The ${invalidRecommendations.length} extension(s) below, in workspace recommendations have issues:\\n${message}`);\n\t\t}\n\n\t\tthis._recommendations = [];\n\t\tthis._ignoredRecommendations = [];\n\n\t\tfor (const extensionsConfig of extensionsConfigs) {\n\t\t\tif (extensionsConfig.unwantedRecommendations) {\n\t\t\t\tfor (const unwantedRecommendation of extensionsConfig.unwantedRecommendations) {\n\t\t\t\t\tif (invalidRecommendations.indexOf(unwantedRecommendation) === -1) {\n\t\t\t\t\t\tthis._ignoredRecommendations.push(unwantedRecommendation);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (extensionsConfig.recommendations) {\n\t\t\t\tfor (const extensionId of extensionsConfig.recommendations) {\n\t\t\t\t\tif (invalidRecommendations.indexOf(extensionId) === -1) {\n\t\t\t\t\t\tthis._recommendations.push({\n\t\t\t\t\t\t\textensionId,\n\t\t\t\t\t\t\treason: {\n\t\t\t\t\t\t\t\treasonId: ExtensionRecommendationReason.Workspace,\n\t\t\t\t\t\t\t\treasonText: localize('workspaceRecommendation', \"This extension is recommended by users of the current workspace.\")\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async validateExtensions(contents: IExtensionsConfigContent[]): Promise<{ validRecommendations: string[], invalidRecommendations: string[], message: string }> {\n\n\t\tconst validExtensions: string[] = [];\n\t\tconst invalidExtensions: string[] = [];\n\t\tconst extensionsToQuery: string[] = [];\n\t\tlet message = '';\n\n\t\tconst allRecommendations = distinct(flatten(contents.map(({ recommendations }) => recommendations || [])));\n\t\tconst regEx = new RegExp(EXTENSION_IDENTIFIER_PATTERN);\n\t\tfor (const extensionId of allRecommendations) {\n\t\t\tif (regEx.test(extensionId)) {\n\t\t\t\textensionsToQuery.push(extensionId);\n\t\t\t} else {\n\t\t\t\tinvalidExtensions.push(extensionId);\n\t\t\t\tmessage += `${extensionId} (bad format) Expected: <provider>.<name>\\n`;\n\t\t\t}\n\t\t}\n\n\t\tif (extensionsToQuery.length) {\n\t\t\ttry {\n\t\t\t\tconst queryResult = await this.galleryService.query({ names: extensionsToQuery, pageSize: extensionsToQuery.length }, CancellationToken.None);\n\t\t\t\tconst extensions = queryResult.firstPage.map(extension => extension.identifier.id.toLowerCase());\n\n\t\t\t\tfor (const extensionId of extensionsToQuery) {\n\t\t\t\t\tif (extensions.indexOf(extensionId) === -1) {\n\t\t\t\t\t\tinvalidExtensions.push(extensionId);\n\t\t\t\t\t\tmessage += `${extensionId} (not found in marketplace)\\n`;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvalidExtensions.push(extensionId);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.warn('Error querying extensions gallery', e);\n\t\t\t}\n\t\t}\n\n\t\treturn { validRecommendations: validExtensions, invalidRecommendations: invalidExtensions, message };\n\t}\n\n\tprivate async onDidChangeExtensionsConfigs(): Promise<void> {\n\t\tawait this.fetch();\n\t\tthis._onDidChangeRecommendations.fire();\n\t}\n\n}\n\n"]}