{"version":3,"sources":["vs/workbench/contrib/extensions/electron-browser/extensionProfileService.ts"],"names":[],"mappings":"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","file":"extensionProfileService.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from 'vs/nls';\nimport { Event, Emitter } from 'vs/base/common/event';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { IExtensionHostProfile, ProfileSession, IExtensionService } from 'vs/workbench/services/extensions/common/extensions';\nimport { Disposable, toDisposable, MutableDisposable } from 'vs/base/common/lifecycle';\nimport { onUnexpectedError } from 'vs/base/common/errors';\nimport { StatusbarAlignment, IStatusbarService, IStatusbarEntryAccessor, IStatusbarEntry } from 'vs/workbench/services/statusbar/common/statusbar';\nimport { IExtensionHostProfileService, ProfileSessionState } from 'vs/workbench/contrib/extensions/electron-browser/runtimeExtensionsEditor';\nimport { IEditorService } from 'vs/workbench/services/editor/common/editorService';\nimport { INativeHostService } from 'vs/platform/native/electron-sandbox/native';\nimport { IDialogService } from 'vs/platform/dialogs/common/dialogs';\nimport { randomPort } from 'vs/base/node/ports';\nimport { IProductService } from 'vs/platform/product/common/productService';\nimport { RuntimeExtensionsInput } from 'vs/workbench/contrib/extensions/common/runtimeExtensionsInput';\nimport { ExtensionIdentifier } from 'vs/platform/extensions/common/extensions';\nimport { ExtensionHostProfiler } from 'vs/workbench/services/extensions/electron-browser/extensionHostProfiler';\nimport { CommandsRegistry } from 'vs/platform/commands/common/commands';\n\nexport class ExtensionHostProfileService extends Disposable implements IExtensionHostProfileService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _onDidChangeState: Emitter<void> = this._register(new Emitter<void>());\n\tpublic readonly onDidChangeState: Event<void> = this._onDidChangeState.event;\n\n\tprivate readonly _onDidChangeLastProfile: Emitter<void> = this._register(new Emitter<void>());\n\tpublic readonly onDidChangeLastProfile: Event<void> = this._onDidChangeLastProfile.event;\n\n\tprivate readonly _unresponsiveProfiles = new Map<string, IExtensionHostProfile>();\n\tprivate _profile: IExtensionHostProfile | null;\n\tprivate _profileSession: ProfileSession | null;\n\tprivate _state: ProfileSessionState = ProfileSessionState.None;\n\n\tprivate profilingStatusBarIndicator: IStatusbarEntryAccessor | undefined;\n\tprivate readonly profilingStatusBarIndicatorLabelUpdater = this._register(new MutableDisposable());\n\n\tpublic get state() { return this._state; }\n\tpublic get lastProfile() { return this._profile; }\n\n\tconstructor(\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@INativeHostService private readonly _nativeHostService: INativeHostService,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@IStatusbarService private readonly _statusbarService: IStatusbarService,\n\t\t@IProductService private readonly _productService: IProductService\n\t) {\n\t\tsuper();\n\t\tthis._profile = null;\n\t\tthis._profileSession = null;\n\t\tthis._setState(ProfileSessionState.None);\n\n\t\tCommandsRegistry.registerCommand('workbench.action.extensionHostProfiler.stop', () => {\n\t\t\tthis.stopProfiling();\n\t\t\tthis._editorService.openEditor(RuntimeExtensionsInput.instance, { revealIfOpened: true, pinned: true });\n\t\t});\n\t}\n\n\tprivate _setState(state: ProfileSessionState): void {\n\t\tif (this._state === state) {\n\t\t\treturn;\n\t\t}\n\t\tthis._state = state;\n\n\t\tif (this._state === ProfileSessionState.Running) {\n\t\t\tthis.updateProfilingStatusBarIndicator(true);\n\t\t} else if (this._state === ProfileSessionState.Stopping) {\n\t\t\tthis.updateProfilingStatusBarIndicator(false);\n\t\t}\n\n\t\tthis._onDidChangeState.fire(undefined);\n\t}\n\n\tprivate updateProfilingStatusBarIndicator(visible: boolean): void {\n\t\tthis.profilingStatusBarIndicatorLabelUpdater.clear();\n\n\t\tif (visible) {\n\t\t\tconst indicator: IStatusbarEntry = {\n\t\t\t\ttext: nls.localize('profilingExtensionHost', \"Profiling Extension Host\"),\n\t\t\t\tshowProgress: true,\n\t\t\t\tariaLabel: nls.localize('profilingExtensionHost', \"Profiling Extension Host\"),\n\t\t\t\ttooltip: nls.localize('selectAndStartDebug', \"Click to stop profiling.\"),\n\t\t\t\tcommand: 'workbench.action.extensionHostProfiler.stop'\n\t\t\t};\n\n\t\t\tconst timeStarted = Date.now();\n\t\t\tconst handle = setInterval(() => {\n\t\t\t\tif (this.profilingStatusBarIndicator) {\n\t\t\t\t\tthis.profilingStatusBarIndicator.update({ ...indicator, text: nls.localize('profilingExtensionHostTime', \"Profiling Extension Host ({0} sec)\", Math.round((new Date().getTime() - timeStarted) / 1000)), });\n\t\t\t\t}\n\t\t\t}, 1000);\n\t\t\tthis.profilingStatusBarIndicatorLabelUpdater.value = toDisposable(() => clearInterval(handle));\n\n\t\t\tif (!this.profilingStatusBarIndicator) {\n\t\t\t\tthis.profilingStatusBarIndicator = this._statusbarService.addEntry(indicator, 'status.profiler', nls.localize('status.profiler', \"Extension Profiler\"), StatusbarAlignment.RIGHT);\n\t\t\t} else {\n\t\t\t\tthis.profilingStatusBarIndicator.update(indicator);\n\t\t\t}\n\t\t} else {\n\t\t\tif (this.profilingStatusBarIndicator) {\n\t\t\t\tthis.profilingStatusBarIndicator.dispose();\n\t\t\t\tthis.profilingStatusBarIndicator = undefined;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic async startProfiling(): Promise<any> {\n\t\tif (this._state !== ProfileSessionState.None) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst inspectPort = await this._extensionService.getInspectPort(true);\n\t\tif (!inspectPort) {\n\t\t\treturn this._dialogService.confirm({\n\t\t\t\ttype: 'info',\n\t\t\t\tmessage: nls.localize('restart1', \"Profile Extensions\"),\n\t\t\t\tdetail: nls.localize('restart2', \"In order to profile extensions a restart is required. Do you want to restart '{0}' now?\", this._productService.nameLong),\n\t\t\t\tprimaryButton: nls.localize('restart3', \"&&Restart\"),\n\t\t\t\tsecondaryButton: nls.localize('cancel', \"&&Cancel\")\n\t\t\t}).then(res => {\n\t\t\t\tif (res.confirmed) {\n\t\t\t\t\tthis._nativeHostService.relaunch({ addArgs: [`--inspect-extensions=${randomPort()}`] });\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tthis._setState(ProfileSessionState.Starting);\n\n\t\treturn this._instantiationService.createInstance(ExtensionHostProfiler, inspectPort).start().then((value) => {\n\t\t\tthis._profileSession = value;\n\t\t\tthis._setState(ProfileSessionState.Running);\n\t\t}, (err) => {\n\t\t\tonUnexpectedError(err);\n\t\t\tthis._setState(ProfileSessionState.None);\n\t\t});\n\t}\n\n\tpublic stopProfiling(): void {\n\t\tif (this._state !== ProfileSessionState.Running || !this._profileSession) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._setState(ProfileSessionState.Stopping);\n\t\tthis._profileSession.stop().then((result) => {\n\t\t\tthis._setLastProfile(result);\n\t\t\tthis._setState(ProfileSessionState.None);\n\t\t}, (err) => {\n\t\t\tonUnexpectedError(err);\n\t\t\tthis._setState(ProfileSessionState.None);\n\t\t});\n\t\tthis._profileSession = null;\n\t}\n\n\tprivate _setLastProfile(profile: IExtensionHostProfile) {\n\t\tthis._profile = profile;\n\t\tthis._onDidChangeLastProfile.fire(undefined);\n\t}\n\n\tgetUnresponsiveProfile(extensionId: ExtensionIdentifier): IExtensionHostProfile | undefined {\n\t\treturn this._unresponsiveProfiles.get(ExtensionIdentifier.toKey(extensionId));\n\t}\n\n\tsetUnresponsiveProfile(extensionId: ExtensionIdentifier, profile: IExtensionHostProfile): void {\n\t\tthis._unresponsiveProfiles.set(ExtensionIdentifier.toKey(extensionId), profile);\n\t\tthis._setLastProfile(profile);\n\t}\n\n}\n"]}