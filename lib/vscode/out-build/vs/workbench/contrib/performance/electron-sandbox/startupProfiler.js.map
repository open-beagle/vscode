{"version":3,"sources":["vs/workbench/contrib/performance/electron-sandbox/startupProfiler.ts"],"names":[],"mappings":"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","file":"startupProfiler.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IWorkbenchContribution } from 'vs/workbench/common/contributions';\nimport { localize } from 'vs/nls';\nimport { dirname, basename, joinPath } from 'vs/base/common/resources';\nimport { ITextModelService } from 'vs/editor/common/services/resolverService';\nimport { IDialogService } from 'vs/platform/dialogs/common/dialogs';\nimport { INativeWorkbenchEnvironmentService } from 'vs/workbench/services/environment/electron-sandbox/environmentService';\nimport { ILifecycleService, LifecyclePhase } from 'vs/workbench/services/lifecycle/common/lifecycle';\nimport { PerfviewInput } from 'vs/workbench/contrib/performance/browser/perfviewEditor';\nimport { IExtensionService } from 'vs/workbench/services/extensions/common/extensions';\nimport { IClipboardService } from 'vs/platform/clipboard/common/clipboardService';\nimport { URI } from 'vs/base/common/uri';\nimport { IOpenerService } from 'vs/platform/opener/common/opener';\nimport { INativeHostService } from 'vs/platform/native/electron-sandbox/native';\nimport { IProductService } from 'vs/platform/product/common/productService';\nimport { IFileService } from 'vs/platform/files/common/files';\nimport { ILabelService } from 'vs/platform/label/common/label';\n\nexport class StartupProfiler implements IWorkbenchContribution {\n\n\tconstructor(\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@ITextModelService private readonly _textModelResolverService: ITextModelService,\n\t\t@IClipboardService private readonly _clipboardService: IClipboardService,\n\t\t@ILifecycleService lifecycleService: ILifecycleService,\n\t\t@IExtensionService extensionService: IExtensionService,\n\t\t@IOpenerService private readonly _openerService: IOpenerService,\n\t\t@INativeHostService private readonly _nativeHostService: INativeHostService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@ILabelService private readonly _labelService: ILabelService,\n\t) {\n\t\t// wait for everything to be ready\n\t\tPromise.all([\n\t\t\tlifecycleService.when(LifecyclePhase.Eventually),\n\t\t\textensionService.whenInstalledExtensionsRegistered()\n\t\t]).then(() => {\n\t\t\tthis._stopProfiling();\n\t\t});\n\t}\n\n\tprivate _stopProfiling(): void {\n\n\t\tif (!this._environmentService.args['prof-startup-prefix']) {\n\t\t\treturn;\n\t\t}\n\t\tconst profileFilenamePrefix = URI.file(this._environmentService.args['prof-startup-prefix']);\n\n\t\tconst dir = dirname(profileFilenamePrefix);\n\t\tconst prefix = basename(profileFilenamePrefix);\n\n\t\tconst removeArgs: string[] = ['--prof-startup'];\n\t\tconst markerFile = this._fileService.readFile(profileFilenamePrefix).then(value => removeArgs.push(...value.toString().split('|')))\n\t\t\t.then(() => this._fileService.del(profileFilenamePrefix, { recursive: true })) // (1) delete the file to tell the main process to stop profiling\n\t\t\t.then(() => new Promise<void>(resolve => { // (2) wait for main that recreates the fail to signal profiling has stopped\n\t\t\t\tconst check = () => {\n\t\t\t\t\tthis._fileService.exists(profileFilenamePrefix).then(exists => {\n\t\t\t\t\t\tif (exists) {\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tsetTimeout(check, 500);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\tcheck();\n\t\t\t}))\n\t\t\t.then(() => this._fileService.del(profileFilenamePrefix, { recursive: true })); // (3) finally delete the file again\n\n\t\tmarkerFile.then(() => {\n\t\t\treturn this._fileService.resolve(dir).then(stat => {\n\t\t\t\treturn (stat.children ? stat.children.filter(value => value.resource.path.includes(prefix)) : []).map(stat => stat.resource.path);\n\t\t\t});\n\t\t}).then(files => {\n\t\t\tconst profileFiles = files.reduce((prev, cur) => `${prev}${this._labelService.getUriLabel(joinPath(dir, cur))}\\n`, '\\n');\n\n\t\t\treturn this._dialogService.confirm({\n\t\t\t\ttype: 'info',\n\t\t\t\tmessage: localize('prof.message', \"Successfully created profiles.\"),\n\t\t\t\tdetail: localize('prof.detail', \"Please create an issue and manually attach the following files:\\n{0}\", profileFiles),\n\t\t\t\tprimaryButton: localize('prof.restartAndFileIssue', \"&&Create Issue and Restart\"),\n\t\t\t\tsecondaryButton: localize('prof.restart', \"&&Restart\")\n\t\t\t}).then(res => {\n\t\t\t\tif (res.confirmed) {\n\t\t\t\t\tPromise.all<any>([\n\t\t\t\t\t\tthis._nativeHostService.showItemInFolder(URI.joinPath(dir, files[0]).fsPath),\n\t\t\t\t\t\tthis._createPerfIssue(files)\n\t\t\t\t\t]).then(() => {\n\t\t\t\t\t\t// keep window stable until restart is selected\n\t\t\t\t\t\treturn this._dialogService.confirm({\n\t\t\t\t\t\t\ttype: 'info',\n\t\t\t\t\t\t\tmessage: localize('prof.thanks', \"Thanks for helping us.\"),\n\t\t\t\t\t\t\tdetail: localize('prof.detail.restart', \"A final restart is required to continue to use '{0}'. Again, thank you for your contribution.\", this._productService.nameLong),\n\t\t\t\t\t\t\tprimaryButton: localize('prof.restart.button', \"&&Restart\"),\n\t\t\t\t\t\t\tsecondaryButton: undefined\n\t\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\t\t// now we are ready to restart\n\t\t\t\t\t\t\tthis._nativeHostService.relaunch({ removeArgs });\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t} else {\n\t\t\t\t\t// simply restart\n\t\t\t\t\tthis._nativeHostService.relaunch({ removeArgs });\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate async _createPerfIssue(files: string[]): Promise<void> {\n\t\tconst reportIssueUrl = this._productService.reportIssueUrl;\n\t\tif (!reportIssueUrl) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst ref = await this._textModelResolverService.createModelReference(PerfviewInput.Uri);\n\t\ttry {\n\t\t\tawait this._clipboardService.writeText(ref.object.textEditorModel.getValue());\n\t\t} finally {\n\t\t\tref.dispose();\n\t\t}\n\n\t\tconst body = `\n1. :warning: We have copied additional data to your clipboard. Make sure to **paste** here. :warning:\n1. :warning: Make sure to **attach** these files from your *home*-directory: :warning:\\n${files.map(file => `-\\`${file}\\``).join('\\n')}\n`;\n\n\t\tconst baseUrl = reportIssueUrl;\n\t\tconst queryStringPrefix = baseUrl.indexOf('?') === -1 ? '?' : '&';\n\n\t\tthis._openerService.open(URI.parse(`${baseUrl}${queryStringPrefix}body=${encodeURIComponent(body)}`));\n\t}\n}\n"]}