{"version":3,"sources":["vs/workbench/services/lifecycle/browser/lifecycleService.ts"],"names":[],"mappings":"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","file":"lifecycleService.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ShutdownReason, ILifecycleService } from 'vs/workbench/services/lifecycle/common/lifecycle';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { AbstractLifecycleService } from 'vs/workbench/services/lifecycle/common/lifecycleService';\nimport { localize } from 'vs/nls';\nimport { registerSingleton } from 'vs/platform/instantiation/common/extensions';\nimport { IDisposable } from 'vs/base/common/lifecycle';\nimport { addDisposableListener } from 'vs/base/browser/dom';\n\nexport class BrowserLifecycleService extends AbstractLifecycleService {\n\n\tprivate beforeUnloadDisposable: IDisposable | undefined = undefined;\n\tprivate expectedUnload = false;\n\n\tconstructor(\n\t\t@ILogService logService: ILogService\n\t) {\n\t\tsuper(logService);\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\n\t\t// beforeUnload\n\t\tthis.beforeUnloadDisposable = addDisposableListener(window, 'beforeunload', (e: BeforeUnloadEvent) => this.onBeforeUnload(e));\n\t}\n\n\tprivate onBeforeUnload(event: BeforeUnloadEvent): void {\n\t\tif (this.expectedUnload) {\n\t\t\tthis.logService.info('[lifecycle] onBeforeUnload expected, ignoring once');\n\n\t\t\tthis.expectedUnload = false;\n\n\t\t\treturn; // ignore expected unload only once\n\t\t}\n\n\t\tthis.logService.info('[lifecycle] onBeforeUnload triggered');\n\n\t\tthis.doShutdown(() => {\n\n\t\t\t// Veto handling\n\t\t\tevent.preventDefault();\n\t\t\tevent.returnValue = localize('lifecycleVeto', \"Changes that you made may not be saved. Please check press 'Cancel' and try again.\");\n\t\t});\n\t}\n\n\twithExpectedUnload(callback: Function): void {\n\t\tthis.expectedUnload = true;\n\t\ttry {\n\t\t\tcallback();\n\t\t} finally {\n\t\t\tthis.expectedUnload = false;\n\t\t}\n\t}\n\n\tshutdown(): void {\n\t\tthis.logService.info('[lifecycle] shutdown triggered');\n\n\t\t// Remove `beforeunload` listener that would prevent shutdown\n\t\tthis.beforeUnloadDisposable?.dispose();\n\n\t\t// Handle shutdown without veto support\n\t\tthis.doShutdown();\n\t}\n\n\tprivate doShutdown(handleVeto?: () => void): void {\n\t\tconst logService = this.logService;\n\n\t\tlet veto = false;\n\n\t\t// Before Shutdown\n\t\tthis._onBeforeShutdown.fire({\n\t\t\tveto(value, id) {\n\t\t\t\tif (typeof handleVeto === 'function') {\n\t\t\t\t\tif (value instanceof Promise) {\n\t\t\t\t\t\tlogService.error(`[lifecycle] Long running operations before shutdown are unsupported in the web (id: ${id})`);\n\n\t\t\t\t\t\tvalue = true; // implicitly vetos since we cannot handle promises in web\n\t\t\t\t\t}\n\n\t\t\t\t\tif (value === true) {\n\t\t\t\t\t\tlogService.info(`[lifecycle]: Unload was prevented (id: ${id})`);\n\n\t\t\t\t\t\tveto = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\treason: ShutdownReason.QUIT\n\t\t});\n\n\t\t// Veto: handle if provided\n\t\tif (veto && typeof handleVeto === 'function') {\n\t\t\thandleVeto();\n\n\t\t\treturn;\n\t\t}\n\n\t\t// No Veto: continue with willShutdown\n\t\tthis._onWillShutdown.fire({\n\t\t\tjoin(promise, id) {\n\t\t\t\tlogService.error(`[lifecycle] Long running operations during shutdown are unsupported in the web (id: ${id})`);\n\t\t\t},\n\t\t\treason: ShutdownReason.QUIT\n\t\t});\n\n\t\t// Finally end with didShutdown\n\t\tthis._onDidShutdown.fire();\n\t}\n}\n\nregisterSingleton(ILifecycleService, BrowserLifecycleService);\n"]}