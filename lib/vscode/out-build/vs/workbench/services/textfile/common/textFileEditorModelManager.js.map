{"version":3,"sources":["vs/workbench/services/textfile/common/textFileEditorModelManager.ts"],"names":[],"mappings":"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","file":"textFileEditorModelManager.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { localize } from 'vs/nls';\nimport { toErrorMessage } from 'vs/base/common/errorMessage';\nimport { Event, Emitter } from 'vs/base/common/event';\nimport { URI } from 'vs/base/common/uri';\nimport { TextFileEditorModel } from 'vs/workbench/services/textfile/common/textFileEditorModel';\nimport { dispose, IDisposable, Disposable, DisposableStore } from 'vs/base/common/lifecycle';\nimport { ITextFileEditorModel, ITextFileEditorModelManager, ITextFileEditorModelResolveOrCreateOptions, ITextFileResolveEvent, ITextFileSaveEvent, ITextFileSaveParticipant } from 'vs/workbench/services/textfile/common/textfiles';\nimport { ILifecycleService } from 'vs/workbench/services/lifecycle/common/lifecycle';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { ResourceMap } from 'vs/base/common/map';\nimport { IFileService, FileChangesEvent, FileOperation, FileChangeType } from 'vs/platform/files/common/files';\nimport { Promises, ResourceQueue } from 'vs/base/common/async';\nimport { onUnexpectedError } from 'vs/base/common/errors';\nimport { TextFileSaveParticipant } from 'vs/workbench/services/textfile/common/textFileSaveParticipant';\nimport { SaveReason } from 'vs/workbench/common/editor';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { INotificationService } from 'vs/platform/notification/common/notification';\nimport { IWorkingCopyFileService, WorkingCopyFileEvent } from 'vs/workbench/services/workingCopy/common/workingCopyFileService';\nimport { ITextSnapshot } from 'vs/editor/common/model';\nimport { joinPath } from 'vs/base/common/resources';\nimport { createTextBufferFactoryFromSnapshot } from 'vs/editor/common/model/textModel';\nimport { PLAINTEXT_MODE_ID } from 'vs/editor/common/modes/modesRegistry';\nimport { IUriIdentityService } from 'vs/workbench/services/uriIdentity/common/uriIdentity';\n\nexport class TextFileEditorModelManager extends Disposable implements ITextFileEditorModelManager {\n\n\tprivate readonly _onDidCreate = this._register(new Emitter<TextFileEditorModel>());\n\treadonly onDidCreate = this._onDidCreate.event;\n\n\tprivate readonly _onDidResolve = this._register(new Emitter<ITextFileResolveEvent>());\n\treadonly onDidResolve = this._onDidResolve.event;\n\n\tprivate readonly _onDidChangeDirty = this._register(new Emitter<TextFileEditorModel>());\n\treadonly onDidChangeDirty = this._onDidChangeDirty.event;\n\n\tprivate readonly _onDidSaveError = this._register(new Emitter<TextFileEditorModel>());\n\treadonly onDidSaveError = this._onDidSaveError.event;\n\n\tprivate readonly _onDidSave = this._register(new Emitter<ITextFileSaveEvent>());\n\treadonly onDidSave = this._onDidSave.event;\n\n\tprivate readonly _onDidRevert = this._register(new Emitter<TextFileEditorModel>());\n\treadonly onDidRevert = this._onDidRevert.event;\n\n\tprivate readonly _onDidChangeEncoding = this._register(new Emitter<TextFileEditorModel>());\n\treadonly onDidChangeEncoding = this._onDidChangeEncoding.event;\n\n\tprivate readonly mapResourceToModel = new ResourceMap<TextFileEditorModel>();\n\tprivate readonly mapResourceToModelListeners = new ResourceMap<IDisposable>();\n\tprivate readonly mapResourceToDisposeListener = new ResourceMap<IDisposable>();\n\tprivate readonly mapResourceToPendingModelResolvers = new ResourceMap<Promise<void>>();\n\n\tprivate readonly modelResolveQueue = this._register(new ResourceQueue());\n\n\tsaveErrorHandler = (() => {\n\t\tconst notificationService = this.notificationService;\n\n\t\treturn {\n\t\t\tonSaveError(error: Error, model: ITextFileEditorModel): void {\n\t\t\t\tnotificationService.error(localize({ key: 'genericSaveError', comment: ['{0} is the resource that failed to save and {1} the error message'] }, \"Failed to save '{0}': {1}\", model.name, toErrorMessage(error, false)));\n\t\t\t}\n\t\t};\n\t})();\n\n\tget models(): TextFileEditorModel[] {\n\t\treturn [...this.mapResourceToModel.values()];\n\t}\n\n\tconstructor(\n\t\t@ILifecycleService private readonly lifecycleService: ILifecycleService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@INotificationService private readonly notificationService: INotificationService,\n\t\t@IWorkingCopyFileService private readonly workingCopyFileService: IWorkingCopyFileService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService\n\t) {\n\t\tsuper();\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\n\t\t// Update models from file change events\n\t\tthis._register(this.fileService.onDidFilesChange(e => this.onDidFilesChange(e)));\n\n\t\t// Working copy operations\n\t\tthis._register(this.workingCopyFileService.onWillRunWorkingCopyFileOperation(e => this.onWillRunWorkingCopyFileOperation(e)));\n\t\tthis._register(this.workingCopyFileService.onDidFailWorkingCopyFileOperation(e => this.onDidFailWorkingCopyFileOperation(e)));\n\t\tthis._register(this.workingCopyFileService.onDidRunWorkingCopyFileOperation(e => this.onDidRunWorkingCopyFileOperation(e)));\n\n\t\t// Lifecycle\n\t\tthis.lifecycleService.onDidShutdown(() => this.dispose());\n\t}\n\n\tprivate onDidFilesChange(e: FileChangesEvent): void {\n\t\tfor (const model of this.models) {\n\t\t\tif (model.isDirty() || !model.isResolved()) {\n\t\t\t\tcontinue; // require a resolved, saved model to continue\n\t\t\t}\n\n\t\t\t// Trigger a model resolve for any update or add event that impacts\n\t\t\t// the model. We also consider the added event because it could\n\t\t\t// be that a file was added and updated right after.\n\t\t\tif (e.contains(model.resource, FileChangeType.UPDATED, FileChangeType.ADDED)) {\n\t\t\t\tthis.queueModelResolve(model);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate queueModelResolve(model: TextFileEditorModel): void {\n\n\t\t// Resolve model to update (use a queue to prevent accumulation of resolves\n\t\t// when the resolve actually takes long. At most we only want the queue\n\t\t// to have a size of 2 (1 running resolve and 1 queued resolve).\n\t\tconst queue = this.modelResolveQueue.queueFor(model.resource);\n\t\tif (queue.size <= 1) {\n\t\t\tqueue.queue(async () => {\n\t\t\t\ttry {\n\t\t\t\t\tawait model.resolve();\n\t\t\t\t} catch (error) {\n\t\t\t\t\tonUnexpectedError(error);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate readonly mapCorrelationIdToModelsToRestore = new Map<number, { source: URI, target: URI, snapshot?: ITextSnapshot; mode?: string; encoding?: string; }[]>();\n\n\tprivate onWillRunWorkingCopyFileOperation(e: WorkingCopyFileEvent): void {\n\n\t\t// Move / Copy: remember models to restore after the operation\n\t\tif (e.operation === FileOperation.MOVE || e.operation === FileOperation.COPY) {\n\t\t\tconst modelsToRestore: { source: URI, target: URI, snapshot?: ITextSnapshot; mode?: string; encoding?: string; }[] = [];\n\n\t\t\tfor (const { source, target } of e.files) {\n\t\t\t\tif (source) {\n\t\t\t\t\tif (this.uriIdentityService.extUri.isEqual(source, target)) {\n\t\t\t\t\t\tcontinue; // ignore if resources are considered equal\n\t\t\t\t\t}\n\n\t\t\t\t\t// find all models that related to source (can be many if resource is a folder)\n\t\t\t\t\tconst sourceModels: TextFileEditorModel[] = [];\n\t\t\t\t\tfor (const model of this.models) {\n\t\t\t\t\t\tif (this.uriIdentityService.extUri.isEqualOrParent(model.resource, source)) {\n\t\t\t\t\t\t\tsourceModels.push(model);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// remember each source model to resolve again after move is done\n\t\t\t\t\t// with optional content to restore if it was dirty\n\t\t\t\t\tfor (const sourceModel of sourceModels) {\n\t\t\t\t\t\tconst sourceModelResource = sourceModel.resource;\n\n\t\t\t\t\t\t// If the source is the actual model, just use target as new resource\n\t\t\t\t\t\tlet targetModelResource: URI;\n\t\t\t\t\t\tif (this.uriIdentityService.extUri.isEqual(sourceModelResource, source)) {\n\t\t\t\t\t\t\ttargetModelResource = target;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Otherwise a parent folder of the source is being moved, so we need\n\t\t\t\t\t\t// to compute the target resource based on that\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ttargetModelResource = joinPath(target, sourceModelResource.path.substr(source.path.length + 1));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tmodelsToRestore.push({\n\t\t\t\t\t\t\tsource: sourceModelResource,\n\t\t\t\t\t\t\ttarget: targetModelResource,\n\t\t\t\t\t\t\tmode: sourceModel.getMode(),\n\t\t\t\t\t\t\tencoding: sourceModel.getEncoding(),\n\t\t\t\t\t\t\tsnapshot: sourceModel.isDirty() ? sourceModel.createSnapshot() : undefined\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.mapCorrelationIdToModelsToRestore.set(e.correlationId, modelsToRestore);\n\t\t}\n\t}\n\n\tprivate onDidFailWorkingCopyFileOperation(e: WorkingCopyFileEvent): void {\n\n\t\t// Move / Copy: restore dirty flag on models to restore that were dirty\n\t\tif ((e.operation === FileOperation.MOVE || e.operation === FileOperation.COPY)) {\n\t\t\tconst modelsToRestore = this.mapCorrelationIdToModelsToRestore.get(e.correlationId);\n\t\t\tif (modelsToRestore) {\n\t\t\t\tthis.mapCorrelationIdToModelsToRestore.delete(e.correlationId);\n\n\t\t\t\tmodelsToRestore.forEach(model => {\n\t\t\t\t\t// snapshot presence means this model used to be dirty and so we restore that\n\t\t\t\t\t// flag. we do NOT have to restore the content because the model was only soft\n\t\t\t\t\t// reverted and did not loose its original dirty contents.\n\t\t\t\t\tif (model.snapshot) {\n\t\t\t\t\t\tthis.get(model.source)?.setDirty(true);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate onDidRunWorkingCopyFileOperation(e: WorkingCopyFileEvent): void {\n\t\tswitch (e.operation) {\n\n\t\t\t// Create: Revert existing models\n\t\t\tcase FileOperation.CREATE:\n\t\t\t\te.waitUntil((async () => {\n\t\t\t\t\tfor (const { target } of e.files) {\n\t\t\t\t\t\tconst model = this.get(target);\n\t\t\t\t\t\tif (model && !model.isDisposed()) {\n\t\t\t\t\t\t\tawait model.revert();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})());\n\t\t\t\tbreak;\n\n\t\t\t// Move/Copy: restore models that were resolved before the operation took place\n\t\t\tcase FileOperation.MOVE:\n\t\t\tcase FileOperation.COPY:\n\t\t\t\te.waitUntil((async () => {\n\t\t\t\t\tconst modelsToRestore = this.mapCorrelationIdToModelsToRestore.get(e.correlationId);\n\t\t\t\t\tif (modelsToRestore) {\n\t\t\t\t\t\tthis.mapCorrelationIdToModelsToRestore.delete(e.correlationId);\n\n\t\t\t\t\t\tawait Promises.settled(modelsToRestore.map(async modelToRestore => {\n\n\t\t\t\t\t\t\t// restore the model at the target. if we have previous dirty content, we pass it\n\t\t\t\t\t\t\t// over to be used, otherwise we force a reload from disk. this is important\n\t\t\t\t\t\t\t// because we know the file has changed on disk after the move and the model might\n\t\t\t\t\t\t\t// have still existed with the previous state. this ensures that the model is not\n\t\t\t\t\t\t\t// tracking a stale state.\n\t\t\t\t\t\t\tconst restoredModel = await this.resolve(modelToRestore.target, {\n\t\t\t\t\t\t\t\treload: { async: false }, // enforce a reload\n\t\t\t\t\t\t\t\tcontents: modelToRestore.snapshot ? createTextBufferFactoryFromSnapshot(modelToRestore.snapshot) : undefined,\n\t\t\t\t\t\t\t\tencoding: modelToRestore.encoding\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t// restore previous mode only if the mode is now unspecified and it was specified\n\t\t\t\t\t\t\tif (modelToRestore.mode && modelToRestore.mode !== PLAINTEXT_MODE_ID && restoredModel.getMode() === PLAINTEXT_MODE_ID) {\n\t\t\t\t\t\t\t\trestoredModel.updateTextEditorModel(undefined, modelToRestore.mode);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}));\n\t\t\t\t\t}\n\t\t\t\t})());\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tget(resource: URI): TextFileEditorModel | undefined {\n\t\treturn this.mapResourceToModel.get(resource);\n\t}\n\n\tasync resolve(resource: URI, options?: ITextFileEditorModelResolveOrCreateOptions): Promise<TextFileEditorModel> {\n\n\t\t// Await a pending model resolve first before proceeding\n\t\t// to ensure that we never resolve a model more than once\n\t\t// in parallel\n\t\tconst pendingResolve = this.joinPendingResolve(resource);\n\t\tif (pendingResolve) {\n\t\t\tawait pendingResolve;\n\t\t}\n\n\t\tlet modelPromise: Promise<void>;\n\t\tlet model = this.get(resource);\n\t\tlet didCreateModel = false;\n\n\t\t// Model exists\n\t\tif (model) {\n\n\t\t\t// Always reload if contents are provided\n\t\t\tif (options?.contents) {\n\t\t\t\tmodelPromise = model.resolve(options);\n\t\t\t}\n\n\t\t\t// Reload async or sync based on options\n\t\t\telse if (options?.reload) {\n\n\t\t\t\t// async reload: trigger a reload but return immediately\n\t\t\t\tif (options.reload.async) {\n\t\t\t\t\tmodelPromise = Promise.resolve();\n\t\t\t\t\tmodel.resolve(options);\n\t\t\t\t}\n\n\t\t\t\t// sync reload: do not return until model reloaded\n\t\t\t\telse {\n\t\t\t\t\tmodelPromise = model.resolve(options);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Do not reload\n\t\t\telse {\n\t\t\t\tmodelPromise = Promise.resolve();\n\t\t\t}\n\t\t}\n\n\t\t// Model does not exist\n\t\telse {\n\t\t\tdidCreateModel = true;\n\n\t\t\tconst newModel = model = this.instantiationService.createInstance(TextFileEditorModel, resource, options ? options.encoding : undefined, options ? options.mode : undefined);\n\t\t\tmodelPromise = model.resolve(options);\n\n\t\t\tthis.registerModel(newModel);\n\t\t}\n\n\t\t// Store pending resolves to avoid race conditions\n\t\tthis.mapResourceToPendingModelResolvers.set(resource, modelPromise);\n\n\t\t// Make known to manager (if not already known)\n\t\tthis.add(resource, model);\n\n\t\t// Emit some events if we created the model\n\t\tif (didCreateModel) {\n\t\t\tthis._onDidCreate.fire(model);\n\n\t\t\t// If the model is dirty right from the beginning,\n\t\t\t// make sure to emit this as an event\n\t\t\tif (model.isDirty()) {\n\t\t\t\tthis._onDidChangeDirty.fire(model);\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tawait modelPromise;\n\n\t\t\t// Remove from pending resolves\n\t\t\tthis.mapResourceToPendingModelResolvers.delete(resource);\n\n\t\t\t// Apply mode if provided\n\t\t\tif (options?.mode) {\n\t\t\t\tmodel.setMode(options.mode);\n\t\t\t}\n\n\t\t\t// Model can be dirty if a backup was restored, so we make sure to\n\t\t\t// have this event delivered if we created the model here\n\t\t\tif (didCreateModel && model.isDirty()) {\n\t\t\t\tthis._onDidChangeDirty.fire(model);\n\t\t\t}\n\n\t\t\treturn model;\n\t\t} catch (error) {\n\n\t\t\t// Free resources of this invalid model\n\t\t\tif (model) {\n\t\t\t\tmodel.dispose();\n\t\t\t}\n\n\t\t\t// Remove from pending resolves\n\t\t\tthis.mapResourceToPendingModelResolvers.delete(resource);\n\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate joinPendingResolve(resource: URI): Promise<void> | undefined {\n\t\tconst pendingModelResolve = this.mapResourceToPendingModelResolvers.get(resource);\n\t\tif (pendingModelResolve) {\n\t\t\treturn pendingModelResolve.then(undefined, error => {/* ignore any error here, it will bubble to the original requestor*/ });\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate registerModel(model: TextFileEditorModel): void {\n\n\t\t// Install model listeners\n\t\tconst modelListeners = new DisposableStore();\n\t\tmodelListeners.add(model.onDidResolve(reason => this._onDidResolve.fire({ model, reason })));\n\t\tmodelListeners.add(model.onDidChangeDirty(() => this._onDidChangeDirty.fire(model)));\n\t\tmodelListeners.add(model.onDidSaveError(() => this._onDidSaveError.fire(model)));\n\t\tmodelListeners.add(model.onDidSave(reason => this._onDidSave.fire({ model, reason })));\n\t\tmodelListeners.add(model.onDidRevert(() => this._onDidRevert.fire(model)));\n\t\tmodelListeners.add(model.onDidChangeEncoding(() => this._onDidChangeEncoding.fire(model)));\n\n\t\t// Keep for disposal\n\t\tthis.mapResourceToModelListeners.set(model.resource, modelListeners);\n\t}\n\n\tprotected add(resource: URI, model: TextFileEditorModel): void {\n\t\tconst knownModel = this.mapResourceToModel.get(resource);\n\t\tif (knownModel === model) {\n\t\t\treturn; // already cached\n\t\t}\n\n\t\t// dispose any previously stored dispose listener for this resource\n\t\tconst disposeListener = this.mapResourceToDisposeListener.get(resource);\n\t\tif (disposeListener) {\n\t\t\tdisposeListener.dispose();\n\t\t}\n\n\t\t// store in cache but remove when model gets disposed\n\t\tthis.mapResourceToModel.set(resource, model);\n\t\tthis.mapResourceToDisposeListener.set(resource, model.onWillDispose(() => this.remove(resource)));\n\t}\n\n\tprotected remove(resource: URI): void {\n\t\tthis.mapResourceToModel.delete(resource);\n\n\t\tconst disposeListener = this.mapResourceToDisposeListener.get(resource);\n\t\tif (disposeListener) {\n\t\t\tdispose(disposeListener);\n\t\t\tthis.mapResourceToDisposeListener.delete(resource);\n\t\t}\n\n\t\tconst modelListener = this.mapResourceToModelListeners.get(resource);\n\t\tif (modelListener) {\n\t\t\tdispose(modelListener);\n\t\t\tthis.mapResourceToModelListeners.delete(resource);\n\t\t}\n\t}\n\n\t//#region Save participants\n\n\tprivate readonly saveParticipants = this._register(this.instantiationService.createInstance(TextFileSaveParticipant));\n\n\taddSaveParticipant(participant: ITextFileSaveParticipant): IDisposable {\n\t\treturn this.saveParticipants.addSaveParticipant(participant);\n\t}\n\n\trunSaveParticipants(model: ITextFileEditorModel, context: { reason: SaveReason; }, token: CancellationToken): Promise<void> {\n\t\treturn this.saveParticipants.participate(model, context, token);\n\t}\n\n\t//#endregion\n\n\tclear(): void {\n\n\t\t// model caches\n\t\tthis.mapResourceToModel.clear();\n\t\tthis.mapResourceToPendingModelResolvers.clear();\n\n\t\t// dispose the dispose listeners\n\t\tthis.mapResourceToDisposeListener.forEach(listener => listener.dispose());\n\t\tthis.mapResourceToDisposeListener.clear();\n\n\t\t// dispose the model change listeners\n\t\tthis.mapResourceToModelListeners.forEach(listener => listener.dispose());\n\t\tthis.mapResourceToModelListeners.clear();\n\t}\n\n\tcanDispose(model: TextFileEditorModel): true | Promise<true> {\n\n\t\t// quick return if model already disposed or not dirty and not resolving\n\t\tif (\n\t\t\tmodel.isDisposed() ||\n\t\t\t(!this.mapResourceToPendingModelResolvers.has(model.resource) && !model.isDirty())\n\t\t) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// promise based return in all other cases\n\t\treturn this.doCanDispose(model);\n\t}\n\n\tprivate async doCanDispose(model: TextFileEditorModel): Promise<true> {\n\n\t\t// if we have a pending model resolve, await it first and then try again\n\t\tconst pendingResolve = this.joinPendingResolve(model.resource);\n\t\tif (pendingResolve) {\n\t\t\tawait pendingResolve;\n\n\t\t\treturn this.canDispose(model);\n\t\t}\n\n\t\t// dirty model: we do not allow to dispose dirty models to prevent\n\t\t// data loss cases. dirty models can only be disposed when they are\n\t\t// either saved or reverted\n\t\tif (model.isDirty()) {\n\t\t\tawait Event.toPromise(model.onDidChangeDirty);\n\n\t\t\treturn this.canDispose(model);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\toverride dispose(): void {\n\t\tsuper.dispose();\n\n\t\tthis.clear();\n\t}\n}\n"]}