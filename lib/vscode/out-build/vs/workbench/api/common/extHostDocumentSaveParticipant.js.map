{"version":3,"file":"extHostDocumentSaveParticipant.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/workbench/api/common/extHostDocumentSaveParticipant.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;IAiBhG,MAAa,8BAA8B;QAK1C,YACkB,WAAwB,EACxB,UAA4B,EAC5B,oBAA8C,EAC9C,cAAoD,EAAE,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,EAAE;YAHhF,gBAAW,GAAX,WAAW,CAAa;YACxB,eAAU,GAAV,UAAU,CAAkB;YAC5B,yBAAoB,GAApB,oBAAoB,CAA0B;YAC9C,gBAAW,GAAX,WAAW,CAAqE;YAPjF,eAAU,GAAG,IAAI,uBAAU,EAAY,CAAC;YACxC,kBAAa,GAAG,IAAI,OAAO,EAAoB,CAAC;YAQhE,EAAE;QACH,CAAC;QAED,OAAO;YACN,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,CAAC;QACzB,CAAC;QAED,8BAA8B,CAAC,SAAgC;YAC9D,OAAO,CAAC,QAAQ,EAAE,OAAO,EAAE,WAAW,EAAE,EAAE;gBACzC,MAAM,MAAM,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC;gBACpE,MAAM,MAAM,GAAG,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC;gBACnC,IAAI,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE;oBAC/B,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;iBACzB;gBACD,OAAO,MAAM,CAAC;YACf,CAAC,CAAC;QACH,CAAC;QAED,KAAK,CAAC,kBAAkB,CAAC,IAAmB,EAAE,MAAkB;YAC/D,MAAM,QAAQ,GAAG,SAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YAElC,IAAI,UAAU,GAAG,KAAK,CAAC;YACvB,MAAM,gBAAgB,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,UAAU,GAAG,IAAI,EAAE,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;YAEvF,MAAM,OAAO,GAAc,EAAE,CAAC;YAC9B,IAAI;gBACH,KAAK,IAAI,QAAQ,IAAI,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,EAAE,EAAE,2CAA2C;oBACvF,IAAI,UAAU,EAAE;wBACf,8BAA8B;wBAC9B,MAAM;qBACN;oBACD,MAAM,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;oBACvD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,sCAAsC,CAAC,QAAQ,EAAO,EAAE,QAAQ,EAAE,MAAM,EAAE,8CAAsB,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;oBAC1I,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;iBACtB;aACD;oBAAS;gBACT,YAAY,CAAC,gBAAgB,CAAC,CAAC;aAC/B;YACD,OAAO,OAAO,CAAC;QAChB,CAAC;QAEO,sCAAsC,CAAC,CAAC,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAW,EAAE,SAA2C;YACnI,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAChD,IAAI,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE;gBACnE,wBAAwB;gBACxB,OAAO,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;aAC9B;YAED,OAAO,IAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE;gBACjF,oCAAoC;gBACpC,OAAO,IAAI,CAAC;YAEb,CAAC,EAAE,GAAG,CAAC,EAAE;gBAER,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,mDAAmD,SAAS,CAAC,UAAU,CAAC,KAAK,eAAe,CAAC,CAAC;gBACrH,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAE5B,IAAI,CAAC,CAAC,GAAG,YAAY,KAAK,CAAC,IAAY,GAAI,CAAC,OAAO,KAAK,kBAAkB,EAAE;oBAC3E,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;oBAChD,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;oBAE3D,IAAI,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE;wBACnE,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,mDAAmD,SAAS,CAAC,UAAU,CAAC,KAAK,yDAAyD,CAAC,CAAC;qBAC9J;iBACD;gBACD,OAAO,KAAK,CAAC;YACd,CAAC,CAAC,CAAC;QACJ,CAAC;QAEO,kBAAkB,CAAC,SAAgC,EAAE,QAAkB,EAAE,OAAY,EAAE,SAA2C;YAEzI,MAAM,QAAQ,GAAiC,EAAE,CAAC;YAElD,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACtB,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,SAAS,CAAC;YACvC,MAAM,EAAE,OAAO,EAAE,GAAG,QAAQ,CAAC;YAE7B,MAAM,KAAK,GAAG,MAAM,CAAC,MAAM,CAAmC;gBAC7D,QAAQ;gBACR,MAAM;gBACN,SAAS,CAAC,CAAmC;oBAC5C,IAAI,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE;wBAC9B,MAAM,CAAA,GAAA,qBAAY,CAAA,CAAC,mCAAmC,CAAC,CAAC;qBACxD;oBACD,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;gBACnC,CAAC;aACD,CAAC,CAAC;YAEH,IAAI;gBACH,aAAa;gBACb,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC;aACjC;YAAC,OAAO,GAAG,EAAE;gBACb,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;aAC3B;YAED,mCAAmC;YACnC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YAExB,OAAO,IAAI,OAAO,CAAsB,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;gBAC3D,sDAAsD;gBACtD,MAAM,MAAM,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,SAAS,CAAC,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;gBAExF,OAAO,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;oBACzC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,mDAAmD,SAAS,CAAC,UAAU,CAAC,KAAK,oBAAoB,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,CAAC;oBAC/I,YAAY,CAAC,MAAM,CAAC,CAAC;oBACrB,OAAO,CAAC,KAAK,CAAC,CAAC;gBAChB,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE;oBACd,YAAY,CAAC,MAAM,CAAC,CAAC;oBACrB,MAAM,CAAC,GAAG,CAAC,CAAC;gBACb,CAAC,CAAC,CAAC;YAEJ,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;gBAChB,MAAM,GAAG,GAAsB,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC;gBAC7C,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE;oBAC3B,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,IAAwB,KAAM,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,YAAY,uBAAQ,CAAC,EAAE;wBACzF,KAAK,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,KAAK,EAAE;4BAC/C,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC;gCACd,KAAK,cAAwB;gCAC7B,QAAQ,EAAE,QAAQ,CAAC,GAAG;gCACtB,IAAI,EAAE;oCACL,KAAK,EAAE,KAAK,IAAI,6BAAK,CAAC,IAAI,CAAC,KAAK,CAAC;oCACjC,IAAI,EAAE,OAAO;oCACb,GAAG,EAAE,MAAM,IAAI,iCAAS,CAAC,IAAI,CAAC,MAAM,CAAC;iCACrC;6BACD,CAAC,CAAC;yBACH;qBACD;iBACD;gBAED,qCAAqC;gBACrC,wCAAwC;gBACxC,IAAI,GAAG,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;oBAC3B,OAAO,SAAS,CAAC;iBACjB;gBAED,IAAI,OAAO,KAAK,QAAQ,CAAC,OAAO,EAAE;oBACjC,OAAO,IAAI,CAAC,oBAAoB,CAAC,sBAAsB,CAAC,GAAG,CAAC,CAAC;iBAC7D;gBAED,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC,CAAC;YACtD,CAAC,CAAC,CAAC;QACJ,CAAC;KACD;IAzJD,wEAyJC","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from 'vs/base/common/event';\nimport { URI, UriComponents } from 'vs/base/common/uri';\nimport { illegalState } from 'vs/base/common/errors';\nimport { ExtHostDocumentSaveParticipantShape, IWorkspaceEditDto, WorkspaceEditType, MainThreadBulkEditsShape } from 'vs/workbench/api/common/extHost.protocol';\nimport { TextEdit } from 'vs/workbench/api/common/extHostTypes';\nimport { Range, TextDocumentSaveReason, EndOfLine } from 'vs/workbench/api/common/extHostTypeConverters';\nimport { ExtHostDocuments } from 'vs/workbench/api/common/extHostDocuments';\nimport { SaveReason } from 'vs/workbench/common/editor';\nimport type * as vscode from 'vscode';\nimport { LinkedList } from 'vs/base/common/linkedList';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { IExtensionDescription } from 'vs/platform/extensions/common/extensions';\n\ntype Listener = [Function, any, IExtensionDescription];\n\nexport class ExtHostDocumentSaveParticipant implements ExtHostDocumentSaveParticipantShape {\n\n\tprivate readonly _callbacks = new LinkedList<Listener>();\n\tprivate readonly _badListeners = new WeakMap<Function, number>();\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _documents: ExtHostDocuments,\n\t\tprivate readonly _mainThreadBulkEdits: MainThreadBulkEditsShape,\n\t\tprivate readonly _thresholds: { timeout: number; errors: number; } = { timeout: 1500, errors: 3 }\n\t) {\n\t\t//\n\t}\n\n\tdispose(): void {\n\t\tthis._callbacks.clear();\n\t}\n\n\tgetOnWillSaveTextDocumentEvent(extension: IExtensionDescription): Event<vscode.TextDocumentWillSaveEvent> {\n\t\treturn (listener, thisArg, disposables) => {\n\t\t\tconst remove = this._callbacks.push([listener, thisArg, extension]);\n\t\t\tconst result = { dispose: remove };\n\t\t\tif (Array.isArray(disposables)) {\n\t\t\t\tdisposables.push(result);\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t}\n\n\tasync $participateInSave(data: UriComponents, reason: SaveReason): Promise<boolean[]> {\n\t\tconst resource = URI.revive(data);\n\n\t\tlet didTimeout = false;\n\t\tconst didTimeoutHandle = setTimeout(() => didTimeout = true, this._thresholds.timeout);\n\n\t\tconst results: boolean[] = [];\n\t\ttry {\n\t\t\tfor (let listener of [...this._callbacks]) { // copy to prevent concurrent modifications\n\t\t\t\tif (didTimeout) {\n\t\t\t\t\t// timeout - no more listeners\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tconst document = this._documents.getDocument(resource);\n\t\t\t\tconst success = await this._deliverEventAsyncAndBlameBadListeners(listener, <any>{ document, reason: TextDocumentSaveReason.to(reason) });\n\t\t\t\tresults.push(success);\n\t\t\t}\n\t\t} finally {\n\t\t\tclearTimeout(didTimeoutHandle);\n\t\t}\n\t\treturn results;\n\t}\n\n\tprivate _deliverEventAsyncAndBlameBadListeners([listener, thisArg, extension]: Listener, stubEvent: vscode.TextDocumentWillSaveEvent): Promise<any> {\n\t\tconst errors = this._badListeners.get(listener);\n\t\tif (typeof errors === 'number' && errors > this._thresholds.errors) {\n\t\t\t// bad listener - ignore\n\t\t\treturn Promise.resolve(false);\n\t\t}\n\n\t\treturn this._deliverEventAsync(extension, listener, thisArg, stubEvent).then(() => {\n\t\t\t// don't send result across the wire\n\t\t\treturn true;\n\n\t\t}, err => {\n\n\t\t\tthis._logService.error(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' threw ERROR`);\n\t\t\tthis._logService.error(err);\n\n\t\t\tif (!(err instanceof Error) || (<Error>err).message !== 'concurrent_edits') {\n\t\t\t\tconst errors = this._badListeners.get(listener);\n\t\t\t\tthis._badListeners.set(listener, !errors ? 1 : errors + 1);\n\n\t\t\t\tif (typeof errors === 'number' && errors > this._thresholds.errors) {\n\t\t\t\t\tthis._logService.info(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' will now be IGNORED because of timeouts and/or errors`);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tprivate _deliverEventAsync(extension: IExtensionDescription, listener: Function, thisArg: any, stubEvent: vscode.TextDocumentWillSaveEvent): Promise<any> {\n\n\t\tconst promises: Promise<vscode.TextEdit[]>[] = [];\n\n\t\tconst t1 = Date.now();\n\t\tconst { document, reason } = stubEvent;\n\t\tconst { version } = document;\n\n\t\tconst event = Object.freeze(<vscode.TextDocumentWillSaveEvent>{\n\t\t\tdocument,\n\t\t\treason,\n\t\t\twaitUntil(p: Promise<any | vscode.TextEdit[]>) {\n\t\t\t\tif (Object.isFrozen(promises)) {\n\t\t\t\t\tthrow illegalState('waitUntil can not be called async');\n\t\t\t\t}\n\t\t\t\tpromises.push(Promise.resolve(p));\n\t\t\t}\n\t\t});\n\n\t\ttry {\n\t\t\t// fire event\n\t\t\tlistener.apply(thisArg, [event]);\n\t\t} catch (err) {\n\t\t\treturn Promise.reject(err);\n\t\t}\n\n\t\t// freeze promises after event call\n\t\tObject.freeze(promises);\n\n\t\treturn new Promise<vscode.TextEdit[][]>((resolve, reject) => {\n\t\t\t// join on all listener promises, reject after timeout\n\t\t\tconst handle = setTimeout(() => reject(new Error('timeout')), this._thresholds.timeout);\n\n\t\t\treturn Promise.all(promises).then(edits => {\n\t\t\t\tthis._logService.debug(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' finished after ${(Date.now() - t1)}ms`);\n\t\t\t\tclearTimeout(handle);\n\t\t\t\tresolve(edits);\n\t\t\t}).catch(err => {\n\t\t\t\tclearTimeout(handle);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t}).then(values => {\n\t\t\tconst dto: IWorkspaceEditDto = { edits: [] };\n\t\t\tfor (const value of values) {\n\t\t\t\tif (Array.isArray(value) && (<vscode.TextEdit[]>value).every(e => e instanceof TextEdit)) {\n\t\t\t\t\tfor (const { newText, newEol, range } of value) {\n\t\t\t\t\t\tdto.edits.push({\n\t\t\t\t\t\t\t_type: WorkspaceEditType.Text,\n\t\t\t\t\t\t\tresource: document.uri,\n\t\t\t\t\t\t\tedit: {\n\t\t\t\t\t\t\t\trange: range && Range.from(range),\n\t\t\t\t\t\t\t\ttext: newText,\n\t\t\t\t\t\t\t\teol: newEol && EndOfLine.from(newEol)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// apply edits if any and if document\n\t\t\t// didn't change somehow in the meantime\n\t\t\tif (dto.edits.length === 0) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (version === document.version) {\n\t\t\t\treturn this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(dto);\n\t\t\t}\n\n\t\t\treturn Promise.reject(new Error('concurrent_edits'));\n\t\t});\n\t}\n}\n"]}