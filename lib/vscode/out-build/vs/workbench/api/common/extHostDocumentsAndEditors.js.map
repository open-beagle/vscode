{"version":3,"file":"extHostDocumentsAndEditors.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/workbench/api/common/extHostDocumentsAndEditors.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from 'vs/base/common/assert';\nimport * as vscode from 'vscode';\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { dispose } from 'vs/base/common/lifecycle';\nimport { URI } from 'vs/base/common/uri';\nimport { createDecorator } from 'vs/platform/instantiation/common/instantiation';\nimport { ExtHostDocumentsAndEditorsShape, IDocumentsAndEditorsDelta, IModelAddedData, MainContext } from 'vs/workbench/api/common/extHost.protocol';\nimport { ExtHostDocumentData } from 'vs/workbench/api/common/extHostDocumentData';\nimport { IExtHostRpcService } from 'vs/workbench/api/common/extHostRpcService';\nimport { ExtHostTextEditor } from 'vs/workbench/api/common/extHostTextEditor';\nimport * as typeConverters from 'vs/workbench/api/common/extHostTypeConverters';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { ResourceMap } from 'vs/base/common/map';\nimport { Schemas } from 'vs/base/common/network';\nimport { Iterable } from 'vs/base/common/iterator';\nimport { Lazy } from 'vs/base/common/lazy';\n\nclass Reference<T> {\n\tprivate _count = 0;\n\tconstructor(readonly value: T) { }\n\tref() {\n\t\tthis._count++;\n\t}\n\tunref() {\n\t\treturn --this._count === 0;\n\t}\n}\n\nexport interface IExtHostModelAddedData extends IModelAddedData {\n\tnotebook?: vscode.NotebookDocument;\n}\n\nexport interface IExtHostDocumentsAndEditorsDelta extends IDocumentsAndEditorsDelta {\n\taddedDocuments?: IExtHostModelAddedData[];\n}\n\nexport class ExtHostDocumentsAndEditors implements ExtHostDocumentsAndEditorsShape {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate _activeEditorId: string | null = null;\n\n\tprivate readonly _editors = new Map<string, ExtHostTextEditor>();\n\tprivate readonly _documents = new ResourceMap<Reference<ExtHostDocumentData>>();\n\n\tprivate readonly _onDidAddDocuments = new Emitter<ExtHostDocumentData[]>();\n\tprivate readonly _onDidRemoveDocuments = new Emitter<ExtHostDocumentData[]>();\n\tprivate readonly _onDidChangeVisibleTextEditors = new Emitter<vscode.TextEditor[]>();\n\tprivate readonly _onDidChangeActiveTextEditor = new Emitter<vscode.TextEditor | undefined>();\n\n\treadonly onDidAddDocuments: Event<ExtHostDocumentData[]> = this._onDidAddDocuments.event;\n\treadonly onDidRemoveDocuments: Event<ExtHostDocumentData[]> = this._onDidRemoveDocuments.event;\n\treadonly onDidChangeVisibleTextEditors: Event<vscode.TextEditor[]> = this._onDidChangeVisibleTextEditors.event;\n\treadonly onDidChangeActiveTextEditor: Event<vscode.TextEditor | undefined> = this._onDidChangeActiveTextEditor.event;\n\n\tconstructor(\n\t\t@IExtHostRpcService private readonly _extHostRpc: IExtHostRpcService,\n\t\t@ILogService private readonly _logService: ILogService\n\t) { }\n\n\t$acceptDocumentsAndEditorsDelta(delta: IDocumentsAndEditorsDelta): void {\n\t\tthis.acceptDocumentsAndEditorsDelta(delta);\n\t}\n\n\tacceptDocumentsAndEditorsDelta(delta: IExtHostDocumentsAndEditorsDelta): void {\n\n\t\tconst removedDocuments: ExtHostDocumentData[] = [];\n\t\tconst addedDocuments: ExtHostDocumentData[] = [];\n\t\tconst removedEditors: ExtHostTextEditor[] = [];\n\n\t\tif (delta.removedDocuments) {\n\t\t\tfor (const uriComponent of delta.removedDocuments) {\n\t\t\t\tconst uri = URI.revive(uriComponent);\n\t\t\t\tconst data = this._documents.get(uri);\n\t\t\t\tif (data?.unref()) {\n\t\t\t\t\tthis._documents.delete(uri);\n\t\t\t\t\tremovedDocuments.push(data.value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (delta.addedDocuments) {\n\t\t\tfor (const data of delta.addedDocuments) {\n\t\t\t\tconst resource = URI.revive(data.uri);\n\t\t\t\tlet ref = this._documents.get(resource);\n\n\t\t\t\t// double check -> only notebook cell documents should be\n\t\t\t\t// referenced/opened more than once...\n\t\t\t\tif (ref) {\n\t\t\t\t\tif (resource.scheme !== Schemas.vscodeNotebookCell) {\n\t\t\t\t\t\tthrow new Error(`document '${resource} already exists!'`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!ref) {\n\t\t\t\t\tref = new Reference(new ExtHostDocumentData(\n\t\t\t\t\t\tthis._extHostRpc.getProxy(MainContext.MainThreadDocuments),\n\t\t\t\t\t\tresource,\n\t\t\t\t\t\tdata.lines,\n\t\t\t\t\t\tdata.EOL,\n\t\t\t\t\t\tdata.versionId,\n\t\t\t\t\t\tdata.modeId,\n\t\t\t\t\t\tdata.isDirty,\n\t\t\t\t\t\tdata.notebook\n\t\t\t\t\t));\n\t\t\t\t\tthis._documents.set(resource, ref);\n\t\t\t\t\taddedDocuments.push(ref.value);\n\t\t\t\t}\n\n\t\t\t\tref.ref();\n\t\t\t}\n\t\t}\n\n\t\tif (delta.removedEditors) {\n\t\t\tfor (const id of delta.removedEditors) {\n\t\t\t\tconst editor = this._editors.get(id);\n\t\t\t\tthis._editors.delete(id);\n\t\t\t\tif (editor) {\n\t\t\t\t\tremovedEditors.push(editor);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (delta.addedEditors) {\n\t\t\tfor (const data of delta.addedEditors) {\n\t\t\t\tconst resource = URI.revive(data.documentUri);\n\t\t\t\tassert.ok(this._documents.has(resource), `document '${resource}' does not exist`);\n\t\t\t\tassert.ok(!this._editors.has(data.id), `editor '${data.id}' already exists!`);\n\n\t\t\t\tconst documentData = this._documents.get(resource)!.value;\n\t\t\t\tconst editor = new ExtHostTextEditor(\n\t\t\t\t\tdata.id,\n\t\t\t\t\tthis._extHostRpc.getProxy(MainContext.MainThreadTextEditors),\n\t\t\t\t\tthis._logService,\n\t\t\t\t\tnew Lazy(() => documentData.document),\n\t\t\t\t\tdata.selections.map(typeConverters.Selection.to),\n\t\t\t\t\tdata.options,\n\t\t\t\t\tdata.visibleRanges.map(range => typeConverters.Range.to(range)),\n\t\t\t\t\ttypeof data.editorPosition === 'number' ? typeConverters.ViewColumn.to(data.editorPosition) : undefined\n\t\t\t\t);\n\t\t\t\tthis._editors.set(data.id, editor);\n\t\t\t}\n\t\t}\n\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\tassert.ok(delta.newActiveEditor === null || this._editors.has(delta.newActiveEditor), `active editor '${delta.newActiveEditor}' does not exist`);\n\t\t\tthis._activeEditorId = delta.newActiveEditor;\n\t\t}\n\n\t\tdispose(removedDocuments);\n\t\tdispose(removedEditors);\n\n\t\t// now that the internal state is complete, fire events\n\t\tif (delta.removedDocuments) {\n\t\t\tthis._onDidRemoveDocuments.fire(removedDocuments);\n\t\t}\n\t\tif (delta.addedDocuments) {\n\t\t\tthis._onDidAddDocuments.fire(addedDocuments);\n\t\t}\n\n\t\tif (delta.removedEditors || delta.addedEditors) {\n\t\t\tthis._onDidChangeVisibleTextEditors.fire(this.allEditors().map(editor => editor.value));\n\t\t}\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\tthis._onDidChangeActiveTextEditor.fire(this.activeEditor());\n\t\t}\n\t}\n\n\tgetDocument(uri: URI): ExtHostDocumentData | undefined {\n\t\treturn this._documents.get(uri)?.value;\n\t}\n\n\tallDocuments(): Iterable<ExtHostDocumentData> {\n\t\treturn Iterable.map(this._documents.values(), ref => ref.value);\n\t}\n\n\tgetEditor(id: string): ExtHostTextEditor | undefined {\n\t\treturn this._editors.get(id);\n\t}\n\n\tactiveEditor(): vscode.TextEditor | undefined;\n\tactiveEditor(internal: true): ExtHostTextEditor | undefined;\n\tactiveEditor(internal?: true): vscode.TextEditor | ExtHostTextEditor | undefined {\n\t\tif (!this._activeEditorId) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst editor = this._editors.get(this._activeEditorId);\n\t\tif (internal) {\n\t\t\treturn editor;\n\t\t} else {\n\t\t\treturn editor?.value;\n\t\t}\n\t}\n\n\tallEditors(): ExtHostTextEditor[] {\n\t\treturn [...this._editors.values()];\n\t}\n}\n\nexport interface IExtHostDocumentsAndEditors extends ExtHostDocumentsAndEditors { }\nexport const IExtHostDocumentsAndEditors = createDecorator<IExtHostDocumentsAndEditors>('IExtHostDocumentsAndEditors');\n"]}