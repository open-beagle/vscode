{"version":3,"file":"markerService.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/platform/markers/common/markerService.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;IAWhG,MAAM,iBAAiB;QAAvB;YAES,gBAAW,GAAG,IAAI,iBAAW,EAAkB,CAAC;YAChD,aAAQ,GAAG,IAAI,GAAG,EAA0B,CAAC;QAkDtD,CAAC;QAhDA,GAAG,CAAC,QAAa,EAAE,KAAa,EAAE,KAAQ;YACzC,IAAI,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAI,CAAC,QAAQ,EAAE;gBACd,QAAQ,GAAG,IAAI,GAAG,EAAE,CAAC;gBACrB,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;aACzC;YACD,QAAQ,CAAC,GAAG,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;YAE3B,IAAI,WAAW,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAC3C,IAAI,CAAC,WAAW,EAAE;gBACjB,WAAW,GAAG,IAAI,iBAAW,EAAE,CAAC;gBAChC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;aACtC;YACD,WAAW,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;QAClC,CAAC;QAED,GAAG,CAAC,QAAa,EAAE,KAAa;YAC/B,IAAI,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,OAAO,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,GAAG,CAAC,KAAK,CAAC,CAAC;QAC7B,CAAC;QAED,MAAM,CAAC,QAAa,EAAE,KAAa;YAClC,IAAI,QAAQ,GAAG,KAAK,CAAC;YACrB,IAAI,QAAQ,GAAG,KAAK,CAAC;YACrB,IAAI,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC9C,IAAI,QAAQ,EAAE;gBACb,QAAQ,GAAG,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;aAClC;YACD,IAAI,WAAW,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAC3C,IAAI,WAAW,EAAE;gBAChB,QAAQ,GAAG,WAAW,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;aACxC;YACD,IAAI,QAAQ,KAAK,QAAQ,EAAE;gBAC1B,MAAM,IAAI,KAAK,CAAC,eAAe,CAAC,CAAC;aACjC;YACD,OAAO,QAAQ,IAAI,QAAQ,CAAC;QAC7B,CAAC;QAED,MAAM,CAAC,GAAkB;;YACxB,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE;gBAC5B,OAAO,MAAA,MAAA,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,CAAC,0CAAE,MAAM,EAAE,mCAAI,mBAAQ,CAAC,KAAK,EAAE,CAAC;aAC5D;YACD,IAAI,SAAG,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE;gBACnB,OAAO,MAAA,MAAA,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,0CAAE,MAAM,EAAE,mCAAI,mBAAQ,CAAC,KAAK,EAAE,CAAC;aAC/D;YAED,OAAO,mBAAQ,CAAC,GAAG,CAAC,mBAAQ,CAAC,MAAM,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,EAAE,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QAChF,CAAC;KACD;IAED,MAAM,WAAW;QAWhB,YAAY,OAAuB;YATnC,WAAM,GAAW,CAAC,CAAC;YACnB,UAAK,GAAW,CAAC,CAAC;YAClB,aAAQ,GAAW,CAAC,CAAC;YACrB,aAAQ,GAAW,CAAC,CAAC;YAEJ,UAAK,GAAG,IAAI,iBAAW,EAAoB,CAAC;YAK5D,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;YACxB,IAAI,CAAC,aAAa,GAAG,OAAO,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QAClE,CAAC;QAED,OAAO;YACN,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC;QAC9B,CAAC;QAEO,OAAO,CAAC,SAAyB;YACxC,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE;gBACjC,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;gBAC1C,IAAI,QAAQ,EAAE;oBACb,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;iBAC1B;gBACD,MAAM,QAAQ,GAAG,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;gBAC/C,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBACpB,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;aACnC;QACF,CAAC;QAEO,cAAc,CAAC,QAAa;YACnC,MAAM,MAAM,GAAqB,EAAE,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,CAAC;YAEnF,sBAAsB;YACtB,IAAI,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,QAAQ,IAAI,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,WAAW,IAAI,QAAQ,CAAC,MAAM,KAAK,iBAAO,CAAC,kBAAkB,EAAE;gBACtI,OAAO,MAAM,CAAC;aACd;YAED,KAAK,MAAM,EAAE,QAAQ,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;gBAC5D,IAAI,QAAQ,KAAK,wBAAc,CAAC,KAAK,EAAE;oBACtC,MAAM,CAAC,MAAM,IAAI,CAAC,CAAC;iBACnB;qBAAM,IAAI,QAAQ,KAAK,wBAAc,CAAC,OAAO,EAAE;oBAC/C,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAC;iBACrB;qBAAM,IAAI,QAAQ,KAAK,wBAAc,CAAC,IAAI,EAAE;oBAC5C,MAAM,CAAC,KAAK,IAAI,CAAC,CAAC;iBAClB;qBAAM;oBACN,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAC;iBACrB;aACD;YAED,OAAO,MAAM,CAAC;QACf,CAAC;QAEO,UAAU,CAAC,EAAoB;YACtC,IAAI,CAAC,MAAM,IAAI,EAAE,CAAC,MAAM,CAAC;YACzB,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC,QAAQ,CAAC;YAC7B,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC,KAAK,CAAC;YACvB,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC,QAAQ,CAAC;QAC9B,CAAC;QAEO,IAAI,CAAC,EAAoB;YAChC,IAAI,CAAC,MAAM,IAAI,EAAE,CAAC,MAAM,CAAC;YACzB,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC,QAAQ,CAAC;YAC7B,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC,KAAK,CAAC;YACvB,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC,QAAQ,CAAC;QAC9B,CAAC;KACD;IAED,MAAa,aAAa;QAA1B;YAIkB,qBAAgB,GAAG,IAAI,eAAO,EAAkB,CAAC;YACzD,oBAAe,GAA0B,aAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,aAAa,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;YAE1G,UAAK,GAAG,IAAI,iBAAiB,EAAa,CAAC;YAC3C,WAAM,GAAG,IAAI,WAAW,CAAC,IAAI,CAAC,CAAC;QAyMjD,CAAC;QAvMA,OAAO;YACN,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;YACtB,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,CAAC;QACjC,CAAC;QAED,aAAa;YACZ,OAAO,IAAI,CAAC,MAAM,CAAC;QACpB,CAAC;QAED,MAAM,CAAC,KAAa,EAAE,SAAgB;YACrC,KAAK,MAAM,QAAQ,IAAI,SAAS,IAAI,EAAE,EAAE;gBACvC,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE,EAAE,CAAC,CAAC;aACpC;QACF,CAAC;QAED,SAAS,CAAC,KAAa,EAAE,QAAa,EAAE,UAAyB;YAEhE,IAAI,CAAA,GAAA,uBAAc,CAAA,CAAC,UAAU,CAAC,EAAE;gBAC/B,gDAAgD;gBAChD,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;gBACnD,IAAI,OAAO,EAAE;oBACZ,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;iBACvC;aAED;iBAAM;gBACN,gDAAgD;gBAChD,MAAM,OAAO,GAAc,EAAE,CAAC;gBAC9B,KAAK,MAAM,IAAI,IAAI,UAAU,EAAE;oBAC9B,MAAM,MAAM,GAAG,aAAa,CAAC,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE,IAAI,CAAC,CAAC;oBAC9D,IAAI,MAAM,EAAE;wBACX,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;qBACrB;iBACD;gBACD,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;gBACzC,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;aACvC;QACF,CAAC;QAEO,MAAM,CAAC,SAAS,CAAC,KAAa,EAAE,QAAa,EAAE,IAAiB;YACvE,IAAI,EACH,IAAI,EAAE,QAAQ,EACd,OAAO,EAAE,MAAM,EACf,eAAe,EAAE,WAAW,EAAE,aAAa,EAAE,SAAS,EACtD,kBAAkB,EAClB,IAAI,GACJ,GAAG,IAAI,CAAC;YAET,IAAI,CAAC,OAAO,EAAE;gBACb,OAAO,SAAS,CAAC;aACjB;YAED,eAAe;YACf,eAAe,GAAG,eAAe,GAAG,CAAC,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;YAC5D,WAAW,GAAG,WAAW,GAAG,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;YAChD,aAAa,GAAG,aAAa,IAAI,eAAe,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,eAAe,CAAC;YACnF,SAAS,GAAG,SAAS,GAAG,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,WAAW,CAAC;YAEpD,OAAO;gBACN,QAAQ;gBACR,KAAK;gBACL,IAAI;gBACJ,QAAQ;gBACR,OAAO;gBACP,MAAM;gBACN,eAAe;gBACf,WAAW;gBACX,aAAa;gBACb,SAAS;gBACT,kBAAkB;gBAClB,IAAI;aACJ,CAAC;QACH,CAAC;QAED,SAAS,CAAC,KAAa,EAAE,IAAuB;YAC/C,MAAM,OAAO,GAAU,EAAE,CAAC;YAE1B,oBAAoB;YACpB,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YAC1C,IAAI,QAAQ,EAAE;gBACb,KAAK,IAAI,IAAI,IAAI,QAAQ,EAAE;oBAC1B,MAAM,KAAK,GAAG,mBAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;oBACnC,IAAI,KAAK,EAAE;wBACV,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;wBAC7B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;qBACzC;iBACD;aACD;YAED,kBAAkB;YAClB,IAAI,CAAA,GAAA,wBAAe,CAAA,CAAC,IAAI,CAAC,EAAE;gBAE1B,oBAAoB;gBACpB,MAAM,MAAM,GAAG,IAAI,iBAAW,EAAa,CAAC;gBAC5C,KAAK,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,UAAU,EAAE,IAAI,IAAI,EAAE;oBACpD,MAAM,MAAM,GAAG,aAAa,CAAC,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE,UAAU,CAAC,CAAC;oBACpE,IAAI,CAAC,MAAM,EAAE;wBACZ,qBAAqB;wBACrB,SAAS;qBACT;oBACD,MAAM,KAAK,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;oBACnC,IAAI,CAAC,KAAK,EAAE;wBACX,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC;wBAC/B,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;qBACvB;yBAAM;wBACN,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;qBACnB;iBACD;gBAED,aAAa;gBACb,KAAK,MAAM,CAAC,QAAQ,EAAE,KAAK,CAAC,IAAI,MAAM,EAAE;oBACvC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;iBACvC;aACD;YAED,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE;gBACvB,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;aACpC;QACF,CAAC;QAED,IAAI,CAAC,SAAkF,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;YAEzG,IAAI,EAAE,KAAK,EAAE,QAAQ,EAAE,UAAU,EAAE,IAAI,EAAE,GAAG,MAAM,CAAC;YAEnD,IAAI,CAAC,IAAI,IAAI,IAAI,GAAG,CAAC,EAAE;gBACtB,IAAI,GAAG,CAAC,CAAC,CAAC;aACV;YAED,IAAI,KAAK,IAAI,QAAQ,EAAE;gBACtB,iCAAiC;gBACjC,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;gBAC7C,IAAI,CAAC,IAAI,EAAE;oBACV,OAAO,EAAE,CAAC;iBACV;qBAAM;oBACN,MAAM,MAAM,GAAc,EAAE,CAAC;oBAC7B,KAAK,MAAM,MAAM,IAAI,IAAI,EAAE;wBAC1B,IAAI,aAAa,CAAC,OAAO,CAAC,MAAM,EAAE,UAAU,CAAC,EAAE;4BAC9C,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;4BACnC,IAAI,IAAI,GAAG,CAAC,IAAI,MAAM,KAAK,IAAI,EAAE;gCAChC,MAAM;6BACN;yBACD;qBACD;oBACD,OAAO,MAAM,CAAC;iBACd;aAED;iBAAM,IAAI,CAAC,KAAK,IAAI,CAAC,QAAQ,EAAE;gBAC/B,MAAM;gBACN,MAAM,MAAM,GAAc,EAAE,CAAC;gBAC7B,KAAK,IAAI,OAAO,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,EAAE;oBACxC,KAAK,IAAI,IAAI,IAAI,OAAO,EAAE;wBACzB,IAAI,aAAa,CAAC,OAAO,CAAC,IAAI,EAAE,UAAU,CAAC,EAAE;4BAC5C,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;4BACjC,IAAI,IAAI,GAAG,CAAC,IAAI,MAAM,KAAK,IAAI,EAAE;gCAChC,OAAO,MAAM,CAAC;6BACd;yBACD;qBACD;iBACD;gBACD,OAAO,MAAM,CAAC;aAEd;iBAAM;gBACN,2BAA2B;gBAC3B,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,QAAQ,aAAR,QAAQ,cAAR,QAAQ,GAAI,KAAM,CAAC,CAAC;gBACvD,MAAM,MAAM,GAAc,EAAE,CAAC;gBAC7B,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE;oBAC/B,KAAK,MAAM,IAAI,IAAI,OAAO,EAAE;wBAC3B,IAAI,aAAa,CAAC,OAAO,CAAC,IAAI,EAAE,UAAU,CAAC,EAAE;4BAC5C,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;4BACjC,IAAI,IAAI,GAAG,CAAC,IAAI,MAAM,KAAK,IAAI,EAAE;gCAChC,OAAO,MAAM,CAAC;6BACd;yBACD;qBACD;iBACD;gBACD,OAAO,MAAM,CAAC;aACd;QACF,CAAC;QAEO,MAAM,CAAC,OAAO,CAAC,MAAe,EAAE,UAAmB;YAC1D,OAAO,UAAU,KAAK,SAAS,IAAI,CAAC,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,KAAK,MAAM,CAAC,QAAQ,CAAC;QACvF,CAAC;QAMO,MAAM,CAAC,UAAU,CAAC,IAAuB,EAAE,KAAqB;YACvE,IAAI,CAAC,IAAI,EAAE;gBACV,aAAa,CAAC,UAAU,GAAG,IAAI,iBAAW,EAAE,CAAC;gBAC7C,IAAI,GAAG,EAAE,CAAC;aACV;YACD,KAAK,MAAM,GAAG,IAAI,KAAK,EAAE;gBACxB,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE;oBACvC,aAAa,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;oBACxC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;iBACf;aACD;YACD,OAAO,IAAI,CAAC;QACb,CAAC;KACD;IAjND,sCAiNC","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { isFalsyOrEmpty, isNonEmptyArray } from 'vs/base/common/arrays';\nimport { Schemas } from 'vs/base/common/network';\nimport { IDisposable } from 'vs/base/common/lifecycle';\nimport { URI } from 'vs/base/common/uri';\nimport { Event, Emitter } from 'vs/base/common/event';\nimport { IMarkerService, IMarkerData, IResourceMarker, IMarker, MarkerStatistics, MarkerSeverity } from './markers';\nimport { ResourceMap } from 'vs/base/common/map';\nimport { Iterable } from 'vs/base/common/iterator';\n\nclass DoubleResourceMap<V>{\n\n\tprivate _byResource = new ResourceMap<Map<string, V>>();\n\tprivate _byOwner = new Map<string, ResourceMap<V>>();\n\n\tset(resource: URI, owner: string, value: V) {\n\t\tlet ownerMap = this._byResource.get(resource);\n\t\tif (!ownerMap) {\n\t\t\townerMap = new Map();\n\t\t\tthis._byResource.set(resource, ownerMap);\n\t\t}\n\t\townerMap.set(owner, value);\n\n\t\tlet resourceMap = this._byOwner.get(owner);\n\t\tif (!resourceMap) {\n\t\t\tresourceMap = new ResourceMap();\n\t\t\tthis._byOwner.set(owner, resourceMap);\n\t\t}\n\t\tresourceMap.set(resource, value);\n\t}\n\n\tget(resource: URI, owner: string): V | undefined {\n\t\tlet ownerMap = this._byResource.get(resource);\n\t\treturn ownerMap?.get(owner);\n\t}\n\n\tdelete(resource: URI, owner: string): boolean {\n\t\tlet removedA = false;\n\t\tlet removedB = false;\n\t\tlet ownerMap = this._byResource.get(resource);\n\t\tif (ownerMap) {\n\t\t\tremovedA = ownerMap.delete(owner);\n\t\t}\n\t\tlet resourceMap = this._byOwner.get(owner);\n\t\tif (resourceMap) {\n\t\t\tremovedB = resourceMap.delete(resource);\n\t\t}\n\t\tif (removedA !== removedB) {\n\t\t\tthrow new Error('illegal state');\n\t\t}\n\t\treturn removedA && removedB;\n\t}\n\n\tvalues(key?: URI | string): Iterable<V> {\n\t\tif (typeof key === 'string') {\n\t\t\treturn this._byOwner.get(key)?.values() ?? Iterable.empty();\n\t\t}\n\t\tif (URI.isUri(key)) {\n\t\t\treturn this._byResource.get(key)?.values() ?? Iterable.empty();\n\t\t}\n\n\t\treturn Iterable.map(Iterable.concat(...this._byOwner.values()), map => map[1]);\n\t}\n}\n\nclass MarkerStats implements MarkerStatistics {\n\n\terrors: number = 0;\n\tinfos: number = 0;\n\twarnings: number = 0;\n\tunknowns: number = 0;\n\n\tprivate readonly _data = new ResourceMap<MarkerStatistics>();\n\tprivate readonly _service: IMarkerService;\n\tprivate readonly _subscription: IDisposable;\n\n\tconstructor(service: IMarkerService) {\n\t\tthis._service = service;\n\t\tthis._subscription = service.onMarkerChanged(this._update, this);\n\t}\n\n\tdispose(): void {\n\t\tthis._subscription.dispose();\n\t}\n\n\tprivate _update(resources: readonly URI[]): void {\n\t\tfor (const resource of resources) {\n\t\t\tconst oldStats = this._data.get(resource);\n\t\t\tif (oldStats) {\n\t\t\t\tthis._substract(oldStats);\n\t\t\t}\n\t\t\tconst newStats = this._resourceStats(resource);\n\t\t\tthis._add(newStats);\n\t\t\tthis._data.set(resource, newStats);\n\t\t}\n\t}\n\n\tprivate _resourceStats(resource: URI): MarkerStatistics {\n\t\tconst result: MarkerStatistics = { errors: 0, warnings: 0, infos: 0, unknowns: 0 };\n\n\t\t// TODO this is a hack\n\t\tif (resource.scheme === Schemas.inMemory || resource.scheme === Schemas.walkThrough || resource.scheme === Schemas.walkThroughSnippet) {\n\t\t\treturn result;\n\t\t}\n\n\t\tfor (const { severity } of this._service.read({ resource })) {\n\t\t\tif (severity === MarkerSeverity.Error) {\n\t\t\t\tresult.errors += 1;\n\t\t\t} else if (severity === MarkerSeverity.Warning) {\n\t\t\t\tresult.warnings += 1;\n\t\t\t} else if (severity === MarkerSeverity.Info) {\n\t\t\t\tresult.infos += 1;\n\t\t\t} else {\n\t\t\t\tresult.unknowns += 1;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate _substract(op: MarkerStatistics) {\n\t\tthis.errors -= op.errors;\n\t\tthis.warnings -= op.warnings;\n\t\tthis.infos -= op.infos;\n\t\tthis.unknowns -= op.unknowns;\n\t}\n\n\tprivate _add(op: MarkerStatistics) {\n\t\tthis.errors += op.errors;\n\t\tthis.warnings += op.warnings;\n\t\tthis.infos += op.infos;\n\t\tthis.unknowns += op.unknowns;\n\t}\n}\n\nexport class MarkerService implements IMarkerService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _onMarkerChanged = new Emitter<readonly URI[]>();\n\treadonly onMarkerChanged: Event<readonly URI[]> = Event.debounce(this._onMarkerChanged.event, MarkerService._debouncer, 0);\n\n\tprivate readonly _data = new DoubleResourceMap<IMarker[]>();\n\tprivate readonly _stats = new MarkerStats(this);\n\n\tdispose(): void {\n\t\tthis._stats.dispose();\n\t\tthis._onMarkerChanged.dispose();\n\t}\n\n\tgetStatistics(): MarkerStatistics {\n\t\treturn this._stats;\n\t}\n\n\tremove(owner: string, resources: URI[]): void {\n\t\tfor (const resource of resources || []) {\n\t\t\tthis.changeOne(owner, resource, []);\n\t\t}\n\t}\n\n\tchangeOne(owner: string, resource: URI, markerData: IMarkerData[]): void {\n\n\t\tif (isFalsyOrEmpty(markerData)) {\n\t\t\t// remove marker for this (owner,resource)-tuple\n\t\t\tconst removed = this._data.delete(resource, owner);\n\t\t\tif (removed) {\n\t\t\t\tthis._onMarkerChanged.fire([resource]);\n\t\t\t}\n\n\t\t} else {\n\t\t\t// insert marker for this (owner,resource)-tuple\n\t\t\tconst markers: IMarker[] = [];\n\t\t\tfor (const data of markerData) {\n\t\t\t\tconst marker = MarkerService._toMarker(owner, resource, data);\n\t\t\t\tif (marker) {\n\t\t\t\t\tmarkers.push(marker);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._data.set(resource, owner, markers);\n\t\t\tthis._onMarkerChanged.fire([resource]);\n\t\t}\n\t}\n\n\tprivate static _toMarker(owner: string, resource: URI, data: IMarkerData): IMarker | undefined {\n\t\tlet {\n\t\t\tcode, severity,\n\t\t\tmessage, source,\n\t\t\tstartLineNumber, startColumn, endLineNumber, endColumn,\n\t\t\trelatedInformation,\n\t\t\ttags,\n\t\t} = data;\n\n\t\tif (!message) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// santize data\n\t\tstartLineNumber = startLineNumber > 0 ? startLineNumber : 1;\n\t\tstartColumn = startColumn > 0 ? startColumn : 1;\n\t\tendLineNumber = endLineNumber >= startLineNumber ? endLineNumber : startLineNumber;\n\t\tendColumn = endColumn > 0 ? endColumn : startColumn;\n\n\t\treturn {\n\t\t\tresource,\n\t\t\towner,\n\t\t\tcode,\n\t\t\tseverity,\n\t\t\tmessage,\n\t\t\tsource,\n\t\t\tstartLineNumber,\n\t\t\tstartColumn,\n\t\t\tendLineNumber,\n\t\t\tendColumn,\n\t\t\trelatedInformation,\n\t\t\ttags,\n\t\t};\n\t}\n\n\tchangeAll(owner: string, data: IResourceMarker[]): void {\n\t\tconst changes: URI[] = [];\n\n\t\t// remove old marker\n\t\tconst existing = this._data.values(owner);\n\t\tif (existing) {\n\t\t\tfor (let data of existing) {\n\t\t\t\tconst first = Iterable.first(data);\n\t\t\t\tif (first) {\n\t\t\t\t\tchanges.push(first.resource);\n\t\t\t\t\tthis._data.delete(first.resource, owner);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// add new markers\n\t\tif (isNonEmptyArray(data)) {\n\n\t\t\t// group by resource\n\t\t\tconst groups = new ResourceMap<IMarker[]>();\n\t\t\tfor (const { resource, marker: markerData } of data) {\n\t\t\t\tconst marker = MarkerService._toMarker(owner, resource, markerData);\n\t\t\t\tif (!marker) {\n\t\t\t\t\t// filter bad markers\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst array = groups.get(resource);\n\t\t\t\tif (!array) {\n\t\t\t\t\tgroups.set(resource, [marker]);\n\t\t\t\t\tchanges.push(resource);\n\t\t\t\t} else {\n\t\t\t\t\tarray.push(marker);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// insert all\n\t\t\tfor (const [resource, value] of groups) {\n\t\t\t\tthis._data.set(resource, owner, value);\n\t\t\t}\n\t\t}\n\n\t\tif (changes.length > 0) {\n\t\t\tthis._onMarkerChanged.fire(changes);\n\t\t}\n\t}\n\n\tread(filter: { owner?: string; resource?: URI; severities?: number, take?: number; } = Object.create(null)): IMarker[] {\n\n\t\tlet { owner, resource, severities, take } = filter;\n\n\t\tif (!take || take < 0) {\n\t\t\ttake = -1;\n\t\t}\n\n\t\tif (owner && resource) {\n\t\t\t// exactly one owner AND resource\n\t\t\tconst data = this._data.get(resource, owner);\n\t\t\tif (!data) {\n\t\t\t\treturn [];\n\t\t\t} else {\n\t\t\t\tconst result: IMarker[] = [];\n\t\t\t\tfor (const marker of data) {\n\t\t\t\t\tif (MarkerService._accept(marker, severities)) {\n\t\t\t\t\t\tconst newLen = result.push(marker);\n\t\t\t\t\t\tif (take > 0 && newLen === take) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t} else if (!owner && !resource) {\n\t\t\t// all\n\t\t\tconst result: IMarker[] = [];\n\t\t\tfor (let markers of this._data.values()) {\n\t\t\t\tfor (let data of markers) {\n\t\t\t\t\tif (MarkerService._accept(data, severities)) {\n\t\t\t\t\t\tconst newLen = result.push(data);\n\t\t\t\t\t\tif (take > 0 && newLen === take) {\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn result;\n\n\t\t} else {\n\t\t\t// of one resource OR owner\n\t\t\tconst iterable = this._data.values(resource ?? owner!);\n\t\t\tconst result: IMarker[] = [];\n\t\t\tfor (const markers of iterable) {\n\t\t\t\tfor (const data of markers) {\n\t\t\t\t\tif (MarkerService._accept(data, severities)) {\n\t\t\t\t\t\tconst newLen = result.push(data);\n\t\t\t\t\t\tif (take > 0 && newLen === take) {\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t}\n\n\tprivate static _accept(marker: IMarker, severities?: number): boolean {\n\t\treturn severities === undefined || (severities & marker.severity) === marker.severity;\n\t}\n\n\t// --- event debounce logic\n\n\tprivate static _dedupeMap: ResourceMap<true>;\n\n\tprivate static _debouncer(last: URI[] | undefined, event: readonly URI[]): URI[] {\n\t\tif (!last) {\n\t\t\tMarkerService._dedupeMap = new ResourceMap();\n\t\t\tlast = [];\n\t\t}\n\t\tfor (const uri of event) {\n\t\t\tif (!MarkerService._dedupeMap.has(uri)) {\n\t\t\t\tMarkerService._dedupeMap.set(uri, true);\n\t\t\t\tlast.push(uri);\n\t\t\t}\n\t\t}\n\t\treturn last;\n\t}\n}\n"]}