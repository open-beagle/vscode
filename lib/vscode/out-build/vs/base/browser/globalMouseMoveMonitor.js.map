{"version":3,"file":"globalMouseMoveMonitor.js","sourceRoot":"file:///go/src/gitlab.wodcloud.com/cloud/vscode/lib/vscode/src","sources":["vs/base/browser/globalMouseMoveMonitor.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;IA0BhG,SAAgB,uBAAuB,CAAC,SAA6C,EAAE,YAAwB;QAC9G,IAAI,EAAE,GAAG,IAAI,+BAAkB,CAAC,YAAY,CAAC,CAAC;QAC9C,EAAE,CAAC,cAAc,EAAE,CAAC;QACpB,OAAO;YACN,UAAU,EAAE,EAAE,CAAC,UAAU;YACzB,OAAO,EAAE,EAAE,CAAC,OAAO;YACnB,IAAI,EAAE,EAAE,CAAC,IAAI;YACb,IAAI,EAAE,EAAE,CAAC,IAAI;SACb,CAAC;IACH,CAAC;IATD,0DASC;IAED,MAAa,sBAAsB;QAAnC;YAEkB,WAAM,GAAG,IAAI,2BAAe,EAAE,CAAC;YACxC,0BAAqB,GAA2B,IAAI,CAAC;YACrD,uBAAkB,GAAiC,IAAI,CAAC;YACxD,oBAAe,GAA2B,IAAI,CAAC;QA4FxD,CAAC;QA1FO,OAAO;YACb,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;YAC3B,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;QACvB,CAAC;QAEM,cAAc,CAAC,kBAA2B,EAAE,YAAyC;YAC3F,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,EAAE;gBACzB,iBAAiB;gBACjB,OAAO;aACP;YAED,SAAS;YACT,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;YACpB,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC;YAClC,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;YAC/B,MAAM,cAAc,GAAG,IAAI,CAAC,eAAe,CAAC;YAC5C,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAE5B,IAAI,kBAAkB,IAAI,cAAc,EAAE;gBACzC,cAAc,CAAC,YAAY,CAAC,CAAC;aAC7B;QACF,CAAC;QAEM,YAAY;YAClB,OAAO,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC;QACrC,CAAC;QAEM,eAAe,CACrB,cAA2B,EAC3B,cAAsB,EACtB,oBAAqC,EACrC,iBAAwC,EACxC,cAA+B;YAE/B,IAAI,IAAI,CAAC,YAAY,EAAE,EAAE;gBACxB,sBAAsB;gBACtB,OAAO;aACP;YACD,IAAI,CAAC,qBAAqB,GAAG,oBAAoB,CAAC;YAClD,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;YAC5C,IAAI,CAAC,eAAe,GAAG,cAAc,CAAC;YAEtC,MAAM,WAAW,GAAG,oBAAW,CAAC,wBAAwB,EAAE,CAAC;YAC3D,MAAM,SAAS,GAAG,WAAW,CAAC;YAC9B,MAAM,OAAO,GAAG,SAAS,CAAC;YAE1B,MAAM,QAAQ,GAA8B,WAAW,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;YAChG,MAAM,UAAU,GAAG,GAAG,CAAC,aAAa,CAAC,cAAc,CAAC,CAAC;YACrD,IAAI,UAAU,EAAE;gBACf,QAAQ,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;aAC7B;YAED,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE;gBAC/B,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,8BAA8B,CAAC,OAAO,EAAE,SAAS,EACpE,CAAC,IAAO,EAAE,EAAE;oBACX,IAAI,IAAI,CAAC,OAAO,KAAK,cAAc,EAAE;wBACpC,4CAA4C;wBAC5C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;wBAC1B,OAAO;qBACP;oBACD,IAAI,CAAC,kBAAmB,CAAC,IAAI,CAAC,CAAC;gBAChC,CAAC,EACD,CAAC,SAAmB,EAAE,YAAY,EAAE,EAAE,CAAC,IAAI,CAAC,qBAAsB,CAAC,SAAS,EAAE,YAA0B,CAAC,CACzG,CAAC,CAAC;gBACH,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,qBAAqB,CAAC,OAAO,EAAE,OAAO,EAAE,CAAC,CAAa,EAAE,EAAE,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;aAC3G;YAED,IAAI,oBAAW,CAAC,0BAA0B,EAAE,EAAE;gBAC7C,IAAI,sBAAsB,GAAG,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;gBACjE,4DAA4D;gBAC5D,yBAAyB;gBACzB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,qBAAqB,CAAC,sBAAsB,CAAC,MAAM,CAAC,QAAQ,EAAE,UAAU,EAAE,CAAC,YAAwB,EAAE,EAAE;oBAC1H,IAAI,CAAC,GAAG,IAAI,+BAAkB,CAAC,YAAY,CAAC,CAAC;oBAC7C,IAAI,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,WAAW,EAAE,KAAK,MAAM,EAAE;wBAC9C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;qBAC1B;gBACF,CAAC,CAAC,CAAC,CAAC;gBACJ,qBAAqB;gBACrB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,qBAAqB,CAAC,sBAAsB,CAAC,MAAM,CAAC,QAAQ,EAAE,WAAW,EAAE,CAAC,YAAwB,EAAE,EAAE;oBAC3H,IAAI,CAAC,GAAG,IAAI,+BAAkB,CAAC,YAAY,CAAC,CAAC;oBAC7C,IAAI,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,WAAW,EAAE,KAAK,MAAM,EAAE;wBAC9C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;qBAC1B;gBACF,CAAC,CAAC,CAAC,CAAC;gBACJ,qBAAqB;gBACrB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,qBAAqB,CAAC,sBAAsB,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,EAAE,YAAY,EAAE,CAAC,YAAwB,EAAE,EAAE;oBACjI,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;gBAC3B,CAAC,CAAC,CAAC,CAAC;aACJ;QACF,CAAC;KACD;IAjGD,wDAiGC","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from 'vs/base/browser/dom';\nimport { IframeUtils } from 'vs/base/browser/iframe';\nimport { StandardMouseEvent } from 'vs/base/browser/mouseEvent';\nimport { IDisposable, DisposableStore } from 'vs/base/common/lifecycle';\n\nexport interface IStandardMouseMoveEventData {\n\tleftButton: boolean;\n\tbuttons: number;\n\tposx: number;\n\tposy: number;\n}\n\nexport interface IEventMerger<R> {\n\t(lastEvent: R | null, currentEvent: MouseEvent): R;\n}\n\nexport interface IMouseMoveCallback<R> {\n\t(mouseMoveData: R): void;\n}\n\nexport interface IOnStopCallback {\n\t(browserEvent?: MouseEvent | KeyboardEvent): void;\n}\n\nexport function standardMouseMoveMerger(lastEvent: IStandardMouseMoveEventData | null, currentEvent: MouseEvent): IStandardMouseMoveEventData {\n\tlet ev = new StandardMouseEvent(currentEvent);\n\tev.preventDefault();\n\treturn {\n\t\tleftButton: ev.leftButton,\n\t\tbuttons: ev.buttons,\n\t\tposx: ev.posx,\n\t\tposy: ev.posy\n\t};\n}\n\nexport class GlobalMouseMoveMonitor<R extends { buttons: number; }> implements IDisposable {\n\n\tprivate readonly _hooks = new DisposableStore();\n\tprivate _mouseMoveEventMerger: IEventMerger<R> | null = null;\n\tprivate _mouseMoveCallback: IMouseMoveCallback<R> | null = null;\n\tprivate _onStopCallback: IOnStopCallback | null = null;\n\n\tpublic dispose(): void {\n\t\tthis.stopMonitoring(false);\n\t\tthis._hooks.dispose();\n\t}\n\n\tpublic stopMonitoring(invokeStopCallback: boolean, browserEvent?: MouseEvent | KeyboardEvent): void {\n\t\tif (!this.isMonitoring()) {\n\t\t\t// Not monitoring\n\t\t\treturn;\n\t\t}\n\n\t\t// Unhook\n\t\tthis._hooks.clear();\n\t\tthis._mouseMoveEventMerger = null;\n\t\tthis._mouseMoveCallback = null;\n\t\tconst onStopCallback = this._onStopCallback;\n\t\tthis._onStopCallback = null;\n\n\t\tif (invokeStopCallback && onStopCallback) {\n\t\t\tonStopCallback(browserEvent);\n\t\t}\n\t}\n\n\tpublic isMonitoring(): boolean {\n\t\treturn !!this._mouseMoveEventMerger;\n\t}\n\n\tpublic startMonitoring(\n\t\tinitialElement: HTMLElement,\n\t\tinitialButtons: number,\n\t\tmouseMoveEventMerger: IEventMerger<R>,\n\t\tmouseMoveCallback: IMouseMoveCallback<R>,\n\t\tonStopCallback: IOnStopCallback\n\t): void {\n\t\tif (this.isMonitoring()) {\n\t\t\t// I am already hooked\n\t\t\treturn;\n\t\t}\n\t\tthis._mouseMoveEventMerger = mouseMoveEventMerger;\n\t\tthis._mouseMoveCallback = mouseMoveCallback;\n\t\tthis._onStopCallback = onStopCallback;\n\n\t\tconst windowChain = IframeUtils.getSameOriginWindowChain();\n\t\tconst mouseMove = 'mousemove';\n\t\tconst mouseUp = 'mouseup';\n\n\t\tconst listenTo: (Document | ShadowRoot)[] = windowChain.map(element => element.window.document);\n\t\tconst shadowRoot = dom.getShadowRoot(initialElement);\n\t\tif (shadowRoot) {\n\t\t\tlistenTo.unshift(shadowRoot);\n\t\t}\n\n\t\tfor (const element of listenTo) {\n\t\t\tthis._hooks.add(dom.addDisposableThrottledListener(element, mouseMove,\n\t\t\t\t(data: R) => {\n\t\t\t\t\tif (data.buttons !== initialButtons) {\n\t\t\t\t\t\t// Buttons state has changed in the meantime\n\t\t\t\t\t\tthis.stopMonitoring(true);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tthis._mouseMoveCallback!(data);\n\t\t\t\t},\n\t\t\t\t(lastEvent: R | null, currentEvent) => this._mouseMoveEventMerger!(lastEvent, currentEvent as MouseEvent)\n\t\t\t));\n\t\t\tthis._hooks.add(dom.addDisposableListener(element, mouseUp, (e: MouseEvent) => this.stopMonitoring(true)));\n\t\t}\n\n\t\tif (IframeUtils.hasDifferentOriginAncestor()) {\n\t\t\tlet lastSameOriginAncestor = windowChain[windowChain.length - 1];\n\t\t\t// We might miss a mouse up if it happens outside the iframe\n\t\t\t// This one is for Chrome\n\t\t\tthis._hooks.add(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseout', (browserEvent: MouseEvent) => {\n\t\t\t\tlet e = new StandardMouseEvent(browserEvent);\n\t\t\t\tif (e.target.tagName.toLowerCase() === 'html') {\n\t\t\t\t\tthis.stopMonitoring(true);\n\t\t\t\t}\n\t\t\t}));\n\t\t\t// This one is for FF\n\t\t\tthis._hooks.add(dom.addDisposableListener(lastSameOriginAncestor.window.document, 'mouseover', (browserEvent: MouseEvent) => {\n\t\t\t\tlet e = new StandardMouseEvent(browserEvent);\n\t\t\t\tif (e.target.tagName.toLowerCase() === 'html') {\n\t\t\t\t\tthis.stopMonitoring(true);\n\t\t\t\t}\n\t\t\t}));\n\t\t\t// This one is for IE\n\t\t\tthis._hooks.add(dom.addDisposableListener(lastSameOriginAncestor.window.document.body, 'mouseleave', (browserEvent: MouseEvent) => {\n\t\t\t\tthis.stopMonitoring(true);\n\t\t\t}));\n\t\t}\n\t}\n}\n"]}